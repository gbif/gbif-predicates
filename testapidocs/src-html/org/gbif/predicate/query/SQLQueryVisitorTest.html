<!DOCTYPE HTML>
<html lang="en">
<head>
<title>Source code</title>
<link rel="stylesheet" type="text/css" href="../../../../../stylesheet.css" title="Style">
</head>
<body>
<main role="main">
<div class="sourceContainer">
<pre><span class="sourceLineNo">001</span><a id="line.1">/*</a>
<span class="sourceLineNo">002</span><a id="line.2"> * Licensed under the Apache License, Version 2.0 (the "License");</a>
<span class="sourceLineNo">003</span><a id="line.3"> * you may not use this file except in compliance with the License.</a>
<span class="sourceLineNo">004</span><a id="line.4"> * You may obtain a copy of the License at</a>
<span class="sourceLineNo">005</span><a id="line.5"> *</a>
<span class="sourceLineNo">006</span><a id="line.6"> *     http://www.apache.org/licenses/LICENSE-2.0</a>
<span class="sourceLineNo">007</span><a id="line.7"> *</a>
<span class="sourceLineNo">008</span><a id="line.8"> * Unless required by applicable law or agreed to in writing, software</a>
<span class="sourceLineNo">009</span><a id="line.9"> * distributed under the License is distributed on an "AS IS" BASIS,</a>
<span class="sourceLineNo">010</span><a id="line.10"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</a>
<span class="sourceLineNo">011</span><a id="line.11"> * See the License for the specific language governing permissions and</a>
<span class="sourceLineNo">012</span><a id="line.12"> * limitations under the License.</a>
<span class="sourceLineNo">013</span><a id="line.13"> */</a>
<span class="sourceLineNo">014</span><a id="line.14">package org.gbif.predicate.query;</a>
<span class="sourceLineNo">015</span><a id="line.15"></a>
<span class="sourceLineNo">016</span><a id="line.16">import static org.junit.jupiter.api.Assertions.assertEquals;</a>
<span class="sourceLineNo">017</span><a id="line.17">import static org.junit.jupiter.api.Assertions.fail;</a>
<span class="sourceLineNo">018</span><a id="line.18"></a>
<span class="sourceLineNo">019</span><a id="line.19">import com.google.common.collect.Lists;</a>
<span class="sourceLineNo">020</span><a id="line.20">import java.time.Instant;</a>
<span class="sourceLineNo">021</span><a id="line.21">import java.util.Arrays;</a>
<span class="sourceLineNo">022</span><a id="line.22">import java.util.Date;</a>
<span class="sourceLineNo">023</span><a id="line.23">import java.util.List;</a>
<span class="sourceLineNo">024</span><a id="line.24">import java.util.Optional;</a>
<span class="sourceLineNo">025</span><a id="line.25">import java.util.UUID;</a>
<span class="sourceLineNo">026</span><a id="line.26">import org.gbif.api.exception.QueryBuildingException;</a>
<span class="sourceLineNo">027</span><a id="line.27">import org.gbif.api.model.occurrence.search.OccurrenceSearchParameter;</a>
<span class="sourceLineNo">028</span><a id="line.28">import org.gbif.api.model.predicate.ConjunctionPredicate;</a>
<span class="sourceLineNo">029</span><a id="line.29">import org.gbif.api.model.predicate.DisjunctionPredicate;</a>
<span class="sourceLineNo">030</span><a id="line.30">import org.gbif.api.model.predicate.EqualsPredicate;</a>
<span class="sourceLineNo">031</span><a id="line.31">import org.gbif.api.model.predicate.GeoDistancePredicate;</a>
<span class="sourceLineNo">032</span><a id="line.32">import org.gbif.api.model.predicate.GreaterThanOrEqualsPredicate;</a>
<span class="sourceLineNo">033</span><a id="line.33">import org.gbif.api.model.predicate.GreaterThanPredicate;</a>
<span class="sourceLineNo">034</span><a id="line.34">import org.gbif.api.model.predicate.InPredicate;</a>
<span class="sourceLineNo">035</span><a id="line.35">import org.gbif.api.model.predicate.IsNotNullPredicate;</a>
<span class="sourceLineNo">036</span><a id="line.36">import org.gbif.api.model.predicate.IsNullPredicate;</a>
<span class="sourceLineNo">037</span><a id="line.37">import org.gbif.api.model.predicate.LessThanOrEqualsPredicate;</a>
<span class="sourceLineNo">038</span><a id="line.38">import org.gbif.api.model.predicate.LessThanPredicate;</a>
<span class="sourceLineNo">039</span><a id="line.39">import org.gbif.api.model.predicate.LikePredicate;</a>
<span class="sourceLineNo">040</span><a id="line.40">import org.gbif.api.model.predicate.NotPredicate;</a>
<span class="sourceLineNo">041</span><a id="line.41">import org.gbif.api.model.predicate.Predicate;</a>
<span class="sourceLineNo">042</span><a id="line.42">import org.gbif.api.model.predicate.RangePredicate;</a>
<span class="sourceLineNo">043</span><a id="line.43">import org.gbif.api.model.predicate.WithinPredicate;</a>
<span class="sourceLineNo">044</span><a id="line.44">import org.gbif.api.util.IsoDateInterval;</a>
<span class="sourceLineNo">045</span><a id="line.45">import org.gbif.api.util.Range;</a>
<span class="sourceLineNo">046</span><a id="line.46">import org.gbif.api.util.RangeValue;</a>
<span class="sourceLineNo">047</span><a id="line.47">import org.gbif.api.util.SearchTypeValidator;</a>
<span class="sourceLineNo">048</span><a id="line.48">import org.gbif.api.vocabulary.Country;</a>
<span class="sourceLineNo">049</span><a id="line.49">import org.gbif.api.vocabulary.Language;</a>
<span class="sourceLineNo">050</span><a id="line.50">import org.gbif.predicate.query.occurrence.OccurrenceTermsMapper;</a>
<span class="sourceLineNo">051</span><a id="line.51">import org.junit.jupiter.api.Test;</a>
<span class="sourceLineNo">052</span><a id="line.52"></a>
<span class="sourceLineNo">053</span><a id="line.53">public class SQLQueryVisitorTest {</a>
<span class="sourceLineNo">054</span><a id="line.54"></a>
<span class="sourceLineNo">055</span><a id="line.55">  private static final OccurrenceSearchParameter PARAM = OccurrenceSearchParameter.CATALOG_NUMBER;</a>
<span class="sourceLineNo">056</span><a id="line.56">  private static final OccurrenceSearchParameter PARAM2 =</a>
<span class="sourceLineNo">057</span><a id="line.57">      OccurrenceSearchParameter.INSTITUTION_CODE;</a>
<span class="sourceLineNo">058</span><a id="line.58">  private final SQLQueryVisitor visitor = new SQLQueryVisitor(new OccurrenceTermsMapper());</a>
<span class="sourceLineNo">059</span><a id="line.59"></a>
<span class="sourceLineNo">060</span><a id="line.60">  @Test</a>
<span class="sourceLineNo">061</span><a id="line.61">  public void testComplexQuery() throws QueryBuildingException {</a>
<span class="sourceLineNo">062</span><a id="line.62">    Predicate aves = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.TAXON_KEY, "212", false);</a>
<span class="sourceLineNo">063</span><a id="line.63">    Predicate passer =</a>
<span class="sourceLineNo">064</span><a id="line.64">        new LikePredicate&lt;&gt;(OccurrenceSearchParameter.SCIENTIFIC_NAME, "Passer*", false);</a>
<span class="sourceLineNo">065</span><a id="line.65">    Predicate UK = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.COUNTRY, "GB", false);</a>
<span class="sourceLineNo">066</span><a id="line.66">    Predicate before1989 = new LessThanOrEqualsPredicate&lt;&gt;(OccurrenceSearchParameter.YEAR, "1989");</a>
<span class="sourceLineNo">067</span><a id="line.67">    Predicate georeferencedPredicate =</a>
<span class="sourceLineNo">068</span><a id="line.68">        new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.HAS_COORDINATE, "true", false);</a>
<span class="sourceLineNo">069</span><a id="line.69"></a>
<span class="sourceLineNo">070</span><a id="line.70">    ConjunctionPredicate p =</a>
<span class="sourceLineNo">071</span><a id="line.71">        new ConjunctionPredicate(</a>
<span class="sourceLineNo">072</span><a id="line.72">            Lists.newArrayList(aves, UK, passer, before1989, georeferencedPredicate));</a>
<span class="sourceLineNo">073</span><a id="line.73">    String where = visitor.buildQuery(p);</a>
<span class="sourceLineNo">074</span><a id="line.74">    assertEquals(</a>
<span class="sourceLineNo">075</span><a id="line.75">        "(((taxonkey = 212 OR acceptedtaxonkey = 212 OR kingdomkey = 212 OR phylumkey = 212 OR classkey = 212 OR orderkey = 212 OR familykey = 212 OR genuskey = 212 OR subgenuskey = 212 OR specieskey = 212)) AND (countrycode = \'GB\') AND (lower(scientificname) LIKE lower(\'Passer%\')) AND (year &lt;= 1989) AND (hascoordinate = true))",</a>
<span class="sourceLineNo">076</span><a id="line.76">        where);</a>
<span class="sourceLineNo">077</span><a id="line.77">  }</a>
<span class="sourceLineNo">078</span><a id="line.78"></a>
<span class="sourceLineNo">079</span><a id="line.79">  @Test</a>
<span class="sourceLineNo">080</span><a id="line.80">  public void testMoreComplexQuery() throws QueryBuildingException {</a>
<span class="sourceLineNo">081</span><a id="line.81">    Predicate taxon1 = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.TAXON_KEY, "1", false);</a>
<span class="sourceLineNo">082</span><a id="line.82">    Predicate taxon2 = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.TAXON_KEY, "2", false);</a>
<span class="sourceLineNo">083</span><a id="line.83">    DisjunctionPredicate taxa = new DisjunctionPredicate(Lists.newArrayList(taxon1, taxon2));</a>
<span class="sourceLineNo">084</span><a id="line.84"></a>
<span class="sourceLineNo">085</span><a id="line.85">    Predicate basis =</a>
<span class="sourceLineNo">086</span><a id="line.86">        new InPredicate&lt;&gt;(</a>
<span class="sourceLineNo">087</span><a id="line.87">            OccurrenceSearchParameter.BASIS_OF_RECORD,</a>
<span class="sourceLineNo">088</span><a id="line.88">            Lists.newArrayList("HUMAN_OBSERVATION", "MACHINE_OBSERVATION"),</a>
<span class="sourceLineNo">089</span><a id="line.89">            false);</a>
<span class="sourceLineNo">090</span><a id="line.90"></a>
<span class="sourceLineNo">091</span><a id="line.91">    Predicate UK = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.COUNTRY, "GB", false);</a>
<span class="sourceLineNo">092</span><a id="line.92">    Predicate IE = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.COUNTRY, "IE", false);</a>
<span class="sourceLineNo">093</span><a id="line.93">    DisjunctionPredicate countries = new DisjunctionPredicate(Lists.newArrayList(UK, IE));</a>
<span class="sourceLineNo">094</span><a id="line.94"></a>
<span class="sourceLineNo">095</span><a id="line.95">    Predicate before1989 = new LessThanOrEqualsPredicate&lt;&gt;(OccurrenceSearchParameter.YEAR, "1989");</a>
<span class="sourceLineNo">096</span><a id="line.96">    Predicate in2000 = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.YEAR, "2000", false);</a>
<span class="sourceLineNo">097</span><a id="line.97">    DisjunctionPredicate years = new DisjunctionPredicate(Lists.newArrayList(before1989, in2000));</a>
<span class="sourceLineNo">098</span><a id="line.98"></a>
<span class="sourceLineNo">099</span><a id="line.99">    ConjunctionPredicate p =</a>
<span class="sourceLineNo">100</span><a id="line.100">        new ConjunctionPredicate(Lists.newArrayList(taxa, basis, countries, years));</a>
<span class="sourceLineNo">101</span><a id="line.101">    String where = visitor.buildQuery(p);</a>
<span class="sourceLineNo">102</span><a id="line.102">    assertEquals(</a>
<span class="sourceLineNo">103</span><a id="line.103">        "(((taxonkey IN(1, 2) OR acceptedtaxonkey IN(1, 2) OR kingdomkey IN(1, 2) OR phylumkey IN(1, 2) OR classkey IN(1, 2) OR orderkey IN(1, 2) OR familykey IN(1, 2) OR genuskey IN(1, 2) OR subgenuskey IN(1, 2) OR specieskey IN(1, 2))) "</a>
<span class="sourceLineNo">104</span><a id="line.104">            + "AND ((basisofrecord IN('HUMAN_OBSERVATION', 'MACHINE_OBSERVATION'))) "</a>
<span class="sourceLineNo">105</span><a id="line.105">            + "AND ((countrycode IN(\'GB\', \'IE\'))) "</a>
<span class="sourceLineNo">106</span><a id="line.106">            + "AND (((year &lt;= 1989) OR (year = 2000))))",</a>
<span class="sourceLineNo">107</span><a id="line.107">        where);</a>
<span class="sourceLineNo">108</span><a id="line.108">  }</a>
<span class="sourceLineNo">109</span><a id="line.109"></a>
<span class="sourceLineNo">110</span><a id="line.110">  @Test</a>
<span class="sourceLineNo">111</span><a id="line.111">  public void testConjunctionPredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">112</span><a id="line.112">    Predicate p1 = new EqualsPredicate&lt;&gt;(PARAM, "value_1", false);</a>
<span class="sourceLineNo">113</span><a id="line.113">    Predicate p2 = new EqualsPredicate&lt;&gt;(PARAM2, "value_2", false);</a>
<span class="sourceLineNo">114</span><a id="line.114"></a>
<span class="sourceLineNo">115</span><a id="line.115">    ConjunctionPredicate p = new ConjunctionPredicate(Lists.newArrayList(p1, p2));</a>
<span class="sourceLineNo">116</span><a id="line.116">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">117</span><a id="line.117">    assertEquals(</a>
<span class="sourceLineNo">118</span><a id="line.118">        "((lower(catalognumber) = lower(\'value_1\')) AND (lower(institutioncode) = lower(\'value_2\')))",</a>
<span class="sourceLineNo">119</span><a id="line.119">        query);</a>
<span class="sourceLineNo">120</span><a id="line.120">  }</a>
<span class="sourceLineNo">121</span><a id="line.121"></a>
<span class="sourceLineNo">122</span><a id="line.122">  @Test</a>
<span class="sourceLineNo">123</span><a id="line.123">  public void testDisjunctionPredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">124</span><a id="line.124">    Predicate p1 = new EqualsPredicate&lt;&gt;(PARAM, "value_1", false);</a>
<span class="sourceLineNo">125</span><a id="line.125">    Predicate p2 = new EqualsPredicate&lt;&gt;(PARAM2, "value_2", false);</a>
<span class="sourceLineNo">126</span><a id="line.126"></a>
<span class="sourceLineNo">127</span><a id="line.127">    DisjunctionPredicate p = new DisjunctionPredicate(Lists.newArrayList(p1, p2));</a>
<span class="sourceLineNo">128</span><a id="line.128">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">129</span><a id="line.129">    assertEquals(</a>
<span class="sourceLineNo">130</span><a id="line.130">        "((lower(catalognumber) = lower(\'value_1\')) OR (lower(institutioncode) = lower(\'value_2\')))",</a>
<span class="sourceLineNo">131</span><a id="line.131">        query);</a>
<span class="sourceLineNo">132</span><a id="line.132">  }</a>
<span class="sourceLineNo">133</span><a id="line.133"></a>
<span class="sourceLineNo">134</span><a id="line.134">  @Test</a>
<span class="sourceLineNo">135</span><a id="line.135">  public void testDisjunctionToInPredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">136</span><a id="line.136">    Predicate p1 = new EqualsPredicate&lt;&gt;(PARAM, "value_1", false);</a>
<span class="sourceLineNo">137</span><a id="line.137">    Predicate p2 = new EqualsPredicate&lt;&gt;(PARAM, "value_2", false);</a>
<span class="sourceLineNo">138</span><a id="line.138"></a>
<span class="sourceLineNo">139</span><a id="line.139">    DisjunctionPredicate p = new DisjunctionPredicate(Lists.newArrayList(p1, p2));</a>
<span class="sourceLineNo">140</span><a id="line.140">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">141</span><a id="line.141">    assertEquals("(lower(catalognumber) IN(lower(\'value_1\'), lower(\'value_2\')))", query);</a>
<span class="sourceLineNo">142</span><a id="line.142">  }</a>
<span class="sourceLineNo">143</span><a id="line.143"></a>
<span class="sourceLineNo">144</span><a id="line.144">  @Test</a>
<span class="sourceLineNo">145</span><a id="line.145">  public void testDisjunctionToInTaxonPredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">146</span><a id="line.146">    Predicate p1 = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.TAXON_KEY, "1", false);</a>
<span class="sourceLineNo">147</span><a id="line.147">    Predicate p2 = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.TAXON_KEY, "2", false);</a>
<span class="sourceLineNo">148</span><a id="line.148"></a>
<span class="sourceLineNo">149</span><a id="line.149">    DisjunctionPredicate p = new DisjunctionPredicate(Lists.newArrayList(p1, p2));</a>
<span class="sourceLineNo">150</span><a id="line.150">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">151</span><a id="line.151">    assertEquals(</a>
<span class="sourceLineNo">152</span><a id="line.152">        "(taxonkey IN(1, 2) OR acceptedtaxonkey IN(1, 2) OR kingdomkey IN(1, 2) OR phylumkey IN(1, 2) OR classkey IN(1, 2) OR orderkey IN(1, 2) OR familykey IN(1, 2) OR genuskey IN(1, 2) OR subgenuskey IN(1, 2) OR specieskey IN(1, 2))",</a>
<span class="sourceLineNo">153</span><a id="line.153">        query);</a>
<span class="sourceLineNo">154</span><a id="line.154">  }</a>
<span class="sourceLineNo">155</span><a id="line.155"></a>
<span class="sourceLineNo">156</span><a id="line.156">  @Test</a>
<span class="sourceLineNo">157</span><a id="line.157">  public void testDisjunctionToInGadmGidPredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">158</span><a id="line.158">    Predicate p1 = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.GADM_GID, "IRL_1", false);</a>
<span class="sourceLineNo">159</span><a id="line.159">    Predicate p2 = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.GADM_GID, "GBR.2_1", false);</a>
<span class="sourceLineNo">160</span><a id="line.160"></a>
<span class="sourceLineNo">161</span><a id="line.161">    DisjunctionPredicate p = new DisjunctionPredicate(Lists.newArrayList(p1, p2));</a>
<span class="sourceLineNo">162</span><a id="line.162">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">163</span><a id="line.163">    assertEquals(</a>
<span class="sourceLineNo">164</span><a id="line.164">        "(level0gid IN('IRL_1', 'GBR.2_1') OR level1gid IN('IRL_1', 'GBR.2_1') OR level2gid IN('IRL_1', 'GBR.2_1') OR level3gid IN('IRL_1', 'GBR.2_1'))",</a>
<span class="sourceLineNo">165</span><a id="line.165">        query);</a>
<span class="sourceLineNo">166</span><a id="line.166">  }</a>
<span class="sourceLineNo">167</span><a id="line.167"></a>
<span class="sourceLineNo">168</span><a id="line.168">  @Test</a>
<span class="sourceLineNo">169</span><a id="line.169">  public void testDisjunctionMediaTypePredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">170</span><a id="line.170">    Predicate p1 = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.MEDIA_TYPE, "StillImage", false);</a>
<span class="sourceLineNo">171</span><a id="line.171">    Predicate p2 = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.MEDIA_TYPE, "Sound", false);</a>
<span class="sourceLineNo">172</span><a id="line.172"></a>
<span class="sourceLineNo">173</span><a id="line.173">    DisjunctionPredicate p = new DisjunctionPredicate(Lists.newArrayList(p1, p2));</a>
<span class="sourceLineNo">174</span><a id="line.174">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">175</span><a id="line.175">    assertEquals(</a>
<span class="sourceLineNo">176</span><a id="line.176">        "(stringArrayContains(mediatype,'StillImage',true) OR stringArrayContains(mediatype,'Sound',true))",</a>
<span class="sourceLineNo">177</span><a id="line.177">        query);</a>
<span class="sourceLineNo">178</span><a id="line.178">  }</a>
<span class="sourceLineNo">179</span><a id="line.179"></a>
<span class="sourceLineNo">180</span><a id="line.180">  @Test</a>
<span class="sourceLineNo">181</span><a id="line.181">  public void testDisjunctionVerbatimToInPredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">182</span><a id="line.182">    Predicate p1 = new EqualsPredicate&lt;&gt;(PARAM, "value_1", true);</a>
<span class="sourceLineNo">183</span><a id="line.183">    Predicate p2 = new EqualsPredicate&lt;&gt;(PARAM, "value_2", true);</a>
<span class="sourceLineNo">184</span><a id="line.184"></a>
<span class="sourceLineNo">185</span><a id="line.185">    DisjunctionPredicate p = new DisjunctionPredicate(Lists.newArrayList(p1, p2));</a>
<span class="sourceLineNo">186</span><a id="line.186">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">187</span><a id="line.187">    assertEquals("(catalognumber IN('value_1', 'value_2'))", query);</a>
<span class="sourceLineNo">188</span><a id="line.188"></a>
<span class="sourceLineNo">189</span><a id="line.189">    Predicate p3 = new EqualsPredicate&lt;&gt;(PARAM, "value_3", false);</a>
<span class="sourceLineNo">190</span><a id="line.190"></a>
<span class="sourceLineNo">191</span><a id="line.191">    p = new DisjunctionPredicate(Lists.newArrayList(p1, p2, p3));</a>
<span class="sourceLineNo">192</span><a id="line.192">    query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">193</span><a id="line.193">    assertEquals(</a>
<span class="sourceLineNo">194</span><a id="line.194">        "((catalognumber = 'value_1') OR (catalognumber = 'value_2') OR (lower(catalognumber) = lower('value_3')))",</a>
<span class="sourceLineNo">195</span><a id="line.195">        query);</a>
<span class="sourceLineNo">196</span><a id="line.196">  }</a>
<span class="sourceLineNo">197</span><a id="line.197"></a>
<span class="sourceLineNo">198</span><a id="line.198">  @Test</a>
<span class="sourceLineNo">199</span><a id="line.199">  public void testEqualsPredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">200</span><a id="line.200">    Predicate p = new EqualsPredicate&lt;&gt;(PARAM, "value", false);</a>
<span class="sourceLineNo">201</span><a id="line.201">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">202</span><a id="line.202">    assertEquals("lower(catalognumber) = lower(\'value\')", query);</a>
<span class="sourceLineNo">203</span><a id="line.203">  }</a>
<span class="sourceLineNo">204</span><a id="line.204"></a>
<span class="sourceLineNo">205</span><a id="line.205">  @Test</a>
<span class="sourceLineNo">206</span><a id="line.206">  public void testLikePredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">207</span><a id="line.207">    // NB: ? and * are wildcards (translated to SQL _ and %), so literal _ and % are escaped.</a>
<span class="sourceLineNo">208</span><a id="line.208">    Predicate p = new LikePredicate&lt;&gt;(PARAM, "v?l*ue_%", false);</a>
<span class="sourceLineNo">209</span><a id="line.209">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">210</span><a id="line.210">    assertEquals("lower(catalognumber) LIKE lower(\'v_l%ue\\_\\%\')", query);</a>
<span class="sourceLineNo">211</span><a id="line.211">  }</a>
<span class="sourceLineNo">212</span><a id="line.212"></a>
<span class="sourceLineNo">213</span><a id="line.213">  @Test</a>
<span class="sourceLineNo">214</span><a id="line.214">  public void testLikeVerbatimPredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">215</span><a id="line.215">    Predicate p = new LikePredicate&lt;&gt;(PARAM, "v?l*ue_%", true);</a>
<span class="sourceLineNo">216</span><a id="line.216">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">217</span><a id="line.217">    assertEquals("catalognumber LIKE \'v_l%ue\\_\\%\'", query);</a>
<span class="sourceLineNo">218</span><a id="line.218">  }</a>
<span class="sourceLineNo">219</span><a id="line.219"></a>
<span class="sourceLineNo">220</span><a id="line.220">  @Test</a>
<span class="sourceLineNo">221</span><a id="line.221">  public void testEqualsVerbatimPredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">222</span><a id="line.222">    Predicate p = new EqualsPredicate&lt;&gt;(PARAM, "value", true);</a>
<span class="sourceLineNo">223</span><a id="line.223">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">224</span><a id="line.224">    assertEquals("catalognumber = \'value\'", query);</a>
<span class="sourceLineNo">225</span><a id="line.225">  }</a>
<span class="sourceLineNo">226</span><a id="line.226"></a>
<span class="sourceLineNo">227</span><a id="line.227">  @Test</a>
<span class="sourceLineNo">228</span><a id="line.228">  public void testEqualsArrayPredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">229</span><a id="line.229">    Predicate p = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.RECORDED_BY, "value", false);</a>
<span class="sourceLineNo">230</span><a id="line.230">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">231</span><a id="line.231">    assertEquals("stringArrayContains(recordedby,'value',false)", query);</a>
<span class="sourceLineNo">232</span><a id="line.232"></a>
<span class="sourceLineNo">233</span><a id="line.233">    p = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.RECORDED_BY, "value", true);</a>
<span class="sourceLineNo">234</span><a id="line.234">    query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">235</span><a id="line.235">    assertEquals("stringArrayContains(recordedby,'value',true)", query);</a>
<span class="sourceLineNo">236</span><a id="line.236">  }</a>
<span class="sourceLineNo">237</span><a id="line.237"></a>
<span class="sourceLineNo">238</span><a id="line.238">  @Test</a>
<span class="sourceLineNo">239</span><a id="line.239">  public void testLikeArrayPredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">240</span><a id="line.240">    // NB: ? and * are the wildcards here.</a>
<span class="sourceLineNo">241</span><a id="line.241">    Predicate p = new LikePredicate&lt;&gt;(OccurrenceSearchParameter.RECORDED_BY, "v?l*ue_%", false);</a>
<span class="sourceLineNo">242</span><a id="line.242">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">243</span><a id="line.243">    assertEquals("stringArrayLike(recordedby,'v?l*ue_%',false)", query);</a>
<span class="sourceLineNo">244</span><a id="line.244"></a>
<span class="sourceLineNo">245</span><a id="line.245">    p = new LikePredicate&lt;&gt;(OccurrenceSearchParameter.RECORDED_BY, "v?l*ue_%", true);</a>
<span class="sourceLineNo">246</span><a id="line.246">    query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">247</span><a id="line.247">    assertEquals("stringArrayLike(recordedby,'v?l*ue_%',true)", query);</a>
<span class="sourceLineNo">248</span><a id="line.248">  }</a>
<span class="sourceLineNo">249</span><a id="line.249"></a>
<span class="sourceLineNo">250</span><a id="line.250">  @Test</a>
<span class="sourceLineNo">251</span><a id="line.251">  public void testGreaterThanOrEqualPredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">252</span><a id="line.252">    Predicate p = new GreaterThanOrEqualsPredicate&lt;&gt;(OccurrenceSearchParameter.ELEVATION, "222");</a>
<span class="sourceLineNo">253</span><a id="line.253">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">254</span><a id="line.254">    assertEquals("elevation &gt;= 222", query);</a>
<span class="sourceLineNo">255</span><a id="line.255">  }</a>
<span class="sourceLineNo">256</span><a id="line.256"></a>
<span class="sourceLineNo">257</span><a id="line.257">  @Test</a>
<span class="sourceLineNo">258</span><a id="line.258">  public void testGreaterThanPredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">259</span><a id="line.259">    Predicate p = new GreaterThanPredicate&lt;&gt;(OccurrenceSearchParameter.ELEVATION, "1000");</a>
<span class="sourceLineNo">260</span><a id="line.260">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">261</span><a id="line.261">    assertEquals("elevation &gt; 1000", query);</a>
<span class="sourceLineNo">262</span><a id="line.262">  }</a>
<span class="sourceLineNo">263</span><a id="line.263"></a>
<span class="sourceLineNo">264</span><a id="line.264">  @Test</a>
<span class="sourceLineNo">265</span><a id="line.265">  public void testInPredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">266</span><a id="line.266">    Predicate p =</a>
<span class="sourceLineNo">267</span><a id="line.267">        new InPredicate&lt;&gt;(PARAM, Lists.newArrayList("value_1", "value_2", "value_3"), false);</a>
<span class="sourceLineNo">268</span><a id="line.268">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">269</span><a id="line.269">    assertEquals(</a>
<span class="sourceLineNo">270</span><a id="line.270">        "(lower(catalognumber) IN(lower(\'value_1\'), lower(\'value_2\'), lower(\'value_3\')))",</a>
<span class="sourceLineNo">271</span><a id="line.271">        query);</a>
<span class="sourceLineNo">272</span><a id="line.272">  }</a>
<span class="sourceLineNo">273</span><a id="line.273"></a>
<span class="sourceLineNo">274</span><a id="line.274">  @Test</a>
<span class="sourceLineNo">275</span><a id="line.275">  public void testInVerbatimPredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">276</span><a id="line.276">    Predicate p =</a>
<span class="sourceLineNo">277</span><a id="line.277">        new InPredicate&lt;&gt;(PARAM, Lists.newArrayList("value_1", "value_2", "value_3"), true);</a>
<span class="sourceLineNo">278</span><a id="line.278">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">279</span><a id="line.279">    assertEquals("(catalognumber IN(\'value_1\', \'value_2\', \'value_3\'))", query);</a>
<span class="sourceLineNo">280</span><a id="line.280">  }</a>
<span class="sourceLineNo">281</span><a id="line.281"></a>
<span class="sourceLineNo">282</span><a id="line.282">  @Test</a>
<span class="sourceLineNo">283</span><a id="line.283">  public void testInPredicateTaxonKey() throws QueryBuildingException {</a>
<span class="sourceLineNo">284</span><a id="line.284">    Predicate p =</a>
<span class="sourceLineNo">285</span><a id="line.285">        new InPredicate&lt;&gt;(OccurrenceSearchParameter.TAXON_KEY, Lists.newArrayList("1", "2"), false);</a>
<span class="sourceLineNo">286</span><a id="line.286">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">287</span><a id="line.287">    assertEquals(</a>
<span class="sourceLineNo">288</span><a id="line.288">        "(taxonkey IN(1, 2) OR acceptedtaxonkey IN(1, 2) OR kingdomkey IN(1, 2) OR phylumkey IN(1, 2) OR classkey IN(1, 2) OR orderkey IN(1, 2) OR familykey IN(1, 2) OR genuskey IN(1, 2) OR subgenuskey IN(1, 2) OR specieskey IN(1, 2))",</a>
<span class="sourceLineNo">289</span><a id="line.289">        query);</a>
<span class="sourceLineNo">290</span><a id="line.290">  }</a>
<span class="sourceLineNo">291</span><a id="line.291"></a>
<span class="sourceLineNo">292</span><a id="line.292">  @Test</a>
<span class="sourceLineNo">293</span><a id="line.293">  public void testInPredicateGadmGid() throws QueryBuildingException {</a>
<span class="sourceLineNo">294</span><a id="line.294">    Predicate p =</a>
<span class="sourceLineNo">295</span><a id="line.295">        new InPredicate&lt;&gt;(</a>
<span class="sourceLineNo">296</span><a id="line.296">            OccurrenceSearchParameter.GADM_GID, Lists.newArrayList("IRL_1", "GBR.2_1"), false);</a>
<span class="sourceLineNo">297</span><a id="line.297">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">298</span><a id="line.298">    assertEquals(</a>
<span class="sourceLineNo">299</span><a id="line.299">        "(level0gid IN('IRL_1', 'GBR.2_1') OR level1gid IN('IRL_1', 'GBR.2_1') OR level2gid IN('IRL_1', 'GBR.2_1') OR level3gid IN('IRL_1', 'GBR.2_1'))",</a>
<span class="sourceLineNo">300</span><a id="line.300">        query);</a>
<span class="sourceLineNo">301</span><a id="line.301">  }</a>
<span class="sourceLineNo">302</span><a id="line.302"></a>
<span class="sourceLineNo">303</span><a id="line.303">  @Test</a>
<span class="sourceLineNo">304</span><a id="line.304">  public void testInPredicateMediaType() throws QueryBuildingException {</a>
<span class="sourceLineNo">305</span><a id="line.305">    Predicate p =</a>
<span class="sourceLineNo">306</span><a id="line.306">        new InPredicate&lt;&gt;(</a>
<span class="sourceLineNo">307</span><a id="line.307">            OccurrenceSearchParameter.MEDIA_TYPE, Lists.newArrayList("StillImage", "Sound"), false);</a>
<span class="sourceLineNo">308</span><a id="line.308">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">309</span><a id="line.309">    assertEquals(</a>
<span class="sourceLineNo">310</span><a id="line.310">        "(stringArrayContains(mediatype,'StillImage',true) OR stringArrayContains(mediatype,'Sound',true))",</a>
<span class="sourceLineNo">311</span><a id="line.311">        query);</a>
<span class="sourceLineNo">312</span><a id="line.312">  }</a>
<span class="sourceLineNo">313</span><a id="line.313"></a>
<span class="sourceLineNo">314</span><a id="line.314">  @Test</a>
<span class="sourceLineNo">315</span><a id="line.315">  public void testLessThanOrEqualPredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">316</span><a id="line.316">    Predicate p = new LessThanOrEqualsPredicate&lt;&gt;(OccurrenceSearchParameter.ELEVATION, "1000");</a>
<span class="sourceLineNo">317</span><a id="line.317">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">318</span><a id="line.318">    assertEquals("elevation &lt;= 1000", query);</a>
<span class="sourceLineNo">319</span><a id="line.319">  }</a>
<span class="sourceLineNo">320</span><a id="line.320"></a>
<span class="sourceLineNo">321</span><a id="line.321">  @Test</a>
<span class="sourceLineNo">322</span><a id="line.322">  public void testLessThanPredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">323</span><a id="line.323">    Predicate p = new LessThanPredicate&lt;&gt;(OccurrenceSearchParameter.ELEVATION, "1000");</a>
<span class="sourceLineNo">324</span><a id="line.324">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">325</span><a id="line.325">    assertEquals("elevation &lt; 1000", query);</a>
<span class="sourceLineNo">326</span><a id="line.326">  }</a>
<span class="sourceLineNo">327</span><a id="line.327"></a>
<span class="sourceLineNo">328</span><a id="line.328">  @Test</a>
<span class="sourceLineNo">329</span><a id="line.329">  public void testNotPredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">330</span><a id="line.330">    Predicate p = new NotPredicate(new EqualsPredicate&lt;&gt;(PARAM, "value", false));</a>
<span class="sourceLineNo">331</span><a id="line.331">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">332</span><a id="line.332">    assertEquals("NOT lower(catalognumber) = lower(\'value\')", query);</a>
<span class="sourceLineNo">333</span><a id="line.333">  }</a>
<span class="sourceLineNo">334</span><a id="line.334"></a>
<span class="sourceLineNo">335</span><a id="line.335">  @Test</a>
<span class="sourceLineNo">336</span><a id="line.336">  public void testNotPredicateComplex() throws QueryBuildingException {</a>
<span class="sourceLineNo">337</span><a id="line.337">    Predicate p1 = new EqualsPredicate&lt;&gt;(PARAM, "value_1", false);</a>
<span class="sourceLineNo">338</span><a id="line.338">    Predicate p2 = new EqualsPredicate&lt;&gt;(PARAM2, "value_2", false);</a>
<span class="sourceLineNo">339</span><a id="line.339"></a>
<span class="sourceLineNo">340</span><a id="line.340">    ConjunctionPredicate cp = new ConjunctionPredicate(Lists.newArrayList(p1, p2));</a>
<span class="sourceLineNo">341</span><a id="line.341"></a>
<span class="sourceLineNo">342</span><a id="line.342">    Predicate p = new NotPredicate(cp);</a>
<span class="sourceLineNo">343</span><a id="line.343">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">344</span><a id="line.344">    assertEquals(</a>
<span class="sourceLineNo">345</span><a id="line.345">        "NOT ((lower(catalognumber) = lower(\'value_1\')) AND (lower(institutioncode) = lower(\'value_2\')))",</a>
<span class="sourceLineNo">346</span><a id="line.346">        query);</a>
<span class="sourceLineNo">347</span><a id="line.347">  }</a>
<span class="sourceLineNo">348</span><a id="line.348"></a>
<span class="sourceLineNo">349</span><a id="line.349">  @Test</a>
<span class="sourceLineNo">350</span><a id="line.350">  public void testQuotes() throws QueryBuildingException {</a>
<span class="sourceLineNo">351</span><a id="line.351">    Predicate p = new EqualsPredicate&lt;&gt;(PARAM, "my \'pleasure\'", false);</a>
<span class="sourceLineNo">352</span><a id="line.352">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">353</span><a id="line.353">    assertEquals("lower(catalognumber) = lower(\'my \\\'pleasure\\\'\')", query);</a>
<span class="sourceLineNo">354</span><a id="line.354"></a>
<span class="sourceLineNo">355</span><a id="line.355">    Predicate predicateRecordedBY =</a>
<span class="sourceLineNo">356</span><a id="line.356">        new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.RECORDED_BY, "Brian J O'Shea", false);</a>
<span class="sourceLineNo">357</span><a id="line.357">    String queryRecordedBy = visitor.buildQuery(predicateRecordedBY);</a>
<span class="sourceLineNo">358</span><a id="line.358">    assertEquals("stringArrayContains(recordedby,'Brian J O\\'Shea',false)", queryRecordedBy);</a>
<span class="sourceLineNo">359</span><a id="line.359"></a>
<span class="sourceLineNo">360</span><a id="line.360">    p = new LessThanOrEqualsPredicate&lt;&gt;(OccurrenceSearchParameter.ELEVATION, "101");</a>
<span class="sourceLineNo">361</span><a id="line.361">    query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">362</span><a id="line.362">    assertEquals("elevation &lt;= 101", query);</a>
<span class="sourceLineNo">363</span><a id="line.363"></a>
<span class="sourceLineNo">364</span><a id="line.364">    p = new GreaterThanPredicate&lt;&gt;(OccurrenceSearchParameter.YEAR, "1998");</a>
<span class="sourceLineNo">365</span><a id="line.365">    query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">366</span><a id="line.366">    assertEquals("year &gt; 1998", query);</a>
<span class="sourceLineNo">367</span><a id="line.367">  }</a>
<span class="sourceLineNo">368</span><a id="line.368"></a>
<span class="sourceLineNo">369</span><a id="line.369">  @Test</a>
<span class="sourceLineNo">370</span><a id="line.370">  public void testGeoDistancePredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">371</span><a id="line.371">    Predicate p = new GeoDistancePredicate("30", "10", "10km");</a>
<span class="sourceLineNo">372</span><a id="line.372">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">373</span><a id="line.373">    assertEquals(</a>
<span class="sourceLineNo">374</span><a id="line.374">        "(geoDistance(30.0, 10.0, '10.0km', decimallatitude, decimallongitude) = TRUE)", query);</a>
<span class="sourceLineNo">375</span><a id="line.375">  }</a>
<span class="sourceLineNo">376</span><a id="line.376"></a>
<span class="sourceLineNo">377</span><a id="line.377">  @Test</a>
<span class="sourceLineNo">378</span><a id="line.378">  public void testWithinPredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">379</span><a id="line.379">    final String wkt = "POLYGON ((30 10, 10 20, 20 40, 40 40, 30 10))";</a>
<span class="sourceLineNo">380</span><a id="line.380">    Predicate p = new WithinPredicate(wkt);</a>
<span class="sourceLineNo">381</span><a id="line.381">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">382</span><a id="line.382">    assertEquals("(contains('" + wkt + "', decimallatitude, decimallongitude) = TRUE)", query);</a>
<span class="sourceLineNo">383</span><a id="line.383">  }</a>
<span class="sourceLineNo">384</span><a id="line.384"></a>
<span class="sourceLineNo">385</span><a id="line.385">  @Test</a>
<span class="sourceLineNo">386</span><a id="line.386">  public void testLongerWithinPredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">387</span><a id="line.387">    final String wkt =</a>
<span class="sourceLineNo">388</span><a id="line.388">        "POLYGON ((-21.4671921 65.441761, -21.3157028 65.9990267, -22.46732 66.4657148, -23.196803 66.3490242, -22.362113 66.2703732, -22.9758561 66.228119, -22.3831844 66.0933255, -22.424131 65.8374539, -23.4703372 66.1972321, -23.2565264 65.6767322, -24.5319933 65.5027259, -21.684764 65.4547893, -24.0482947 64.8794291, -21.3551366 64.3842337, -22.7053151 63.8001572, -19.1269971 63.3980322, -13.4948065 65.076438, -15.1872897 66.1073781, -14.5302343 66.3783121, -16.0235596 66.5371808, -21.4671921 65.441761))";</a>
<span class="sourceLineNo">389</span><a id="line.389">    Predicate p = new WithinPredicate(wkt);</a>
<span class="sourceLineNo">390</span><a id="line.390">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">391</span><a id="line.391">    assertEquals(</a>
<span class="sourceLineNo">392</span><a id="line.392">        "((decimallatitude &gt;= 63.3980322 AND decimallatitude &lt;= 66.5371808 AND (decimallongitude &gt;= -24.5319933 AND decimallongitude &lt;= -13.4948065)) AND contains('"</a>
<span class="sourceLineNo">393</span><a id="line.393">            + wkt</a>
<span class="sourceLineNo">394</span><a id="line.394">            + "', decimallatitude, decimallongitude) = TRUE)",</a>
<span class="sourceLineNo">395</span><a id="line.395">        query);</a>
<span class="sourceLineNo">396</span><a id="line.396">  }</a>
<span class="sourceLineNo">397</span><a id="line.397"></a>
<span class="sourceLineNo">398</span><a id="line.398">  @Test</a>
<span class="sourceLineNo">399</span><a id="line.399">  public void testAntimeridianWithinPredicate() throws Exception {</a>
<span class="sourceLineNo">400</span><a id="line.400">    // A rectangle over the Bering sea, shouldn't have any bounding box added</a>
<span class="sourceLineNo">401</span><a id="line.401">    String wkt =</a>
<span class="sourceLineNo">402</span><a id="line.402">        "POLYGON((-206.71875 39.20502, -133.59375 39.20502, -133.59375 77.26611, -206.71875 77.26611, -206.71875 39.20502))";</a>
<span class="sourceLineNo">403</span><a id="line.403">    String query = visitor.buildQuery(new WithinPredicate(wkt));</a>
<span class="sourceLineNo">404</span><a id="line.404">    assertEquals("(contains('" + wkt + "', decimallatitude, decimallongitude) = TRUE)", query);</a>
<span class="sourceLineNo">405</span><a id="line.405">  }</a>
<span class="sourceLineNo">406</span><a id="line.406"></a>
<span class="sourceLineNo">407</span><a id="line.407">  @Test</a>
<span class="sourceLineNo">408</span><a id="line.408">  public void testAddedBoundingBoxes() throws Exception {</a>
<span class="sourceLineNo">409</span><a id="line.409">    String query;</a>
<span class="sourceLineNo">410</span><a id="line.410"></a>
<span class="sourceLineNo">411</span><a id="line.411">    // A multipolygon around Taveuni, split over the antimeridian</a>
<span class="sourceLineNo">412</span><a id="line.412">    String wktM =</a>
<span class="sourceLineNo">413</span><a id="line.413">        "MULTIPOLYGON (((180 -16.658979090909092, 180 -17.12485513597339, 179.87915 -17.12058, 179.78577 -16.82899, 179.85168 -16.72643, 180 -16.658979090909092)), ((-180 -17.12485513597339, -180 -16.658979090909092, -179.8764 -16.60277, -179.75006 -16.86054, -179.89838 -17.12845, -180 -17.12485513597339)))";</a>
<span class="sourceLineNo">414</span><a id="line.414">    String bbox =</a>
<span class="sourceLineNo">415</span><a id="line.415">        "(decimallatitude &gt;= -17.12845 AND decimallatitude &lt;= -16.60277 AND (decimallongitude &gt;= 179.78577 OR decimallongitude &lt;= -179.75006))";</a>
<span class="sourceLineNo">416</span><a id="line.416">    query = visitor.buildQuery(new WithinPredicate(wktM));</a>
<span class="sourceLineNo">417</span><a id="line.417">    assertEquals(</a>
<span class="sourceLineNo">418</span><a id="line.418">        "(" + bbox + " AND contains('" + wktM + "', decimallatitude, decimallongitude) = TRUE)",</a>
<span class="sourceLineNo">419</span><a id="line.419">        query);</a>
<span class="sourceLineNo">420</span><a id="line.420"></a>
<span class="sourceLineNo">421</span><a id="line.421">    // A polygon around Taveuni, Fiji, as portal16 produces it.</a>
<span class="sourceLineNo">422</span><a id="line.422">    // Note the result still contains the multipolygon.</a>
<span class="sourceLineNo">423</span><a id="line.423">    String wkt16 =</a>
<span class="sourceLineNo">424</span><a id="line.424">        "POLYGON((-180.14832 -16.72643, -180.21423 -16.82899, -180.12085 -17.12058, -179.89838 -17.12845, -179.75006 -16.86054, -179.8764 -16.60277, -180.14832 -16.72643))";</a>
<span class="sourceLineNo">425</span><a id="line.425">    query = visitor.buildQuery(new WithinPredicate(wkt16));</a>
<span class="sourceLineNo">426</span><a id="line.426">    assertEquals(</a>
<span class="sourceLineNo">427</span><a id="line.427">        "(" + bbox + " AND contains('" + wktM + "', decimallatitude, decimallongitude) = TRUE)",</a>
<span class="sourceLineNo">428</span><a id="line.428">        query);</a>
<span class="sourceLineNo">429</span><a id="line.429"></a>
<span class="sourceLineNo">430</span><a id="line.430">    // Same place, but as Wicket draws it:</a>
<span class="sourceLineNo">431</span><a id="line.431">    // Note the result still contains the same multipolygon.</a>
<span class="sourceLineNo">432</span><a id="line.432">    String wktWk =</a>
<span class="sourceLineNo">433</span><a id="line.433">        "POLYGON((179.85168 -16.72643, 179.78577 -16.82899, 179.87915 -17.12058, -179.89838 -17.12845, -179.75006 -16.86054, -179.8764 -16.60277, 179.85168 -16.72643))";</a>
<span class="sourceLineNo">434</span><a id="line.434">    query = visitor.buildQuery(new WithinPredicate(wktWk));</a>
<span class="sourceLineNo">435</span><a id="line.435">    assertEquals(</a>
<span class="sourceLineNo">436</span><a id="line.436">        "(" + bbox + " AND contains('" + wktM + "', decimallatitude, decimallongitude) = TRUE)",</a>
<span class="sourceLineNo">437</span><a id="line.437">        query);</a>
<span class="sourceLineNo">438</span><a id="line.438"></a>
<span class="sourceLineNo">439</span><a id="line.439">    // Tiny areas scattered around the world, all in a single multipolygon.</a>
<span class="sourceLineNo">440</span><a id="line.440">    // Requires bounding boxes to avoid very slow Hive performance.</a>
<span class="sourceLineNo">441</span><a id="line.441">    String wktMM =</a>
<span class="sourceLineNo">442</span><a id="line.442">        "MULTIPOLYGON (((-109.42861 -27.13333, -109.42861 -27.13666, -109.43138 -27.13666, -109.43138 -27.13333, -109.42861 -27.13333)), "</a>
<span class="sourceLineNo">443</span><a id="line.443">            + "((-109.42236 -27.10919, -109.42236 -27.11191, -109.42541 -27.11191, -109.42541 -27.10919, -109.42236 -27.10919)), "</a>
<span class="sourceLineNo">444</span><a id="line.444">            + "((-174.35146 -19.80528, -174.35146 -19.81829, -174.36338 -19.81829, -174.36338 -19.80528, -174.35146 -19.80528)), "</a>
<span class="sourceLineNo">445</span><a id="line.445">            + "((-173.94525 -18.71444, -173.96472 -18.71444, -173.96472 -18.68694, -173.94525 -18.68694, -173.94525 -18.71444)), "</a>
<span class="sourceLineNo">446</span><a id="line.446">            + "((-173.91655 -18.66372, -173.94041 -18.66372, -173.94041 -18.63616, -173.91655 -18.63616, -173.91655 -18.66372)))";</a>
<span class="sourceLineNo">447</span><a id="line.447">    String bboxMM =</a>
<span class="sourceLineNo">448</span><a id="line.448">        "(decimallatitude &gt;= -27.13666 AND decimallatitude &lt;= -18.63616 AND (decimallongitude &gt;= -174.36338 AND decimallongitude &lt;= -109.42236)) AND "</a>
<span class="sourceLineNo">449</span><a id="line.449">            + "(((decimallatitude &gt;= -27.13666 AND decimallatitude &lt;= -27.13333 AND (decimallongitude &gt;= -109.43138 AND decimallongitude &lt;= -109.42861)) OR "</a>
<span class="sourceLineNo">450</span><a id="line.450">            + "(decimallatitude &gt;= -27.11191 AND decimallatitude &lt;= -27.10919 AND (decimallongitude &gt;= -109.42541 AND decimallongitude &lt;= -109.42236)) OR "</a>
<span class="sourceLineNo">451</span><a id="line.451">            + "(decimallatitude &gt;= -19.81829 AND decimallatitude &lt;= -19.80528 AND (decimallongitude &gt;= -174.36338 AND decimallongitude &lt;= -174.35146)) OR "</a>
<span class="sourceLineNo">452</span><a id="line.452">            + "(decimallatitude &gt;= -18.71444 AND decimallatitude &lt;= -18.68694 AND (decimallongitude &gt;= -173.96472 AND decimallongitude &lt;= -173.94525)) OR "</a>
<span class="sourceLineNo">453</span><a id="line.453">            + "(decimallatitude &gt;= -18.66372 AND decimallatitude &lt;= -18.63616 AND (decimallongitude &gt;= -173.94041 AND decimallongitude &lt;= -173.91655))))";</a>
<span class="sourceLineNo">454</span><a id="line.454">    query = visitor.buildQuery(new WithinPredicate(wktMM));</a>
<span class="sourceLineNo">455</span><a id="line.455">    assertEquals(</a>
<span class="sourceLineNo">456</span><a id="line.456">        "(" + bboxMM + " AND contains('" + wktMM + "', decimallatitude, decimallongitude) = TRUE)",</a>
<span class="sourceLineNo">457</span><a id="line.457">        query);</a>
<span class="sourceLineNo">458</span><a id="line.458">  }</a>
<span class="sourceLineNo">459</span><a id="line.459"></a>
<span class="sourceLineNo">460</span><a id="line.460">  @Test</a>
<span class="sourceLineNo">461</span><a id="line.461">  public void testWidePolygons() throws Exception {</a>
<span class="sourceLineNo">462</span><a id="line.462">    String query;</a>
<span class="sourceLineNo">463</span><a id="line.463"></a>
<span class="sourceLineNo">464</span><a id="line.464">    // A polygon around Antarctica</a>
<span class="sourceLineNo">465</span><a id="line.465">    String wktP =</a>
<span class="sourceLineNo">466</span><a id="line.466">        "POLYGON ((180 -64.7, 180 -56.8, 180 -44.3, 173 -44.3, 173 -47.5, 170 -47.5, 157 -47.5, 157 -45.9, 150 -45.9, 150 -47.5, 143 -47.5, 143 -45.8, 140 -45.8, 140 -44.5, 137 -44.5, 137 -43, 135 -43, 135 -41.7, 131 -41.7, 131 -40.1, 115 -40.1, 92 -40.1, 92 -41.4, 78 -41.4, 78 -42.3, 69 -42.3, 69 -43.3, 47 -43.3, 47 -41.7, 30 -41.7, 12 -41.7, 12 -40.3, 10 -40.3, 10 -38.3, -5 -38.3, -5 -38.9, -9 -38.9, -9 -40.2, -13 -40.2, -13 -41.4, -21 -41.4, -21 -42.5, -39 -42.5, -39 -40.7, -49 -40.7, -49 -48.6, -54 -48.6, -54 -55.7, -62.79726 -55.7, -64 -55.7, -64 -57.8, -71 -57.8, -71 -58.9, -80 -58.9, -80 -40, -103.71094 -40.14844, -125 -40, -167 -40, -167 -42.6, -171 -42.6, -171 -44.3, -180 -44.3, -180 -56.8, -180 -64.7, -180 -80, -125 -80, -70 -80, 30 -80, 115 -80, 158 -80, 180 -80, 180 -64.7))";</a>
<span class="sourceLineNo">467</span><a id="line.467">    query = visitor.buildQuery(new WithinPredicate(wktP));</a>
<span class="sourceLineNo">468</span><a id="line.468">    assertEquals(</a>
<span class="sourceLineNo">469</span><a id="line.469">        "((decimallatitude &gt;= -80.0 AND decimallatitude &lt;= -38.3 AND (decimallongitude &gt;= -180.0 AND decimallongitude &lt;= 180.0)) AND contains('"</a>
<span class="sourceLineNo">470</span><a id="line.470">            + wktP</a>
<span class="sourceLineNo">471</span><a id="line.471">            + "', decimallatitude, decimallongitude) = TRUE)",</a>
<span class="sourceLineNo">472</span><a id="line.472">        query);</a>
<span class="sourceLineNo">473</span><a id="line.473"></a>
<span class="sourceLineNo">474</span><a id="line.474">    // A multipolygon around the Pacific and Indian oceans, split over the antimeridian</a>
<span class="sourceLineNo">475</span><a id="line.475">    String wktM =</a>
<span class="sourceLineNo">476</span><a id="line.476">        "MULTIPOLYGON (((180 51.83076923076923, 180 -63, 35 -63, 60 -9, 127 1, 157 49, 180 51.83076923076923)), ((-180 -63, -180 51.83076923076923, -138 57, -127 39, -112 18, -92 13, -84 1, -77 -63, -169 -63, -180 -63)))";</a>
<span class="sourceLineNo">477</span><a id="line.477">    String bbox =</a>
<span class="sourceLineNo">478</span><a id="line.478">        "(decimallatitude &gt;= -63.0 AND decimallatitude &lt;= 57.0 AND (decimallongitude &gt;= 35.0 OR decimallongitude &lt;= -77.0))";</a>
<span class="sourceLineNo">479</span><a id="line.479">    query = visitor.buildQuery(new WithinPredicate(wktM));</a>
<span class="sourceLineNo">480</span><a id="line.480">    assertEquals(</a>
<span class="sourceLineNo">481</span><a id="line.481">        "(" + bbox + " AND contains('" + wktM + "', decimallatitude, decimallongitude) = TRUE)",</a>
<span class="sourceLineNo">482</span><a id="line.482">        query);</a>
<span class="sourceLineNo">483</span><a id="line.483"></a>
<span class="sourceLineNo">484</span><a id="line.484">    // The same polygon, as portal16 produces it.</a>
<span class="sourceLineNo">485</span><a id="line.485">    // Note the result still contains the multipolygon.</a>
<span class="sourceLineNo">486</span><a id="line.486">    String wkt16 =</a>
<span class="sourceLineNo">487</span><a id="line.487">        "POLYGON((35.0 -63.0, 191.0 -63.0, 283.0 -63.0, 276.0 1.0, 268.0 13.0, 248.0 18.0, 233.0 39.0, 222.0 57.0, 157.0 49.0, 127.0 1.0, 60.0 -9.0, 35.0 -63.0))";</a>
<span class="sourceLineNo">488</span><a id="line.488">    query = visitor.buildQuery(new WithinPredicate(wkt16));</a>
<span class="sourceLineNo">489</span><a id="line.489">    assertEquals(</a>
<span class="sourceLineNo">490</span><a id="line.490">        "(" + bbox + " AND contains('" + wktM + "', decimallatitude, decimallongitude) = TRUE)",</a>
<span class="sourceLineNo">491</span><a id="line.491">        query);</a>
<span class="sourceLineNo">492</span><a id="line.492"></a>
<span class="sourceLineNo">493</span><a id="line.493">    // A polygon around the Pacific, as Wicket draws it:</a>
<span class="sourceLineNo">494</span><a id="line.494">    String wktWk =</a>
<span class="sourceLineNo">495</span><a id="line.495">        "POLYGON((157.0 49.0,127.0 1.0,60.0 -9.0,35.0 -63.0,-169.0 -63.0,-77.0 -63.0,-84.0 1.0,-92.0 13.0,-112.0 18.0,-127.0 39.0,-138.0 57.0,157.0 49.0))";</a>
<span class="sourceLineNo">496</span><a id="line.496">    assertEquals(</a>
<span class="sourceLineNo">497</span><a id="line.497">        "(" + bbox + " AND contains('" + wktM + "', decimallatitude, decimallongitude) = TRUE)",</a>
<span class="sourceLineNo">498</span><a id="line.498">        query);</a>
<span class="sourceLineNo">499</span><a id="line.499">  }</a>
<span class="sourceLineNo">500</span><a id="line.500"></a>
<span class="sourceLineNo">501</span><a id="line.501">  @Test</a>
<span class="sourceLineNo">502</span><a id="line.502">  public void testIsNotNullPredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">503</span><a id="line.503">    Predicate p = new IsNotNullPredicate&lt;&gt;(PARAM);</a>
<span class="sourceLineNo">504</span><a id="line.504">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">505</span><a id="line.505">    assertEquals("catalognumber IS NOT NULL", query);</a>
<span class="sourceLineNo">506</span><a id="line.506">  }</a>
<span class="sourceLineNo">507</span><a id="line.507"></a>
<span class="sourceLineNo">508</span><a id="line.508">  @Test</a>
<span class="sourceLineNo">509</span><a id="line.509">  public void testIsArrayNotNullPredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">510</span><a id="line.510">    Predicate p = new IsNotNullPredicate&lt;&gt;(OccurrenceSearchParameter.IDENTIFIED_BY_ID);</a>
<span class="sourceLineNo">511</span><a id="line.511">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">512</span><a id="line.512">    assertEquals("(identifiedbyid IS NOT NULL AND size(identifiedbyid) &gt; 0)", query);</a>
<span class="sourceLineNo">513</span><a id="line.513">  }</a>
<span class="sourceLineNo">514</span><a id="line.514"></a>
<span class="sourceLineNo">515</span><a id="line.515">  @Test</a>
<span class="sourceLineNo">516</span><a id="line.516">  public void testIsVocabularyNotNullPredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">517</span><a id="line.517">    Predicate p = new IsNotNullPredicate&lt;&gt;(OccurrenceSearchParameter.LIFE_STAGE);</a>
<span class="sourceLineNo">518</span><a id="line.518">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">519</span><a id="line.519">    assertEquals("(lifestage.lineage IS NOT NULL AND size(lifestage.lineage) &gt; 0)", query);</a>
<span class="sourceLineNo">520</span><a id="line.520">  }</a>
<span class="sourceLineNo">521</span><a id="line.521"></a>
<span class="sourceLineNo">522</span><a id="line.522">  @Test</a>
<span class="sourceLineNo">523</span><a id="line.523">  public void testIsNotNullPredicateGadmGid() throws QueryBuildingException {</a>
<span class="sourceLineNo">524</span><a id="line.524">    Predicate p = new IsNotNullPredicate&lt;&gt;(OccurrenceSearchParameter.GADM_GID);</a>
<span class="sourceLineNo">525</span><a id="line.525">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">526</span><a id="line.526">    assertEquals(</a>
<span class="sourceLineNo">527</span><a id="line.527">        "(level0gid IS NOT NULL AND level1gid IS NOT NULL AND level2gid IS NOT NULL AND level3gid IS NOT NULL)",</a>
<span class="sourceLineNo">528</span><a id="line.528">        query);</a>
<span class="sourceLineNo">529</span><a id="line.529">  }</a>
<span class="sourceLineNo">530</span><a id="line.530"></a>
<span class="sourceLineNo">531</span><a id="line.531">  @Test</a>
<span class="sourceLineNo">532</span><a id="line.532">  public void testIsNullPredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">533</span><a id="line.533">    Predicate p = new IsNullPredicate&lt;&gt;(PARAM);</a>
<span class="sourceLineNo">534</span><a id="line.534">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">535</span><a id="line.535">    assertEquals("catalognumber IS NULL", query);</a>
<span class="sourceLineNo">536</span><a id="line.536">  }</a>
<span class="sourceLineNo">537</span><a id="line.537"></a>
<span class="sourceLineNo">538</span><a id="line.538">  @Test</a>
<span class="sourceLineNo">539</span><a id="line.539">  public void testIsNullPredicateGadmGid() throws QueryBuildingException {</a>
<span class="sourceLineNo">540</span><a id="line.540">    Predicate p = new IsNullPredicate&lt;&gt;(OccurrenceSearchParameter.GADM_GID);</a>
<span class="sourceLineNo">541</span><a id="line.541">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">542</span><a id="line.542">    assertEquals(</a>
<span class="sourceLineNo">543</span><a id="line.543">        "(level0gid IS NULL AND level1gid IS NULL AND level2gid IS NULL AND level3gid IS NULL)",</a>
<span class="sourceLineNo">544</span><a id="line.544">        query);</a>
<span class="sourceLineNo">545</span><a id="line.545">  }</a>
<span class="sourceLineNo">546</span><a id="line.546"></a>
<span class="sourceLineNo">547</span><a id="line.547">  @Test</a>
<span class="sourceLineNo">548</span><a id="line.548">  public void testIsArrayNullPredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">549</span><a id="line.549">    Predicate p = new IsNullPredicate&lt;&gt;(OccurrenceSearchParameter.IDENTIFIED_BY_ID);</a>
<span class="sourceLineNo">550</span><a id="line.550">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">551</span><a id="line.551">    assertEquals("(identifiedbyid IS NULL OR size(identifiedbyid) = 0)", query);</a>
<span class="sourceLineNo">552</span><a id="line.552">  }</a>
<span class="sourceLineNo">553</span><a id="line.553"></a>
<span class="sourceLineNo">554</span><a id="line.554">  @Test</a>
<span class="sourceLineNo">555</span><a id="line.555">  public void testIsVocabularyNullPredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">556</span><a id="line.556">    Predicate p = new IsNullPredicate&lt;&gt;(OccurrenceSearchParameter.LIFE_STAGE);</a>
<span class="sourceLineNo">557</span><a id="line.557">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">558</span><a id="line.558">    assertEquals("lifestage.lineage IS NULL", query);</a>
<span class="sourceLineNo">559</span><a id="line.559">  }</a>
<span class="sourceLineNo">560</span><a id="line.560"></a>
<span class="sourceLineNo">561</span><a id="line.561">  @Test</a>
<span class="sourceLineNo">562</span><a id="line.562">  public void testIsNotNullTaxonKey() throws QueryBuildingException {</a>
<span class="sourceLineNo">563</span><a id="line.563">    Predicate p = new IsNotNullPredicate&lt;&gt;(OccurrenceSearchParameter.TAXON_KEY);</a>
<span class="sourceLineNo">564</span><a id="line.564">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">565</span><a id="line.565">    assertEquals(</a>
<span class="sourceLineNo">566</span><a id="line.566">        "(taxonkey IS NOT NULL AND acceptedtaxonkey IS NOT NULL AND kingdomkey IS NOT NULL AND phylumkey IS NOT NULL AND classkey IS NOT NULL AND orderkey IS NOT NULL AND familykey IS NOT NULL AND genuskey IS NOT NULL AND subgenuskey IS NOT NULL AND specieskey IS NOT NULL)",</a>
<span class="sourceLineNo">567</span><a id="line.567">        query);</a>
<span class="sourceLineNo">568</span><a id="line.568">  }</a>
<span class="sourceLineNo">569</span><a id="line.569"></a>
<span class="sourceLineNo">570</span><a id="line.570">  @Test</a>
<span class="sourceLineNo">571</span><a id="line.571">  public void testIsNullTaxonKey() throws QueryBuildingException {</a>
<span class="sourceLineNo">572</span><a id="line.572">    Predicate p = new IsNullPredicate&lt;&gt;(OccurrenceSearchParameter.TAXON_KEY);</a>
<span class="sourceLineNo">573</span><a id="line.573">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">574</span><a id="line.574">    assertEquals(</a>
<span class="sourceLineNo">575</span><a id="line.575">        "(taxonkey IS NULL AND acceptedtaxonkey IS NULL AND kingdomkey IS NULL AND phylumkey IS NULL AND classkey IS NULL AND orderkey IS NULL AND familykey IS NULL AND genuskey IS NULL AND subgenuskey IS NULL AND specieskey IS NULL)",</a>
<span class="sourceLineNo">576</span><a id="line.576">        query);</a>
<span class="sourceLineNo">577</span><a id="line.577">  }</a>
<span class="sourceLineNo">578</span><a id="line.578"></a>
<span class="sourceLineNo">579</span><a id="line.579">  @Test</a>
<span class="sourceLineNo">580</span><a id="line.580">  public void testIsNotNullArrayPredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">581</span><a id="line.581">    Predicate p = new IsNotNullPredicate&lt;&gt;(OccurrenceSearchParameter.MEDIA_TYPE);</a>
<span class="sourceLineNo">582</span><a id="line.582">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">583</span><a id="line.583">    assertEquals("(mediatype IS NOT NULL AND size(mediatype) &gt; 0)", query);</a>
<span class="sourceLineNo">584</span><a id="line.584">  }</a>
<span class="sourceLineNo">585</span><a id="line.585"></a>
<span class="sourceLineNo">586</span><a id="line.586">  @Test</a>
<span class="sourceLineNo">587</span><a id="line.587">  public void testPartialDates() throws QueryBuildingException {</a>
<span class="sourceLineNo">588</span><a id="line.588">    testPartialDate("2021-10-25T00:00:00Z", "2021-10-26T00:00:00Z", "2021-10-25");</a>
<span class="sourceLineNo">589</span><a id="line.589">    testPartialDate("2014-10-01T00:00:00Z", "2014-11-01T00:00:00Z", "2014-10");</a>
<span class="sourceLineNo">590</span><a id="line.590">    testPartialDate("1936-01-01T00:00:00Z", "1937-01-01T00:00:00Z", "1936");</a>
<span class="sourceLineNo">591</span><a id="line.591">  }</a>
<span class="sourceLineNo">592</span><a id="line.592"></a>
<span class="sourceLineNo">593</span><a id="line.593">  @Test</a>
<span class="sourceLineNo">594</span><a id="line.594">  public void testDateRanges() throws QueryBuildingException {</a>
<span class="sourceLineNo">595</span><a id="line.595">    testPartialDate("2021-10-25T00:00:00Z", "2021-10-26T00:00:00Z", "2021-10-25,2021-10-25");</a>
<span class="sourceLineNo">596</span><a id="line.596">    testPartialDate("2021-10-25T00:00:00Z", "2021-10-27T00:00:00Z", "2021-10-25,2021-10-26");</a>
<span class="sourceLineNo">597</span><a id="line.597">    testPartialDate("2014-05-01T00:00:00Z", "2014-07-01T00:00:00Z", "2014-05,2014-06");</a>
<span class="sourceLineNo">598</span><a id="line.598">    testPartialDate("1936-01-01T00:00:00Z", "1941-01-01T00:00:00Z", "1936,1940");</a>
<span class="sourceLineNo">599</span><a id="line.599">    testPartialDate("1940-01-01T00:00:00Z", null, "1940,*");</a>
<span class="sourceLineNo">600</span><a id="line.600">    testPartialDate(null, "1941-01-01T00:00:00Z", "*,1940");</a>
<span class="sourceLineNo">601</span><a id="line.601">    testPartialDate(null, null, "*,*");</a>
<span class="sourceLineNo">602</span><a id="line.602">  }</a>
<span class="sourceLineNo">603</span><a id="line.603"></a>
<span class="sourceLineNo">604</span><a id="line.604">  @Test</a>
<span class="sourceLineNo">605</span><a id="line.605">  public void testDateComparisons() throws QueryBuildingException {</a>
<span class="sourceLineNo">606</span><a id="line.606">    Predicate p = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.LAST_INTERPRETED, "2000", false);</a>
<span class="sourceLineNo">607</span><a id="line.607">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">608</span><a id="line.608">    assertEquals(</a>
<span class="sourceLineNo">609</span><a id="line.609">        String.format(</a>
<span class="sourceLineNo">610</span><a id="line.610">            "(lastinterpreted &gt;= %s AND lastinterpreted &lt; %s)",</a>
<span class="sourceLineNo">611</span><a id="line.611">            Instant.parse("2000-01-01T00:00:00Z").toEpochMilli(),</a>
<span class="sourceLineNo">612</span><a id="line.612">            Instant.parse("2001-01-01T00:00:00Z").toEpochMilli()),</a>
<span class="sourceLineNo">613</span><a id="line.613">        query);</a>
<span class="sourceLineNo">614</span><a id="line.614"></a>
<span class="sourceLineNo">615</span><a id="line.615">    // Include the range</a>
<span class="sourceLineNo">616</span><a id="line.616">    p = new LessThanOrEqualsPredicate&lt;&gt;(OccurrenceSearchParameter.LAST_INTERPRETED, "2000");</a>
<span class="sourceLineNo">617</span><a id="line.617">    query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">618</span><a id="line.618">    assertEquals(</a>
<span class="sourceLineNo">619</span><a id="line.619">        String.format("lastinterpreted &lt; %s", Instant.parse("2001-01-01T00:00:00Z").toEpochMilli()),</a>
<span class="sourceLineNo">620</span><a id="line.620">        query);</a>
<span class="sourceLineNo">621</span><a id="line.621"></a>
<span class="sourceLineNo">622</span><a id="line.622">    p = new GreaterThanOrEqualsPredicate&lt;&gt;(OccurrenceSearchParameter.LAST_INTERPRETED, "2000");</a>
<span class="sourceLineNo">623</span><a id="line.623">    query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">624</span><a id="line.624">    assertEquals(</a>
<span class="sourceLineNo">625</span><a id="line.625">        String.format(</a>
<span class="sourceLineNo">626</span><a id="line.626">            "lastinterpreted &gt;= %s", Instant.parse("2000-01-01T00:00:00Z").toEpochMilli()),</a>
<span class="sourceLineNo">627</span><a id="line.627">        query);</a>
<span class="sourceLineNo">628</span><a id="line.628"></a>
<span class="sourceLineNo">629</span><a id="line.629">    // Exclude the range</a>
<span class="sourceLineNo">630</span><a id="line.630">    p = new LessThanPredicate&lt;&gt;(OccurrenceSearchParameter.LAST_INTERPRETED, "2000");</a>
<span class="sourceLineNo">631</span><a id="line.631">    query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">632</span><a id="line.632">    assertEquals(</a>
<span class="sourceLineNo">633</span><a id="line.633">        String.format("lastinterpreted &lt; %s", Instant.parse("2000-01-01T00:00:00Z").toEpochMilli()),</a>
<span class="sourceLineNo">634</span><a id="line.634">        query);</a>
<span class="sourceLineNo">635</span><a id="line.635"></a>
<span class="sourceLineNo">636</span><a id="line.636">    p = new GreaterThanPredicate&lt;&gt;(OccurrenceSearchParameter.LAST_INTERPRETED, "2000");</a>
<span class="sourceLineNo">637</span><a id="line.637">    query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">638</span><a id="line.638">    assertEquals(</a>
<span class="sourceLineNo">639</span><a id="line.639">        String.format(</a>
<span class="sourceLineNo">640</span><a id="line.640">            "lastinterpreted &gt;= %s", Instant.parse("2001-01-01T00:00:00Z").toEpochMilli()),</a>
<span class="sourceLineNo">641</span><a id="line.641">        query);</a>
<span class="sourceLineNo">642</span><a id="line.642">  }</a>
<span class="sourceLineNo">643</span><a id="line.643"></a>
<span class="sourceLineNo">644</span><a id="line.644">  @Test</a>
<span class="sourceLineNo">645</span><a id="line.645">  public void testDateRangeComparisons() throws QueryBuildingException {</a>
<span class="sourceLineNo">646</span><a id="line.646">    Predicate p = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.EVENT_DATE, "2000-01-02", false);</a>
<span class="sourceLineNo">647</span><a id="line.647">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">648</span><a id="line.648">    assertEquals(</a>
<span class="sourceLineNo">649</span><a id="line.649">        String.format(</a>
<span class="sourceLineNo">650</span><a id="line.650">            "(eventdategte &gt;= %s AND eventdatelte &lt; %s)",</a>
<span class="sourceLineNo">651</span><a id="line.651">            Instant.parse("2000-01-02T00:00:00Z").getEpochSecond(),</a>
<span class="sourceLineNo">652</span><a id="line.652">            Instant.parse("2000-01-03T00:00:00Z").getEpochSecond()),</a>
<span class="sourceLineNo">653</span><a id="line.653">        query);</a>
<span class="sourceLineNo">654</span><a id="line.654"></a>
<span class="sourceLineNo">655</span><a id="line.655">    p = new InPredicate&lt;&gt;(OccurrenceSearchParameter.EVENT_DATE, Arrays.asList("2000-01-02"), false);</a>
<span class="sourceLineNo">656</span><a id="line.656">    query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">657</span><a id="line.657">    assertEquals(</a>
<span class="sourceLineNo">658</span><a id="line.658">        String.format(</a>
<span class="sourceLineNo">659</span><a id="line.659">            "((eventdategte &gt;= %s AND eventdatelte &lt; %s))",</a>
<span class="sourceLineNo">660</span><a id="line.660">            Instant.parse("2000-01-02T00:00:00Z").getEpochSecond(),</a>
<span class="sourceLineNo">661</span><a id="line.661">            Instant.parse("2000-01-03T00:00:00Z").getEpochSecond()),</a>
<span class="sourceLineNo">662</span><a id="line.662">        query);</a>
<span class="sourceLineNo">663</span><a id="line.663"></a>
<span class="sourceLineNo">664</span><a id="line.664">    p =</a>
<span class="sourceLineNo">665</span><a id="line.665">        new InPredicate&lt;&gt;(</a>
<span class="sourceLineNo">666</span><a id="line.666">            OccurrenceSearchParameter.EVENT_DATE, Arrays.asList("2000-01-02", "2024-01-17"), false);</a>
<span class="sourceLineNo">667</span><a id="line.667">    query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">668</span><a id="line.668">    assertEquals(</a>
<span class="sourceLineNo">669</span><a id="line.669">        String.format(</a>
<span class="sourceLineNo">670</span><a id="line.670">            "((eventdategte &gt;= %s AND eventdatelte &lt; %s) OR (eventdategte &gt;= %s AND eventdatelte &lt; %s))",</a>
<span class="sourceLineNo">671</span><a id="line.671">            Instant.parse("2000-01-02T00:00:00Z").getEpochSecond(),</a>
<span class="sourceLineNo">672</span><a id="line.672">            Instant.parse("2000-01-03T00:00:00Z").getEpochSecond(),</a>
<span class="sourceLineNo">673</span><a id="line.673">            Instant.parse("2024-01-17T00:00:00Z").getEpochSecond(),</a>
<span class="sourceLineNo">674</span><a id="line.674">            Instant.parse("2024-01-18T00:00:00Z").getEpochSecond()),</a>
<span class="sourceLineNo">675</span><a id="line.675">        query);</a>
<span class="sourceLineNo">676</span><a id="line.676"></a>
<span class="sourceLineNo">677</span><a id="line.677">    p = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.EVENT_DATE, "2000-01-02,2000-01-04", false);</a>
<span class="sourceLineNo">678</span><a id="line.678">    query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">679</span><a id="line.679">    assertEquals(</a>
<span class="sourceLineNo">680</span><a id="line.680">        String.format(</a>
<span class="sourceLineNo">681</span><a id="line.681">            "(eventdategte &gt;= %s AND eventdatelte &lt; %s)",</a>
<span class="sourceLineNo">682</span><a id="line.682">            Instant.parse("2000-01-02T00:00:00Z").getEpochSecond(),</a>
<span class="sourceLineNo">683</span><a id="line.683">            Instant.parse("2000-01-05T00:00:00Z").getEpochSecond()),</a>
<span class="sourceLineNo">684</span><a id="line.684">        query);</a>
<span class="sourceLineNo">685</span><a id="line.685"></a>
<span class="sourceLineNo">686</span><a id="line.686">    p = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.EVENT_DATE, "2000-01", false);</a>
<span class="sourceLineNo">687</span><a id="line.687">    query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">688</span><a id="line.688">    assertEquals(</a>
<span class="sourceLineNo">689</span><a id="line.689">        String.format(</a>
<span class="sourceLineNo">690</span><a id="line.690">            "(eventdategte &gt;= %s AND eventdatelte &lt; %s)",</a>
<span class="sourceLineNo">691</span><a id="line.691">            Instant.parse("2000-01-01T00:00:00Z").getEpochSecond(),</a>
<span class="sourceLineNo">692</span><a id="line.692">            Instant.parse("2000-02-01T00:00:00Z").getEpochSecond()),</a>
<span class="sourceLineNo">693</span><a id="line.693">        query);</a>
<span class="sourceLineNo">694</span><a id="line.694"></a>
<span class="sourceLineNo">695</span><a id="line.695">    p = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.EVENT_DATE, "2000-01,2000-03", false);</a>
<span class="sourceLineNo">696</span><a id="line.696">    query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">697</span><a id="line.697">    assertEquals(</a>
<span class="sourceLineNo">698</span><a id="line.698">        String.format(</a>
<span class="sourceLineNo">699</span><a id="line.699">            "(eventdategte &gt;= %s AND eventdatelte &lt; %s)",</a>
<span class="sourceLineNo">700</span><a id="line.700">            Instant.parse("2000-01-01T00:00:00Z").getEpochSecond(),</a>
<span class="sourceLineNo">701</span><a id="line.701">            Instant.parse("2000-04-01T00:00:00Z").getEpochSecond()),</a>
<span class="sourceLineNo">702</span><a id="line.702">        query);</a>
<span class="sourceLineNo">703</span><a id="line.703"></a>
<span class="sourceLineNo">704</span><a id="line.704">    p = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.EVENT_DATE, "2000", false);</a>
<span class="sourceLineNo">705</span><a id="line.705">    query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">706</span><a id="line.706">    assertEquals(</a>
<span class="sourceLineNo">707</span><a id="line.707">        String.format(</a>
<span class="sourceLineNo">708</span><a id="line.708">            "(eventdategte &gt;= %s AND eventdatelte &lt; %s)",</a>
<span class="sourceLineNo">709</span><a id="line.709">            Instant.parse("2000-01-01T00:00:00Z").getEpochSecond(),</a>
<span class="sourceLineNo">710</span><a id="line.710">            Instant.parse("2001-01-01T00:00:00Z").getEpochSecond()),</a>
<span class="sourceLineNo">711</span><a id="line.711">        query);</a>
<span class="sourceLineNo">712</span><a id="line.712"></a>
<span class="sourceLineNo">713</span><a id="line.713">    p = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.EVENT_DATE, "2000,2001", false);</a>
<span class="sourceLineNo">714</span><a id="line.714">    query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">715</span><a id="line.715">    assertEquals(</a>
<span class="sourceLineNo">716</span><a id="line.716">        String.format(</a>
<span class="sourceLineNo">717</span><a id="line.717">            "(eventdategte &gt;= %s AND eventdatelte &lt; %s)",</a>
<span class="sourceLineNo">718</span><a id="line.718">            Instant.parse("2000-01-01T00:00:00Z").getEpochSecond(),</a>
<span class="sourceLineNo">719</span><a id="line.719">            Instant.parse("2002-01-01T00:00:00Z").getEpochSecond()),</a>
<span class="sourceLineNo">720</span><a id="line.720">        query);</a>
<span class="sourceLineNo">721</span><a id="line.721"></a>
<span class="sourceLineNo">722</span><a id="line.722">    // Include the range (for the or-equal-to)</a>
<span class="sourceLineNo">723</span><a id="line.723">    p = new LessThanOrEqualsPredicate&lt;&gt;(OccurrenceSearchParameter.EVENT_DATE, "2000");</a>
<span class="sourceLineNo">724</span><a id="line.724">    query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">725</span><a id="line.725">    assertEquals(</a>
<span class="sourceLineNo">726</span><a id="line.726">        String.format("eventdategte &lt; %s", Instant.parse("2001-01-01T00:00:00Z").getEpochSecond()),</a>
<span class="sourceLineNo">727</span><a id="line.727">        query);</a>
<span class="sourceLineNo">728</span><a id="line.728"></a>
<span class="sourceLineNo">729</span><a id="line.729">    p = new GreaterThanOrEqualsPredicate&lt;&gt;(OccurrenceSearchParameter.EVENT_DATE, "2000");</a>
<span class="sourceLineNo">730</span><a id="line.730">    query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">731</span><a id="line.731">    assertEquals(</a>
<span class="sourceLineNo">732</span><a id="line.732">        String.format("eventdatelte &gt;= %s", Instant.parse("2000-01-01T00:00:00Z").getEpochSecond()),</a>
<span class="sourceLineNo">733</span><a id="line.733">        query);</a>
<span class="sourceLineNo">734</span><a id="line.734"></a>
<span class="sourceLineNo">735</span><a id="line.735">    // Exclude the range</a>
<span class="sourceLineNo">736</span><a id="line.736">    p = new LessThanPredicate&lt;&gt;(OccurrenceSearchParameter.EVENT_DATE, "2000");</a>
<span class="sourceLineNo">737</span><a id="line.737">    query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">738</span><a id="line.738">    assertEquals(</a>
<span class="sourceLineNo">739</span><a id="line.739">        String.format("eventdategte &lt; %s", Instant.parse("2000-01-01T00:00:00Z").getEpochSecond()),</a>
<span class="sourceLineNo">740</span><a id="line.740">        query);</a>
<span class="sourceLineNo">741</span><a id="line.741"></a>
<span class="sourceLineNo">742</span><a id="line.742">    p = new GreaterThanPredicate&lt;&gt;(OccurrenceSearchParameter.EVENT_DATE, "2000");</a>
<span class="sourceLineNo">743</span><a id="line.743">    query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">744</span><a id="line.744">    assertEquals(</a>
<span class="sourceLineNo">745</span><a id="line.745">        String.format("eventdatelte &gt;= %s", Instant.parse("2001-01-01T00:00:00Z").getEpochSecond()),</a>
<span class="sourceLineNo">746</span><a id="line.746">        query);</a>
<span class="sourceLineNo">747</span><a id="line.747">  }</a>
<span class="sourceLineNo">748</span><a id="line.748"></a>
<span class="sourceLineNo">749</span><a id="line.749">  /** Reusable method to test partial dates, i.e., dates with the format: yyyy, yyyy-MM. */</a>
<span class="sourceLineNo">750</span><a id="line.750">  private void testPartialDate(String expectedFrom, String expectedTo, String value)</a>
<span class="sourceLineNo">751</span><a id="line.751">      throws QueryBuildingException {</a>
<span class="sourceLineNo">752</span><a id="line.752">    Range&lt;Instant&gt; range =</a>
<span class="sourceLineNo">753</span><a id="line.753">        Range.closed(</a>
<span class="sourceLineNo">754</span><a id="line.754">            expectedFrom == null ? null : Instant.parse(expectedFrom),</a>
<span class="sourceLineNo">755</span><a id="line.755">            expectedTo == null ? null : Instant.parse(expectedTo));</a>
<span class="sourceLineNo">756</span><a id="line.756"></a>
<span class="sourceLineNo">757</span><a id="line.757">    Predicate p = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.LAST_INTERPRETED, value, false);</a>
<span class="sourceLineNo">758</span><a id="line.758">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">759</span><a id="line.759"></a>
<span class="sourceLineNo">760</span><a id="line.760">    if (!range.hasUpperBound() &amp;&amp; !range.hasLowerBound()) {</a>
<span class="sourceLineNo">761</span><a id="line.761">      assertEquals("", query);</a>
<span class="sourceLineNo">762</span><a id="line.762">    } else if (!range.hasUpperBound()) {</a>
<span class="sourceLineNo">763</span><a id="line.763">      assertEquals(</a>
<span class="sourceLineNo">764</span><a id="line.764">          String.format("(lastinterpreted &gt;= %s)", range.lowerEndpoint().toEpochMilli()), query);</a>
<span class="sourceLineNo">765</span><a id="line.765">    } else if (!range.hasLowerBound()) {</a>
<span class="sourceLineNo">766</span><a id="line.766">      assertEquals(</a>
<span class="sourceLineNo">767</span><a id="line.767">          String.format("(lastinterpreted &lt; %s)", range.upperEndpoint().toEpochMilli()), query);</a>
<span class="sourceLineNo">768</span><a id="line.768">    } else {</a>
<span class="sourceLineNo">769</span><a id="line.769">      assertEquals(</a>
<span class="sourceLineNo">770</span><a id="line.770">          String.format(</a>
<span class="sourceLineNo">771</span><a id="line.771">              "(lastinterpreted &gt;= %s AND lastinterpreted &lt; %s)",</a>
<span class="sourceLineNo">772</span><a id="line.772">              range.lowerEndpoint().toEpochMilli(), range.upperEndpoint().toEpochMilli()),</a>
<span class="sourceLineNo">773</span><a id="line.773">          query);</a>
<span class="sourceLineNo">774</span><a id="line.774">    }</a>
<span class="sourceLineNo">775</span><a id="line.775">  }</a>
<span class="sourceLineNo">776</span><a id="line.776"></a>
<span class="sourceLineNo">777</span><a id="line.777">  /** Some dates in HDFS are a number of seconds, others a number of milliseconds. */</a>
<span class="sourceLineNo">778</span><a id="line.778">  @Test</a>
<span class="sourceLineNo">779</span><a id="line.779">  public void testDateMagnitude() throws QueryBuildingException {</a>
<span class="sourceLineNo">780</span><a id="line.780">    Predicate p = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.EVENT_DATE, "2000-01-02", false);</a>
<span class="sourceLineNo">781</span><a id="line.781">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">782</span><a id="line.782">    assertEquals(</a>
<span class="sourceLineNo">783</span><a id="line.783">        String.format(</a>
<span class="sourceLineNo">784</span><a id="line.784">            "(eventdategte &gt;= %s AND eventdatelte &lt; %s)",</a>
<span class="sourceLineNo">785</span><a id="line.785">            Instant.parse("2000-01-02T00:00:00Z").getEpochSecond(),</a>
<span class="sourceLineNo">786</span><a id="line.786">            Instant.parse("2000-01-03T00:00:00Z").getEpochSecond()),</a>
<span class="sourceLineNo">787</span><a id="line.787">        query);</a>
<span class="sourceLineNo">788</span><a id="line.788"></a>
<span class="sourceLineNo">789</span><a id="line.789">    p = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.LAST_INTERPRETED, "2000-01-02", false);</a>
<span class="sourceLineNo">790</span><a id="line.790">    query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">791</span><a id="line.791">    assertEquals(</a>
<span class="sourceLineNo">792</span><a id="line.792">        String.format(</a>
<span class="sourceLineNo">793</span><a id="line.793">            "(lastinterpreted &gt;= %s AND lastinterpreted &lt; %s)",</a>
<span class="sourceLineNo">794</span><a id="line.794">            Instant.parse("2000-01-02T00:00:00Z").toEpochMilli(),</a>
<span class="sourceLineNo">795</span><a id="line.795">            Instant.parse("2000-01-03T00:00:00Z").toEpochMilli()),</a>
<span class="sourceLineNo">796</span><a id="line.796">        query);</a>
<span class="sourceLineNo">797</span><a id="line.797"></a>
<span class="sourceLineNo">798</span><a id="line.798">    p = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.MODIFIED, "2000-01-02", false);</a>
<span class="sourceLineNo">799</span><a id="line.799">    query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">800</span><a id="line.800">    assertEquals(</a>
<span class="sourceLineNo">801</span><a id="line.801">        String.format(</a>
<span class="sourceLineNo">802</span><a id="line.802">            "(modified &gt;= %s AND modified &lt; %s)",</a>
<span class="sourceLineNo">803</span><a id="line.803">            Instant.parse("2000-01-02T00:00:00Z").getEpochSecond(),</a>
<span class="sourceLineNo">804</span><a id="line.804">            Instant.parse("2000-01-03T00:00:00Z").getEpochSecond()),</a>
<span class="sourceLineNo">805</span><a id="line.805">        query);</a>
<span class="sourceLineNo">806</span><a id="line.806">  }</a>
<span class="sourceLineNo">807</span><a id="line.807"></a>
<span class="sourceLineNo">808</span><a id="line.808">  @Test</a>
<span class="sourceLineNo">809</span><a id="line.809">  public void testIntRanges() throws QueryBuildingException {</a>
<span class="sourceLineNo">810</span><a id="line.810"></a>
<span class="sourceLineNo">811</span><a id="line.811">    String value = "1990,2011";</a>
<span class="sourceLineNo">812</span><a id="line.812">    Range&lt;Integer&gt; range = SearchTypeValidator.parseIntegerRange(value);</a>
<span class="sourceLineNo">813</span><a id="line.813"></a>
<span class="sourceLineNo">814</span><a id="line.814">    Predicate p = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.YEAR, value, false);</a>
<span class="sourceLineNo">815</span><a id="line.815">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">816</span><a id="line.816"></a>
<span class="sourceLineNo">817</span><a id="line.817">    if (!range.hasUpperBound()) {</a>
<span class="sourceLineNo">818</span><a id="line.818">      assertEquals(String.format("year &gt;= %s", range.lowerEndpoint().intValue()), query);</a>
<span class="sourceLineNo">819</span><a id="line.819">    } else if (!range.hasLowerBound()) {</a>
<span class="sourceLineNo">820</span><a id="line.820">      assertEquals(String.format("year &lt;= %s", range.upperEndpoint().intValue()), query);</a>
<span class="sourceLineNo">821</span><a id="line.821">    } else {</a>
<span class="sourceLineNo">822</span><a id="line.822">      assertEquals(</a>
<span class="sourceLineNo">823</span><a id="line.823">          String.format(</a>
<span class="sourceLineNo">824</span><a id="line.824">              "((year &gt;= %s) AND (year &lt;= %s))",</a>
<span class="sourceLineNo">825</span><a id="line.825">              range.lowerEndpoint().intValue(), range.upperEndpoint().intValue()),</a>
<span class="sourceLineNo">826</span><a id="line.826">          query);</a>
<span class="sourceLineNo">827</span><a id="line.827">    }</a>
<span class="sourceLineNo">828</span><a id="line.828">  }</a>
<span class="sourceLineNo">829</span><a id="line.829"></a>
<span class="sourceLineNo">830</span><a id="line.830">  @Test</a>
<span class="sourceLineNo">831</span><a id="line.831">  public void testIntInclusiveRangeWithRangePredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">832</span><a id="line.832"></a>
<span class="sourceLineNo">833</span><a id="line.833">    RangeValue rangeValue = new RangeValue("1990", null, "2011", null);</a>
<span class="sourceLineNo">834</span><a id="line.834">    Predicate p = new RangePredicate(OccurrenceSearchParameter.YEAR, rangeValue);</a>
<span class="sourceLineNo">835</span><a id="line.835">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">836</span><a id="line.836">    assertEquals(</a>
<span class="sourceLineNo">837</span><a id="line.837">        String.format(</a>
<span class="sourceLineNo">838</span><a id="line.838">            "((year &gt;= %1$s) AND (year &lt;= %2$s))",</a>
<span class="sourceLineNo">839</span><a id="line.839">            Integer.parseInt(rangeValue.getGte()), Integer.parseInt(rangeValue.getLte())),</a>
<span class="sourceLineNo">840</span><a id="line.840">        query);</a>
<span class="sourceLineNo">841</span><a id="line.841">  }</a>
<span class="sourceLineNo">842</span><a id="line.842"></a>
<span class="sourceLineNo">843</span><a id="line.843">  @Test</a>
<span class="sourceLineNo">844</span><a id="line.844">  public void testIntExclusiveRangeWithRangePredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">845</span><a id="line.845"></a>
<span class="sourceLineNo">846</span><a id="line.846">    RangeValue rangeValue = new RangeValue(null, "1990", null, "2011");</a>
<span class="sourceLineNo">847</span><a id="line.847">    Predicate p = new RangePredicate(OccurrenceSearchParameter.YEAR, rangeValue);</a>
<span class="sourceLineNo">848</span><a id="line.848">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">849</span><a id="line.849">    assertEquals(</a>
<span class="sourceLineNo">850</span><a id="line.850">        String.format(</a>
<span class="sourceLineNo">851</span><a id="line.851">            "((year &gt; %1$s) AND (year &lt; %2$s))",</a>
<span class="sourceLineNo">852</span><a id="line.852">            Integer.parseInt(rangeValue.getGt()), Integer.parseInt(rangeValue.getLt())),</a>
<span class="sourceLineNo">853</span><a id="line.853">        query);</a>
<span class="sourceLineNo">854</span><a id="line.854">  }</a>
<span class="sourceLineNo">855</span><a id="line.855"></a>
<span class="sourceLineNo">856</span><a id="line.856">  @Test</a>
<span class="sourceLineNo">857</span><a id="line.857">  public void testInclusiveExclusiveRangeWithRangePredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">858</span><a id="line.858"></a>
<span class="sourceLineNo">859</span><a id="line.859">    RangeValue rangeValue = new RangeValue("1990", null, null, "2011");</a>
<span class="sourceLineNo">860</span><a id="line.860">    Predicate p = new RangePredicate(OccurrenceSearchParameter.YEAR, rangeValue);</a>
<span class="sourceLineNo">861</span><a id="line.861">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">862</span><a id="line.862">    assertEquals(</a>
<span class="sourceLineNo">863</span><a id="line.863">        String.format(</a>
<span class="sourceLineNo">864</span><a id="line.864">            "((year &gt;= %1$s) AND (year &lt; %2$s))",</a>
<span class="sourceLineNo">865</span><a id="line.865">            Integer.parseInt(rangeValue.getGte()), Integer.parseInt(rangeValue.getLt())),</a>
<span class="sourceLineNo">866</span><a id="line.866">        query);</a>
<span class="sourceLineNo">867</span><a id="line.867">  }</a>
<span class="sourceLineNo">868</span><a id="line.868"></a>
<span class="sourceLineNo">869</span><a id="line.869">  @Test</a>
<span class="sourceLineNo">870</span><a id="line.870">  public void testExclusiveInclusiveRangeWithRangePredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">871</span><a id="line.871"></a>
<span class="sourceLineNo">872</span><a id="line.872">    RangeValue rangeValue = new RangeValue(null, "1990", "2011", null);</a>
<span class="sourceLineNo">873</span><a id="line.873">    Predicate p = new RangePredicate(OccurrenceSearchParameter.YEAR, rangeValue);</a>
<span class="sourceLineNo">874</span><a id="line.874">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">875</span><a id="line.875">    assertEquals(</a>
<span class="sourceLineNo">876</span><a id="line.876">        String.format(</a>
<span class="sourceLineNo">877</span><a id="line.877">            "((year &gt; %1$s) AND (year &lt;= %2$s))",</a>
<span class="sourceLineNo">878</span><a id="line.878">            Integer.parseInt(rangeValue.getGt()), Integer.parseInt(rangeValue.getLte())),</a>
<span class="sourceLineNo">879</span><a id="line.879">        query);</a>
<span class="sourceLineNo">880</span><a id="line.880">  }</a>
<span class="sourceLineNo">881</span><a id="line.881"></a>
<span class="sourceLineNo">882</span><a id="line.882">  @Test</a>
<span class="sourceLineNo">883</span><a id="line.883">  public void testDoubleRanges() throws QueryBuildingException {</a>
<span class="sourceLineNo">884</span><a id="line.884">    testDoubleRange("-200,600.2");</a>
<span class="sourceLineNo">885</span><a id="line.885">    testDoubleRange("*,300.3");</a>
<span class="sourceLineNo">886</span><a id="line.886">    testDoubleRange("-23.8,*");</a>
<span class="sourceLineNo">887</span><a id="line.887">  }</a>
<span class="sourceLineNo">888</span><a id="line.888"></a>
<span class="sourceLineNo">889</span><a id="line.889">  /** Reusable method to test number ranges. */</a>
<span class="sourceLineNo">890</span><a id="line.890">  private void testDoubleRange(String value) throws QueryBuildingException {</a>
<span class="sourceLineNo">891</span><a id="line.891">    Range&lt;Double&gt; range = SearchTypeValidator.parseDecimalRange(value);</a>
<span class="sourceLineNo">892</span><a id="line.892"></a>
<span class="sourceLineNo">893</span><a id="line.893">    Predicate p = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.ELEVATION, value, false);</a>
<span class="sourceLineNo">894</span><a id="line.894">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">895</span><a id="line.895"></a>
<span class="sourceLineNo">896</span><a id="line.896">    if (!range.hasUpperBound()) {</a>
<span class="sourceLineNo">897</span><a id="line.897">      assertEquals(String.format("elevation &gt;= %s", range.lowerEndpoint().doubleValue()), query);</a>
<span class="sourceLineNo">898</span><a id="line.898">    } else if (!range.hasLowerBound()) {</a>
<span class="sourceLineNo">899</span><a id="line.899">      assertEquals(String.format("elevation &lt;= %s", range.upperEndpoint().doubleValue()), query);</a>
<span class="sourceLineNo">900</span><a id="line.900">    } else {</a>
<span class="sourceLineNo">901</span><a id="line.901">      assertEquals(</a>
<span class="sourceLineNo">902</span><a id="line.902">          String.format(</a>
<span class="sourceLineNo">903</span><a id="line.903">              "((elevation &gt;= %s) AND (elevation &lt;= %s))",</a>
<span class="sourceLineNo">904</span><a id="line.904">              range.lowerEndpoint().doubleValue(), range.upperEndpoint().doubleValue()),</a>
<span class="sourceLineNo">905</span><a id="line.905">          query);</a>
<span class="sourceLineNo">906</span><a id="line.906">    }</a>
<span class="sourceLineNo">907</span><a id="line.907">  }</a>
<span class="sourceLineNo">908</span><a id="line.908"></a>
<span class="sourceLineNo">909</span><a id="line.909">  @Test</a>
<span class="sourceLineNo">910</span><a id="line.910">  public void testIntegerRanges() throws QueryBuildingException {</a>
<span class="sourceLineNo">911</span><a id="line.911">    testIntegerRange("1950,1960");</a>
<span class="sourceLineNo">912</span><a id="line.912">    testIntegerRange("*,2000");</a>
<span class="sourceLineNo">913</span><a id="line.913">    testIntegerRange("2000,*");</a>
<span class="sourceLineNo">914</span><a id="line.914">  }</a>
<span class="sourceLineNo">915</span><a id="line.915"></a>
<span class="sourceLineNo">916</span><a id="line.916">  /** Reusable method to test number ranges. */</a>
<span class="sourceLineNo">917</span><a id="line.917">  private void testIntegerRange(String value) throws QueryBuildingException {</a>
<span class="sourceLineNo">918</span><a id="line.918">    Range&lt;Integer&gt; range = SearchTypeValidator.parseIntegerRange(value);</a>
<span class="sourceLineNo">919</span><a id="line.919"></a>
<span class="sourceLineNo">920</span><a id="line.920">    Predicate p = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.YEAR, value, false);</a>
<span class="sourceLineNo">921</span><a id="line.921">    String query = visitor.buildQuery(p);</a>
<span class="sourceLineNo">922</span><a id="line.922"></a>
<span class="sourceLineNo">923</span><a id="line.923">    if (!range.hasUpperBound()) {</a>
<span class="sourceLineNo">924</span><a id="line.924">      assertEquals(String.format("year &gt;= %s", range.lowerEndpoint().intValue()), query);</a>
<span class="sourceLineNo">925</span><a id="line.925">    } else if (!range.hasLowerBound()) {</a>
<span class="sourceLineNo">926</span><a id="line.926">      assertEquals(String.format("year &lt;= %s", range.upperEndpoint().intValue()), query);</a>
<span class="sourceLineNo">927</span><a id="line.927">    } else {</a>
<span class="sourceLineNo">928</span><a id="line.928">      assertEquals(</a>
<span class="sourceLineNo">929</span><a id="line.929">          String.format(</a>
<span class="sourceLineNo">930</span><a id="line.930">              "((year &gt;= %s) AND (year &lt;= %s))",</a>
<span class="sourceLineNo">931</span><a id="line.931">              range.lowerEndpoint().intValue(), range.upperEndpoint().intValue()),</a>
<span class="sourceLineNo">932</span><a id="line.932">          query);</a>
<span class="sourceLineNo">933</span><a id="line.933">    }</a>
<span class="sourceLineNo">934</span><a id="line.934">  }</a>
<span class="sourceLineNo">935</span><a id="line.935"></a>
<span class="sourceLineNo">936</span><a id="line.936">  @Test</a>
<span class="sourceLineNo">937</span><a id="line.937">  public void testIssues() throws QueryBuildingException {</a>
<span class="sourceLineNo">938</span><a id="line.938">    // EqualsPredicate</a>
<span class="sourceLineNo">939</span><a id="line.939">    String query =</a>
<span class="sourceLineNo">940</span><a id="line.940">        visitor.buildQuery(</a>
<span class="sourceLineNo">941</span><a id="line.941">            new EqualsPredicate&lt;&gt;(</a>
<span class="sourceLineNo">942</span><a id="line.942">                OccurrenceSearchParameter.ISSUE, "TAXON_MATCH_HIGHERRANK", false));</a>
<span class="sourceLineNo">943</span><a id="line.943">    assertEquals("stringArrayContains(issue,'TAXON_MATCH_HIGHERRANK',true)", query);</a>
<span class="sourceLineNo">944</span><a id="line.944"></a>
<span class="sourceLineNo">945</span><a id="line.945">    // InPredicate</a>
<span class="sourceLineNo">946</span><a id="line.946">    query =</a>
<span class="sourceLineNo">947</span><a id="line.947">        visitor.buildQuery(</a>
<span class="sourceLineNo">948</span><a id="line.948">            new InPredicate&lt;&gt;(</a>
<span class="sourceLineNo">949</span><a id="line.949">                OccurrenceSearchParameter.ISSUE,</a>
<span class="sourceLineNo">950</span><a id="line.950">                Lists.newArrayList("TAXON_MATCH_HIGHERRANK", "TAXON_MATCH_NONE"),</a>
<span class="sourceLineNo">951</span><a id="line.951">                false));</a>
<span class="sourceLineNo">952</span><a id="line.952">    assertEquals(</a>
<span class="sourceLineNo">953</span><a id="line.953">        "(stringArrayContains(issue,'TAXON_MATCH_HIGHERRANK',true) OR stringArrayContains(issue,'TAXON_MATCH_NONE',true))",</a>
<span class="sourceLineNo">954</span><a id="line.954">        query);</a>
<span class="sourceLineNo">955</span><a id="line.955"></a>
<span class="sourceLineNo">956</span><a id="line.956">    // LikePredicate</a>
<span class="sourceLineNo">957</span><a id="line.957">    try {</a>
<span class="sourceLineNo">958</span><a id="line.958">      new LikePredicate&lt;&gt;(OccurrenceSearchParameter.ISSUE, "TAXON_MATCH_HIGHERRANK", false);</a>
<span class="sourceLineNo">959</span><a id="line.959">      fail();</a>
<span class="sourceLineNo">960</span><a id="line.960">    } catch (IllegalArgumentException e) {</a>
<span class="sourceLineNo">961</span><a id="line.961">    }</a>
<span class="sourceLineNo">962</span><a id="line.962"></a>
<span class="sourceLineNo">963</span><a id="line.963">    // Not</a>
<span class="sourceLineNo">964</span><a id="line.964">    query =</a>
<span class="sourceLineNo">965</span><a id="line.965">        visitor.buildQuery(</a>
<span class="sourceLineNo">966</span><a id="line.966">            new NotPredicate(</a>
<span class="sourceLineNo">967</span><a id="line.967">                new EqualsPredicate&lt;&gt;(</a>
<span class="sourceLineNo">968</span><a id="line.968">                    OccurrenceSearchParameter.ISSUE, "TAXON_MATCH_HIGHERRANK", false)));</a>
<span class="sourceLineNo">969</span><a id="line.969">    assertEquals("NOT stringArrayContains(issue,'TAXON_MATCH_HIGHERRANK',true)", query);</a>
<span class="sourceLineNo">970</span><a id="line.970"></a>
<span class="sourceLineNo">971</span><a id="line.971">    // Not disjunction</a>
<span class="sourceLineNo">972</span><a id="line.972">    query =</a>
<span class="sourceLineNo">973</span><a id="line.973">        visitor.buildQuery(</a>
<span class="sourceLineNo">974</span><a id="line.974">            new NotPredicate(</a>
<span class="sourceLineNo">975</span><a id="line.975">                new DisjunctionPredicate(</a>
<span class="sourceLineNo">976</span><a id="line.976">                    Lists.newArrayList(</a>
<span class="sourceLineNo">977</span><a id="line.977">                        new EqualsPredicate&lt;&gt;(</a>
<span class="sourceLineNo">978</span><a id="line.978">                            OccurrenceSearchParameter.ISSUE, "COORDINATE_INVALID", false),</a>
<span class="sourceLineNo">979</span><a id="line.979">                        new EqualsPredicate&lt;&gt;(</a>
<span class="sourceLineNo">980</span><a id="line.980">                            OccurrenceSearchParameter.ISSUE, "COORDINATE_OUT_OF_RANGE", false),</a>
<span class="sourceLineNo">981</span><a id="line.981">                        new EqualsPredicate&lt;&gt;(</a>
<span class="sourceLineNo">982</span><a id="line.982">                            OccurrenceSearchParameter.ISSUE, "ZERO_COORDINATE", false),</a>
<span class="sourceLineNo">983</span><a id="line.983">                        new EqualsPredicate&lt;&gt;(</a>
<span class="sourceLineNo">984</span><a id="line.984">                            OccurrenceSearchParameter.ISSUE, "RECORDED_DATE_INVALID", false)))));</a>
<span class="sourceLineNo">985</span><a id="line.985">    assertEquals(</a>
<span class="sourceLineNo">986</span><a id="line.986">        "NOT (stringArrayContains(issue,'COORDINATE_INVALID',true) OR stringArrayContains(issue,'COORDINATE_OUT_OF_RANGE',true) OR stringArrayContains(issue,'ZERO_COORDINATE',true) OR stringArrayContains(issue,'RECORDED_DATE_INVALID',true))",</a>
<span class="sourceLineNo">987</span><a id="line.987">        query);</a>
<span class="sourceLineNo">988</span><a id="line.988"></a>
<span class="sourceLineNo">989</span><a id="line.989">    // IsNotNull</a>
<span class="sourceLineNo">990</span><a id="line.990">    query = visitor.buildQuery(new IsNotNullPredicate&lt;&gt;(OccurrenceSearchParameter.ISSUE));</a>
<span class="sourceLineNo">991</span><a id="line.991">    assertEquals("(issue IS NOT NULL AND size(issue) &gt; 0)", query);</a>
<span class="sourceLineNo">992</span><a id="line.992">  }</a>
<span class="sourceLineNo">993</span><a id="line.993"></a>
<span class="sourceLineNo">994</span><a id="line.994">  @Test</a>
<span class="sourceLineNo">995</span><a id="line.995">  public void testAllParamsExist() {</a>
<span class="sourceLineNo">996</span><a id="line.996">    List&lt;Predicate&gt; predicates = Lists.newArrayList();</a>
<span class="sourceLineNo">997</span><a id="line.997">    for (OccurrenceSearchParameter param : OccurrenceSearchParameter.values()) {</a>
<span class="sourceLineNo">998</span><a id="line.998">      String value = "7";</a>
<span class="sourceLineNo">999</span><a id="line.999"></a>
<span class="sourceLineNo">1000</span><a id="line.1000">      if (OccurrenceSearchParameter.GEOMETRY == param) {</a>
<span class="sourceLineNo">1001</span><a id="line.1001">        value = "POLYGON ((30 10, 10 20, 20 40, 40 40, 30 10))";</a>
<span class="sourceLineNo">1002</span><a id="line.1002">        predicates.add(new WithinPredicate(value));</a>
<span class="sourceLineNo">1003</span><a id="line.1003">      } else if (UUID.class.isAssignableFrom(param.type())) {</a>
<span class="sourceLineNo">1004</span><a id="line.1004">        value = UUID.randomUUID().toString();</a>
<span class="sourceLineNo">1005</span><a id="line.1005">      } else if (Boolean.class.isAssignableFrom(param.type())) {</a>
<span class="sourceLineNo">1006</span><a id="line.1006">        value = "true";</a>
<span class="sourceLineNo">1007</span><a id="line.1007">      } else if (Country.class.isAssignableFrom(param.type())) {</a>
<span class="sourceLineNo">1008</span><a id="line.1008">        value = Country.GERMANY.getIso2LetterCode();</a>
<span class="sourceLineNo">1009</span><a id="line.1009">      } else if (Language.class.isAssignableFrom(param.type())) {</a>
<span class="sourceLineNo">1010</span><a id="line.1010">        value = Language.GERMAN.getIso2LetterCode();</a>
<span class="sourceLineNo">1011</span><a id="line.1011">      } else if (Enum.class.isAssignableFrom(param.type())) {</a>
<span class="sourceLineNo">1012</span><a id="line.1012">        Enum&lt;?&gt;[] values = ((Class&lt;Enum&gt;) param.type()).getEnumConstants();</a>
<span class="sourceLineNo">1013</span><a id="line.1013">        value = values[0].name();</a>
<span class="sourceLineNo">1014</span><a id="line.1014">      } else if (Date.class.isAssignableFrom(param.type())) {</a>
<span class="sourceLineNo">1015</span><a id="line.1015">        value = "2014-01-23";</a>
<span class="sourceLineNo">1016</span><a id="line.1016">      } else if (IsoDateInterval.class.isAssignableFrom(param.type())) {</a>
<span class="sourceLineNo">1017</span><a id="line.1017">        value = "2014-01-23,2015-05";</a>
<span class="sourceLineNo">1018</span><a id="line.1018">      } else if (OccurrenceSearchParameter.GEO_DISTANCE == param) {</a>
<span class="sourceLineNo">1019</span><a id="line.1019">        predicates.add(new GeoDistancePredicate("10", "20", "10km"));</a>
<span class="sourceLineNo">1020</span><a id="line.1020">      }</a>
<span class="sourceLineNo">1021</span><a id="line.1021"></a>
<span class="sourceLineNo">1022</span><a id="line.1022">      if (OccurrenceSearchParameter.GEOMETRY != param</a>
<span class="sourceLineNo">1023</span><a id="line.1023">          &amp;&amp; OccurrenceSearchParameter.GEO_DISTANCE != param) {</a>
<span class="sourceLineNo">1024</span><a id="line.1024">        predicates.add(new EqualsPredicate&lt;&gt;(param, value, false));</a>
<span class="sourceLineNo">1025</span><a id="line.1025">      }</a>
<span class="sourceLineNo">1026</span><a id="line.1026">    }</a>
<span class="sourceLineNo">1027</span><a id="line.1027">    ConjunctionPredicate and = new ConjunctionPredicate(predicates);</a>
<span class="sourceLineNo">1028</span><a id="line.1028">    try {</a>
<span class="sourceLineNo">1029</span><a id="line.1029">      visitor.buildQuery(and);</a>
<span class="sourceLineNo">1030</span><a id="line.1030">    } catch (QueryBuildingException e) {</a>
<span class="sourceLineNo">1031</span><a id="line.1031">      fail(e);</a>
<span class="sourceLineNo">1032</span><a id="line.1032">    }</a>
<span class="sourceLineNo">1033</span><a id="line.1033">  }</a>
<span class="sourceLineNo">1034</span><a id="line.1034"></a>
<span class="sourceLineNo">1035</span><a id="line.1035">  @Test</a>
<span class="sourceLineNo">1036</span><a id="line.1036">  public void testVocabularies() {</a>
<span class="sourceLineNo">1037</span><a id="line.1037">    Arrays.stream(OccurrenceSearchParameter.values())</a>
<span class="sourceLineNo">1038</span><a id="line.1038">        .filter(</a>
<span class="sourceLineNo">1039</span><a id="line.1039">            p -&gt;</a>
<span class="sourceLineNo">1040</span><a id="line.1040">                Optional.ofNullable(visitor.term(p))</a>
<span class="sourceLineNo">1041</span><a id="line.1041">                    .map(SQLColumnsUtils::isVocabulary)</a>
<span class="sourceLineNo">1042</span><a id="line.1042">                    .orElse(false))</a>
<span class="sourceLineNo">1043</span><a id="line.1043">        .forEach(</a>
<span class="sourceLineNo">1044</span><a id="line.1044">            param -&gt; {</a>
<span class="sourceLineNo">1045</span><a id="line.1045">              try {</a>
<span class="sourceLineNo">1046</span><a id="line.1046">                String hiveQueryField = SQLColumnsUtils.getSQLQueryColumn(visitor.term(param));</a>
<span class="sourceLineNo">1047</span><a id="line.1047"></a>
<span class="sourceLineNo">1048</span><a id="line.1048">                // EqualsPredicate</a>
<span class="sourceLineNo">1049</span><a id="line.1049">                String query = visitor.buildQuery(new EqualsPredicate&lt;&gt;(param, "value_1", false));</a>
<span class="sourceLineNo">1050</span><a id="line.1050">                assertEquals("stringArrayContains(" + hiveQueryField + ",'value_1',false)", query);</a>
<span class="sourceLineNo">1051</span><a id="line.1051"></a>
<span class="sourceLineNo">1052</span><a id="line.1052">                // InPredicate</a>
<span class="sourceLineNo">1053</span><a id="line.1053">                query =</a>
<span class="sourceLineNo">1054</span><a id="line.1054">                    visitor.buildQuery(</a>
<span class="sourceLineNo">1055</span><a id="line.1055">                        new InPredicate&lt;&gt;(param, Lists.newArrayList("value_1", "value_2"), false));</a>
<span class="sourceLineNo">1056</span><a id="line.1056">                assertEquals(</a>
<span class="sourceLineNo">1057</span><a id="line.1057">                    "(stringArrayContains("</a>
<span class="sourceLineNo">1058</span><a id="line.1058">                        + hiveQueryField</a>
<span class="sourceLineNo">1059</span><a id="line.1059">                        + ",'value_1',false) OR stringArrayContains("</a>
<span class="sourceLineNo">1060</span><a id="line.1060">                        + hiveQueryField</a>
<span class="sourceLineNo">1061</span><a id="line.1061">                        + ",'value_2',false))",</a>
<span class="sourceLineNo">1062</span><a id="line.1062">                    query);</a>
<span class="sourceLineNo">1063</span><a id="line.1063"></a>
<span class="sourceLineNo">1064</span><a id="line.1064">                // LikePredicate</a>
<span class="sourceLineNo">1065</span><a id="line.1065">                query = visitor.buildQuery(new LikePredicate&lt;&gt;(param, "value_*", false));</a>
<span class="sourceLineNo">1066</span><a id="line.1066">                assertEquals("lower(" + hiveQueryField + ") LIKE lower('value\\_%')", query);</a>
<span class="sourceLineNo">1067</span><a id="line.1067"></a>
<span class="sourceLineNo">1068</span><a id="line.1068">                // Not</a>
<span class="sourceLineNo">1069</span><a id="line.1069">                query =</a>
<span class="sourceLineNo">1070</span><a id="line.1070">                    visitor.buildQuery(</a>
<span class="sourceLineNo">1071</span><a id="line.1071">                        new NotPredicate(new EqualsPredicate&lt;&gt;(param, "value_1", false)));</a>
<span class="sourceLineNo">1072</span><a id="line.1072">                assertEquals(</a>
<span class="sourceLineNo">1073</span><a id="line.1073">                    "NOT stringArrayContains(" + hiveQueryField + ",'value_1',false)", query);</a>
<span class="sourceLineNo">1074</span><a id="line.1074"></a>
<span class="sourceLineNo">1075</span><a id="line.1075">                // IsNotNull</a>
<span class="sourceLineNo">1076</span><a id="line.1076">                query = visitor.buildQuery(new IsNotNullPredicate&lt;&gt;(param));</a>
<span class="sourceLineNo">1077</span><a id="line.1077">                assertEquals(</a>
<span class="sourceLineNo">1078</span><a id="line.1078">                    "(" + hiveQueryField + " IS NOT NULL AND size(" + hiveQueryField + ") &gt; 0)",</a>
<span class="sourceLineNo">1079</span><a id="line.1079">                    query);</a>
<span class="sourceLineNo">1080</span><a id="line.1080"></a>
<span class="sourceLineNo">1081</span><a id="line.1081">                // IsNull</a>
<span class="sourceLineNo">1082</span><a id="line.1082">                query = visitor.buildQuery(new IsNullPredicate&lt;&gt;(param));</a>
<span class="sourceLineNo">1083</span><a id="line.1083">                if (visitor.isSQLArray(param)) {</a>
<span class="sourceLineNo">1084</span><a id="line.1084">                  assertEquals(</a>
<span class="sourceLineNo">1085</span><a id="line.1085">                      " (" + hiveQueryField + " IS NULL OR size(" + hiveQueryField + ") = 0) ",</a>
<span class="sourceLineNo">1086</span><a id="line.1086">                      query);</a>
<span class="sourceLineNo">1087</span><a id="line.1087">                } else {</a>
<span class="sourceLineNo">1088</span><a id="line.1088">                  assertEquals(hiveQueryField + " IS NULL", query);</a>
<span class="sourceLineNo">1089</span><a id="line.1089">                }</a>
<span class="sourceLineNo">1090</span><a id="line.1090"></a>
<span class="sourceLineNo">1091</span><a id="line.1091">              } catch (QueryBuildingException ex) {</a>
<span class="sourceLineNo">1092</span><a id="line.1092">                throw new RuntimeException(ex);</a>
<span class="sourceLineNo">1093</span><a id="line.1093">              }</a>
<span class="sourceLineNo">1094</span><a id="line.1094">            });</a>
<span class="sourceLineNo">1095</span><a id="line.1095">  }</a>
<span class="sourceLineNo">1096</span><a id="line.1096"></a>
<span class="sourceLineNo">1097</span><a id="line.1097">  @Test</a>
<span class="sourceLineNo">1098</span><a id="line.1098">  public void testGreaterThanEqualsIncludingNull() {</a>
<span class="sourceLineNo">1099</span><a id="line.1099">    GreaterThanOrEqualsPredicate&lt;OccurrenceSearchParameter&gt; distanceFromCentroidPredicate =</a>
<span class="sourceLineNo">1100</span><a id="line.1100">        new GreaterThanOrEqualsPredicate&lt;&gt;(</a>
<span class="sourceLineNo">1101</span><a id="line.1101">            OccurrenceSearchParameter.DISTANCE_FROM_CENTROID_IN_METERS, "10");</a>
<span class="sourceLineNo">1102</span><a id="line.1102">    try {</a>
<span class="sourceLineNo">1103</span><a id="line.1103">      String query = visitor.buildQuery(distanceFromCentroidPredicate);</a>
<span class="sourceLineNo">1104</span><a id="line.1104">      assertEquals(</a>
<span class="sourceLineNo">1105</span><a id="line.1105">          "(distancefromcentroidinmeters &gt;= 10 OR distancefromcentroidinmeters IS NULL)", query);</a>
<span class="sourceLineNo">1106</span><a id="line.1106">    } catch (QueryBuildingException ex) {</a>
<span class="sourceLineNo">1107</span><a id="line.1107">      fail();</a>
<span class="sourceLineNo">1108</span><a id="line.1108">    }</a>
<span class="sourceLineNo">1109</span><a id="line.1109">  }</a>
<span class="sourceLineNo">1110</span><a id="line.1110"></a>
<span class="sourceLineNo">1111</span><a id="line.1111">  @Test</a>
<span class="sourceLineNo">1112</span><a id="line.1112">  public void testGreaterThanIncludingNull() {</a>
<span class="sourceLineNo">1113</span><a id="line.1113">    GreaterThanPredicate&lt;OccurrenceSearchParameter&gt; distanceFromCentroidPredicate =</a>
<span class="sourceLineNo">1114</span><a id="line.1114">        new GreaterThanPredicate&lt;&gt;(</a>
<span class="sourceLineNo">1115</span><a id="line.1115">            OccurrenceSearchParameter.DISTANCE_FROM_CENTROID_IN_METERS, "10");</a>
<span class="sourceLineNo">1116</span><a id="line.1116">    try {</a>
<span class="sourceLineNo">1117</span><a id="line.1117">      String query = visitor.buildQuery(distanceFromCentroidPredicate);</a>
<span class="sourceLineNo">1118</span><a id="line.1118">      assertEquals(</a>
<span class="sourceLineNo">1119</span><a id="line.1119">          "(distancefromcentroidinmeters &gt; 10 OR distancefromcentroidinmeters IS NULL)", query);</a>
<span class="sourceLineNo">1120</span><a id="line.1120">    } catch (QueryBuildingException ex) {</a>
<span class="sourceLineNo">1121</span><a id="line.1121">      fail();</a>
<span class="sourceLineNo">1122</span><a id="line.1122">    }</a>
<span class="sourceLineNo">1123</span><a id="line.1123">  }</a>
<span class="sourceLineNo">1124</span><a id="line.1124"></a>
<span class="sourceLineNo">1125</span><a id="line.1125">  @Test</a>
<span class="sourceLineNo">1126</span><a id="line.1126">  public void testDisjunctionGreaterThanEqualsIncludingNull() {</a>
<span class="sourceLineNo">1127</span><a id="line.1127">    GreaterThanOrEqualsPredicate&lt;OccurrenceSearchParameter&gt; distanceFromCentroidPredicate =</a>
<span class="sourceLineNo">1128</span><a id="line.1128">        new GreaterThanOrEqualsPredicate&lt;&gt;(</a>
<span class="sourceLineNo">1129</span><a id="line.1129">            OccurrenceSearchParameter.DISTANCE_FROM_CENTROID_IN_METERS, "10");</a>
<span class="sourceLineNo">1130</span><a id="line.1130">    EqualsPredicate&lt;OccurrenceSearchParameter&gt; equalsPredicate =</a>
<span class="sourceLineNo">1131</span><a id="line.1131">        new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.TAXON_KEY, "6", false);</a>
<span class="sourceLineNo">1132</span><a id="line.1132">    DisjunctionPredicate disjunctionPredicate =</a>
<span class="sourceLineNo">1133</span><a id="line.1133">        new DisjunctionPredicate(Arrays.asList(equalsPredicate, distanceFromCentroidPredicate));</a>
<span class="sourceLineNo">1134</span><a id="line.1134">    try {</a>
<span class="sourceLineNo">1135</span><a id="line.1135">      String query = visitor.buildQuery(disjunctionPredicate);</a>
<span class="sourceLineNo">1136</span><a id="line.1136">      assertEquals(</a>
<span class="sourceLineNo">1137</span><a id="line.1137">          "(((taxonkey = 6 OR acceptedtaxonkey = 6 OR kingdomkey = 6 OR phylumkey = 6 OR classkey = 6 OR orderkey = 6 OR familykey = 6 OR genuskey = 6 OR subgenuskey = 6 OR specieskey = 6)) OR ((distancefromcentroidinmeters &gt;= 10 OR distancefromcentroidinmeters IS NULL)))",</a>
<span class="sourceLineNo">1138</span><a id="line.1138">          query);</a>
<span class="sourceLineNo">1139</span><a id="line.1139">    } catch (QueryBuildingException ex) {</a>
<span class="sourceLineNo">1140</span><a id="line.1140">      fail();</a>
<span class="sourceLineNo">1141</span><a id="line.1141">    }</a>
<span class="sourceLineNo">1142</span><a id="line.1142">  }</a>
<span class="sourceLineNo">1143</span><a id="line.1143"></a>
<span class="sourceLineNo">1144</span><a id="line.1144">  @Test</a>
<span class="sourceLineNo">1145</span><a id="line.1145">  public void testGeoTimePredicate() throws QueryBuildingException {</a>
<span class="sourceLineNo">1146</span><a id="line.1146">    Predicate predicate =</a>
<span class="sourceLineNo">1147</span><a id="line.1147">        new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.GEOLOGICAL_TIME, "12", false);</a>
<span class="sourceLineNo">1148</span><a id="line.1148">    String query = visitor.buildQuery(predicate);</a>
<span class="sourceLineNo">1149</span><a id="line.1149">    assertEquals("12 &gt; geologicaltime.gt AND 12 &lt;= geologicaltime.lte", query);</a>
<span class="sourceLineNo">1150</span><a id="line.1150"></a>
<span class="sourceLineNo">1151</span><a id="line.1151">    Predicate rangePredicate =</a>
<span class="sourceLineNo">1152</span><a id="line.1152">        new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.GEOLOGICAL_TIME, "12,15", false);</a>
<span class="sourceLineNo">1153</span><a id="line.1153">    query = visitor.buildQuery(rangePredicate);</a>
<span class="sourceLineNo">1154</span><a id="line.1154">    assertEquals("geologicaltime.gt &gt;= 12.0 AND geologicaltime.lte &lt;= 15.0", query);</a>
<span class="sourceLineNo">1155</span><a id="line.1155"></a>
<span class="sourceLineNo">1156</span><a id="line.1156">    rangePredicate =</a>
<span class="sourceLineNo">1157</span><a id="line.1157">        new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.GEOLOGICAL_TIME, "12,*", false);</a>
<span class="sourceLineNo">1158</span><a id="line.1158">    query = visitor.buildQuery(rangePredicate);</a>
<span class="sourceLineNo">1159</span><a id="line.1159">    assertEquals("geologicaltime.gt &gt;= 12.0", query);</a>
<span class="sourceLineNo">1160</span><a id="line.1160"></a>
<span class="sourceLineNo">1161</span><a id="line.1161">    rangePredicate =</a>
<span class="sourceLineNo">1162</span><a id="line.1162">        new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.GEOLOGICAL_TIME, "*,15", false);</a>
<span class="sourceLineNo">1163</span><a id="line.1163">    query = visitor.buildQuery(rangePredicate);</a>
<span class="sourceLineNo">1164</span><a id="line.1164">    assertEquals("geologicaltime.lte &lt;= 15.0", query);</a>
<span class="sourceLineNo">1165</span><a id="line.1165">  }</a>
<span class="sourceLineNo">1166</span><a id="line.1166">}</a>




























































</pre>
</div>
</main>
</body>
</html>