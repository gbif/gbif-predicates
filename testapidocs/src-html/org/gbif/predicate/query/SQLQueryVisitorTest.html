<!DOCTYPE HTML>
<html lang="en">
<head>
<!-- Generated by javadoc (17) -->
<title>Source code</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="source: package: org.gbif.predicate.query, class: SQLQueryVisitorTest">
<meta name="generator" content="javadoc/SourceToHTMLConverter">
<link rel="stylesheet" type="text/css" href="../../../../../stylesheet.css" title="Style">
</head>
<body class="source-page">
<main role="main">
<div class="source-container">
<pre><span class="source-line-no">001</span><span id="line-1">/*</span>
<span class="source-line-no">002</span><span id="line-2"> * Licensed under the Apache License, Version 2.0 (the "License");</span>
<span class="source-line-no">003</span><span id="line-3"> * you may not use this file except in compliance with the License.</span>
<span class="source-line-no">004</span><span id="line-4"> * You may obtain a copy of the License at</span>
<span class="source-line-no">005</span><span id="line-5"> *</span>
<span class="source-line-no">006</span><span id="line-6"> *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="source-line-no">007</span><span id="line-7"> *</span>
<span class="source-line-no">008</span><span id="line-8"> * Unless required by applicable law or agreed to in writing, software</span>
<span class="source-line-no">009</span><span id="line-9"> * distributed under the License is distributed on an "AS IS" BASIS,</span>
<span class="source-line-no">010</span><span id="line-10"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="source-line-no">011</span><span id="line-11"> * See the License for the specific language governing permissions and</span>
<span class="source-line-no">012</span><span id="line-12"> * limitations under the License.</span>
<span class="source-line-no">013</span><span id="line-13"> */</span>
<span class="source-line-no">014</span><span id="line-14">package org.gbif.predicate.query;</span>
<span class="source-line-no">015</span><span id="line-15"></span>
<span class="source-line-no">016</span><span id="line-16">import static org.junit.jupiter.api.Assertions.assertEquals;</span>
<span class="source-line-no">017</span><span id="line-17">import static org.junit.jupiter.api.Assertions.fail;</span>
<span class="source-line-no">018</span><span id="line-18"></span>
<span class="source-line-no">019</span><span id="line-19">import com.google.common.collect.Lists;</span>
<span class="source-line-no">020</span><span id="line-20">import java.time.Instant;</span>
<span class="source-line-no">021</span><span id="line-21">import java.util.Arrays;</span>
<span class="source-line-no">022</span><span id="line-22">import java.util.Date;</span>
<span class="source-line-no">023</span><span id="line-23">import java.util.List;</span>
<span class="source-line-no">024</span><span id="line-24">import java.util.Optional;</span>
<span class="source-line-no">025</span><span id="line-25">import java.util.UUID;</span>
<span class="source-line-no">026</span><span id="line-26">import org.gbif.api.exception.QueryBuildingException;</span>
<span class="source-line-no">027</span><span id="line-27">import org.gbif.api.model.occurrence.search.OccurrenceSearchParameter;</span>
<span class="source-line-no">028</span><span id="line-28">import org.gbif.api.model.predicate.ConjunctionPredicate;</span>
<span class="source-line-no">029</span><span id="line-29">import org.gbif.api.model.predicate.DisjunctionPredicate;</span>
<span class="source-line-no">030</span><span id="line-30">import org.gbif.api.model.predicate.EqualsPredicate;</span>
<span class="source-line-no">031</span><span id="line-31">import org.gbif.api.model.predicate.GeoDistancePredicate;</span>
<span class="source-line-no">032</span><span id="line-32">import org.gbif.api.model.predicate.GreaterThanOrEqualsPredicate;</span>
<span class="source-line-no">033</span><span id="line-33">import org.gbif.api.model.predicate.GreaterThanPredicate;</span>
<span class="source-line-no">034</span><span id="line-34">import org.gbif.api.model.predicate.InPredicate;</span>
<span class="source-line-no">035</span><span id="line-35">import org.gbif.api.model.predicate.IsNotNullPredicate;</span>
<span class="source-line-no">036</span><span id="line-36">import org.gbif.api.model.predicate.IsNullPredicate;</span>
<span class="source-line-no">037</span><span id="line-37">import org.gbif.api.model.predicate.LessThanOrEqualsPredicate;</span>
<span class="source-line-no">038</span><span id="line-38">import org.gbif.api.model.predicate.LessThanPredicate;</span>
<span class="source-line-no">039</span><span id="line-39">import org.gbif.api.model.predicate.LikePredicate;</span>
<span class="source-line-no">040</span><span id="line-40">import org.gbif.api.model.predicate.NotPredicate;</span>
<span class="source-line-no">041</span><span id="line-41">import org.gbif.api.model.predicate.Predicate;</span>
<span class="source-line-no">042</span><span id="line-42">import org.gbif.api.model.predicate.RangePredicate;</span>
<span class="source-line-no">043</span><span id="line-43">import org.gbif.api.model.predicate.WithinPredicate;</span>
<span class="source-line-no">044</span><span id="line-44">import org.gbif.api.util.IsoDateInterval;</span>
<span class="source-line-no">045</span><span id="line-45">import org.gbif.api.util.Range;</span>
<span class="source-line-no">046</span><span id="line-46">import org.gbif.api.util.RangeValue;</span>
<span class="source-line-no">047</span><span id="line-47">import org.gbif.api.util.SearchTypeValidator;</span>
<span class="source-line-no">048</span><span id="line-48">import org.gbif.api.vocabulary.Country;</span>
<span class="source-line-no">049</span><span id="line-49">import org.gbif.api.vocabulary.Language;</span>
<span class="source-line-no">050</span><span id="line-50">import org.gbif.predicate.query.occurrence.OccurrenceTermsMapper;</span>
<span class="source-line-no">051</span><span id="line-51">import org.junit.jupiter.api.Test;</span>
<span class="source-line-no">052</span><span id="line-52"></span>
<span class="source-line-no">053</span><span id="line-53">public class SQLQueryVisitorTest {</span>
<span class="source-line-no">054</span><span id="line-54"></span>
<span class="source-line-no">055</span><span id="line-55">  private static final OccurrenceSearchParameter PARAM = OccurrenceSearchParameter.CATALOG_NUMBER;</span>
<span class="source-line-no">056</span><span id="line-56">  private static final OccurrenceSearchParameter PARAM2 =</span>
<span class="source-line-no">057</span><span id="line-57">      OccurrenceSearchParameter.INSTITUTION_CODE;</span>
<span class="source-line-no">058</span><span id="line-58">  private final SQLQueryVisitor visitor = new SQLQueryVisitor(new OccurrenceTermsMapper());</span>
<span class="source-line-no">059</span><span id="line-59"></span>
<span class="source-line-no">060</span><span id="line-60">  @Test</span>
<span class="source-line-no">061</span><span id="line-61">  public void testComplexQuery() throws QueryBuildingException {</span>
<span class="source-line-no">062</span><span id="line-62">    Predicate aves = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.TAXON_KEY, "212", false);</span>
<span class="source-line-no">063</span><span id="line-63">    Predicate passer =</span>
<span class="source-line-no">064</span><span id="line-64">        new LikePredicate&lt;&gt;(OccurrenceSearchParameter.SCIENTIFIC_NAME, "Passer*", false);</span>
<span class="source-line-no">065</span><span id="line-65">    Predicate UK = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.COUNTRY, "GB", false);</span>
<span class="source-line-no">066</span><span id="line-66">    Predicate before1989 = new LessThanOrEqualsPredicate&lt;&gt;(OccurrenceSearchParameter.YEAR, "1989");</span>
<span class="source-line-no">067</span><span id="line-67">    Predicate georeferencedPredicate =</span>
<span class="source-line-no">068</span><span id="line-68">        new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.HAS_COORDINATE, "true", false);</span>
<span class="source-line-no">069</span><span id="line-69"></span>
<span class="source-line-no">070</span><span id="line-70">    ConjunctionPredicate p =</span>
<span class="source-line-no">071</span><span id="line-71">        new ConjunctionPredicate(</span>
<span class="source-line-no">072</span><span id="line-72">            Lists.newArrayList(aves, UK, passer, before1989, georeferencedPredicate));</span>
<span class="source-line-no">073</span><span id="line-73">    String where = visitor.buildQuery(p);</span>
<span class="source-line-no">074</span><span id="line-74">    assertEquals(</span>
<span class="source-line-no">075</span><span id="line-75">        "(((taxonkey = 212 OR acceptedtaxonkey = 212 OR kingdomkey = 212 OR phylumkey = 212 OR classkey = 212 OR orderkey = 212 OR familykey = 212 OR genuskey = 212 OR specieskey = 212)) AND (countrycode = \'GB\') AND (lower(scientificname) LIKE lower(\'Passer%\')) AND (year &lt;= 1989) AND (hascoordinate = true))",</span>
<span class="source-line-no">076</span><span id="line-76">        where);</span>
<span class="source-line-no">077</span><span id="line-77">  }</span>
<span class="source-line-no">078</span><span id="line-78"></span>
<span class="source-line-no">079</span><span id="line-79">  @Test</span>
<span class="source-line-no">080</span><span id="line-80">  public void testMoreComplexQuery() throws QueryBuildingException {</span>
<span class="source-line-no">081</span><span id="line-81">    Predicate taxon1 = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.TAXON_KEY, "1", false);</span>
<span class="source-line-no">082</span><span id="line-82">    Predicate taxon2 = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.TAXON_KEY, "2", false);</span>
<span class="source-line-no">083</span><span id="line-83">    DisjunctionPredicate taxa = new DisjunctionPredicate(Lists.newArrayList(taxon1, taxon2));</span>
<span class="source-line-no">084</span><span id="line-84"></span>
<span class="source-line-no">085</span><span id="line-85">    Predicate basis =</span>
<span class="source-line-no">086</span><span id="line-86">        new InPredicate&lt;&gt;(</span>
<span class="source-line-no">087</span><span id="line-87">            OccurrenceSearchParameter.BASIS_OF_RECORD,</span>
<span class="source-line-no">088</span><span id="line-88">            Lists.newArrayList("HUMAN_OBSERVATION", "MACHINE_OBSERVATION"),</span>
<span class="source-line-no">089</span><span id="line-89">            false);</span>
<span class="source-line-no">090</span><span id="line-90"></span>
<span class="source-line-no">091</span><span id="line-91">    Predicate UK = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.COUNTRY, "GB", false);</span>
<span class="source-line-no">092</span><span id="line-92">    Predicate IE = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.COUNTRY, "IE", false);</span>
<span class="source-line-no">093</span><span id="line-93">    DisjunctionPredicate countries = new DisjunctionPredicate(Lists.newArrayList(UK, IE));</span>
<span class="source-line-no">094</span><span id="line-94"></span>
<span class="source-line-no">095</span><span id="line-95">    Predicate before1989 = new LessThanOrEqualsPredicate&lt;&gt;(OccurrenceSearchParameter.YEAR, "1989");</span>
<span class="source-line-no">096</span><span id="line-96">    Predicate in2000 = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.YEAR, "2000", false);</span>
<span class="source-line-no">097</span><span id="line-97">    DisjunctionPredicate years = new DisjunctionPredicate(Lists.newArrayList(before1989, in2000));</span>
<span class="source-line-no">098</span><span id="line-98"></span>
<span class="source-line-no">099</span><span id="line-99">    ConjunctionPredicate p =</span>
<span class="source-line-no">100</span><span id="line-100">        new ConjunctionPredicate(Lists.newArrayList(taxa, basis, countries, years));</span>
<span class="source-line-no">101</span><span id="line-101">    String where = visitor.buildQuery(p);</span>
<span class="source-line-no">102</span><span id="line-102">    assertEquals(</span>
<span class="source-line-no">103</span><span id="line-103">        "(((taxonkey IN(1, 2) OR acceptedtaxonkey IN(1, 2) OR kingdomkey IN(1, 2) OR phylumkey IN(1, 2) OR classkey IN(1, 2) OR orderkey IN(1, 2) OR familykey IN(1, 2) OR genuskey IN(1, 2) OR specieskey IN(1, 2))) "</span>
<span class="source-line-no">104</span><span id="line-104">            + "AND ((basisofrecord IN('HUMAN_OBSERVATION', 'MACHINE_OBSERVATION'))) "</span>
<span class="source-line-no">105</span><span id="line-105">            + "AND ((countrycode IN(\'GB\', \'IE\'))) "</span>
<span class="source-line-no">106</span><span id="line-106">            + "AND (((year &lt;= 1989) OR (year = 2000))))",</span>
<span class="source-line-no">107</span><span id="line-107">        where);</span>
<span class="source-line-no">108</span><span id="line-108">  }</span>
<span class="source-line-no">109</span><span id="line-109"></span>
<span class="source-line-no">110</span><span id="line-110">  @Test</span>
<span class="source-line-no">111</span><span id="line-111">  public void testConjunctionPredicate() throws QueryBuildingException {</span>
<span class="source-line-no">112</span><span id="line-112">    Predicate p1 = new EqualsPredicate&lt;&gt;(PARAM, "value_1", false);</span>
<span class="source-line-no">113</span><span id="line-113">    Predicate p2 = new EqualsPredicate&lt;&gt;(PARAM2, "value_2", false);</span>
<span class="source-line-no">114</span><span id="line-114"></span>
<span class="source-line-no">115</span><span id="line-115">    ConjunctionPredicate p = new ConjunctionPredicate(Lists.newArrayList(p1, p2));</span>
<span class="source-line-no">116</span><span id="line-116">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">117</span><span id="line-117">    assertEquals(</span>
<span class="source-line-no">118</span><span id="line-118">        "((lower(catalognumber) = lower(\'value_1\')) AND (lower(institutioncode) = lower(\'value_2\')))",</span>
<span class="source-line-no">119</span><span id="line-119">        query);</span>
<span class="source-line-no">120</span><span id="line-120">  }</span>
<span class="source-line-no">121</span><span id="line-121"></span>
<span class="source-line-no">122</span><span id="line-122">  @Test</span>
<span class="source-line-no">123</span><span id="line-123">  public void testDisjunctionPredicate() throws QueryBuildingException {</span>
<span class="source-line-no">124</span><span id="line-124">    Predicate p1 = new EqualsPredicate&lt;&gt;(PARAM, "value_1", false);</span>
<span class="source-line-no">125</span><span id="line-125">    Predicate p2 = new EqualsPredicate&lt;&gt;(PARAM2, "value_2", false);</span>
<span class="source-line-no">126</span><span id="line-126"></span>
<span class="source-line-no">127</span><span id="line-127">    DisjunctionPredicate p = new DisjunctionPredicate(Lists.newArrayList(p1, p2));</span>
<span class="source-line-no">128</span><span id="line-128">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">129</span><span id="line-129">    assertEquals(</span>
<span class="source-line-no">130</span><span id="line-130">        "((lower(catalognumber) = lower(\'value_1\')) OR (lower(institutioncode) = lower(\'value_2\')))",</span>
<span class="source-line-no">131</span><span id="line-131">        query);</span>
<span class="source-line-no">132</span><span id="line-132">  }</span>
<span class="source-line-no">133</span><span id="line-133"></span>
<span class="source-line-no">134</span><span id="line-134">  @Test</span>
<span class="source-line-no">135</span><span id="line-135">  public void testDisjunctionToInPredicate() throws QueryBuildingException {</span>
<span class="source-line-no">136</span><span id="line-136">    Predicate p1 = new EqualsPredicate&lt;&gt;(PARAM, "value_1", false);</span>
<span class="source-line-no">137</span><span id="line-137">    Predicate p2 = new EqualsPredicate&lt;&gt;(PARAM, "value_2", false);</span>
<span class="source-line-no">138</span><span id="line-138"></span>
<span class="source-line-no">139</span><span id="line-139">    DisjunctionPredicate p = new DisjunctionPredicate(Lists.newArrayList(p1, p2));</span>
<span class="source-line-no">140</span><span id="line-140">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">141</span><span id="line-141">    assertEquals("(lower(catalognumber) IN(lower(\'value_1\'), lower(\'value_2\')))", query);</span>
<span class="source-line-no">142</span><span id="line-142">  }</span>
<span class="source-line-no">143</span><span id="line-143"></span>
<span class="source-line-no">144</span><span id="line-144">  @Test</span>
<span class="source-line-no">145</span><span id="line-145">  public void testDisjunctionToInTaxonPredicate() throws QueryBuildingException {</span>
<span class="source-line-no">146</span><span id="line-146">    Predicate p1 = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.TAXON_KEY, "1", false);</span>
<span class="source-line-no">147</span><span id="line-147">    Predicate p2 = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.TAXON_KEY, "2", false);</span>
<span class="source-line-no">148</span><span id="line-148"></span>
<span class="source-line-no">149</span><span id="line-149">    DisjunctionPredicate p = new DisjunctionPredicate(Lists.newArrayList(p1, p2));</span>
<span class="source-line-no">150</span><span id="line-150">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">151</span><span id="line-151">    assertEquals(</span>
<span class="source-line-no">152</span><span id="line-152">        "(taxonkey IN(1, 2) OR acceptedtaxonkey IN(1, 2) OR kingdomkey IN(1, 2) OR phylumkey IN(1, 2) OR classkey IN(1, 2) OR orderkey IN(1, 2) OR familykey IN(1, 2) OR genuskey IN(1, 2) OR specieskey IN(1, 2))",</span>
<span class="source-line-no">153</span><span id="line-153">        query);</span>
<span class="source-line-no">154</span><span id="line-154">  }</span>
<span class="source-line-no">155</span><span id="line-155"></span>
<span class="source-line-no">156</span><span id="line-156">  @Test</span>
<span class="source-line-no">157</span><span id="line-157">  public void testDisjunctionToInGadmGidPredicate() throws QueryBuildingException {</span>
<span class="source-line-no">158</span><span id="line-158">    Predicate p1 = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.GADM_GID, "IRL_1", false);</span>
<span class="source-line-no">159</span><span id="line-159">    Predicate p2 = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.GADM_GID, "GBR.2_1", false);</span>
<span class="source-line-no">160</span><span id="line-160"></span>
<span class="source-line-no">161</span><span id="line-161">    DisjunctionPredicate p = new DisjunctionPredicate(Lists.newArrayList(p1, p2));</span>
<span class="source-line-no">162</span><span id="line-162">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">163</span><span id="line-163">    assertEquals(</span>
<span class="source-line-no">164</span><span id="line-164">        "(level0gid IN('IRL_1', 'GBR.2_1') OR level1gid IN('IRL_1', 'GBR.2_1') OR level2gid IN('IRL_1', 'GBR.2_1') OR level3gid IN('IRL_1', 'GBR.2_1'))",</span>
<span class="source-line-no">165</span><span id="line-165">        query);</span>
<span class="source-line-no">166</span><span id="line-166">  }</span>
<span class="source-line-no">167</span><span id="line-167"></span>
<span class="source-line-no">168</span><span id="line-168">  @Test</span>
<span class="source-line-no">169</span><span id="line-169">  public void testDisjunctionMediaTypePredicate() throws QueryBuildingException {</span>
<span class="source-line-no">170</span><span id="line-170">    Predicate p1 = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.MEDIA_TYPE, "StillImage", false);</span>
<span class="source-line-no">171</span><span id="line-171">    Predicate p2 = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.MEDIA_TYPE, "Sound", false);</span>
<span class="source-line-no">172</span><span id="line-172"></span>
<span class="source-line-no">173</span><span id="line-173">    DisjunctionPredicate p = new DisjunctionPredicate(Lists.newArrayList(p1, p2));</span>
<span class="source-line-no">174</span><span id="line-174">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">175</span><span id="line-175">    assertEquals(</span>
<span class="source-line-no">176</span><span id="line-176">        "(stringArrayContains(mediatype,'StillImage',true) OR stringArrayContains(mediatype,'Sound',true))",</span>
<span class="source-line-no">177</span><span id="line-177">        query);</span>
<span class="source-line-no">178</span><span id="line-178">  }</span>
<span class="source-line-no">179</span><span id="line-179"></span>
<span class="source-line-no">180</span><span id="line-180">  @Test</span>
<span class="source-line-no">181</span><span id="line-181">  public void testDisjunctionVerbatimToInPredicate() throws QueryBuildingException {</span>
<span class="source-line-no">182</span><span id="line-182">    Predicate p1 = new EqualsPredicate&lt;&gt;(PARAM, "value_1", true);</span>
<span class="source-line-no">183</span><span id="line-183">    Predicate p2 = new EqualsPredicate&lt;&gt;(PARAM, "value_2", true);</span>
<span class="source-line-no">184</span><span id="line-184"></span>
<span class="source-line-no">185</span><span id="line-185">    DisjunctionPredicate p = new DisjunctionPredicate(Lists.newArrayList(p1, p2));</span>
<span class="source-line-no">186</span><span id="line-186">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">187</span><span id="line-187">    assertEquals("(catalognumber IN('value_1', 'value_2'))", query);</span>
<span class="source-line-no">188</span><span id="line-188"></span>
<span class="source-line-no">189</span><span id="line-189">    Predicate p3 = new EqualsPredicate&lt;&gt;(PARAM, "value_3", false);</span>
<span class="source-line-no">190</span><span id="line-190"></span>
<span class="source-line-no">191</span><span id="line-191">    p = new DisjunctionPredicate(Lists.newArrayList(p1, p2, p3));</span>
<span class="source-line-no">192</span><span id="line-192">    query = visitor.buildQuery(p);</span>
<span class="source-line-no">193</span><span id="line-193">    assertEquals(</span>
<span class="source-line-no">194</span><span id="line-194">        "((catalognumber = 'value_1') OR (catalognumber = 'value_2') OR (lower(catalognumber) = lower('value_3')))",</span>
<span class="source-line-no">195</span><span id="line-195">        query);</span>
<span class="source-line-no">196</span><span id="line-196">  }</span>
<span class="source-line-no">197</span><span id="line-197"></span>
<span class="source-line-no">198</span><span id="line-198">  @Test</span>
<span class="source-line-no">199</span><span id="line-199">  public void testEqualsPredicate() throws QueryBuildingException {</span>
<span class="source-line-no">200</span><span id="line-200">    Predicate p = new EqualsPredicate&lt;&gt;(PARAM, "value", false);</span>
<span class="source-line-no">201</span><span id="line-201">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">202</span><span id="line-202">    assertEquals("lower(catalognumber) = lower(\'value\')", query);</span>
<span class="source-line-no">203</span><span id="line-203">  }</span>
<span class="source-line-no">204</span><span id="line-204"></span>
<span class="source-line-no">205</span><span id="line-205">  @Test</span>
<span class="source-line-no">206</span><span id="line-206">  public void testEqualsPredicateGadmGid() throws QueryBuildingException {</span>
<span class="source-line-no">207</span><span id="line-207">    Predicate p = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.GADM_GID, "IRL_1", false);</span>
<span class="source-line-no">208</span><span id="line-208"></span>
<span class="source-line-no">209</span><span id="line-209">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">210</span><span id="line-210">    assertEquals(</span>
<span class="source-line-no">211</span><span id="line-211">        "(level0gid = 'IRL_1' OR level1gid = 'IRL_1' OR level2gid = 'IRL_1' OR level3gid = 'IRL_1')",</span>
<span class="source-line-no">212</span><span id="line-212">        query);</span>
<span class="source-line-no">213</span><span id="line-213">  }</span>
<span class="source-line-no">214</span><span id="line-214"></span>
<span class="source-line-no">215</span><span id="line-215">  @Test</span>
<span class="source-line-no">216</span><span id="line-216">  public void testLikePredicate() throws QueryBuildingException {</span>
<span class="source-line-no">217</span><span id="line-217">    // NB: ? and * are wildcards (translated to SQL _ and %), so literal _ and % are escaped.</span>
<span class="source-line-no">218</span><span id="line-218">    Predicate p = new LikePredicate&lt;&gt;(PARAM, "v?l*ue_%", false);</span>
<span class="source-line-no">219</span><span id="line-219">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">220</span><span id="line-220">    assertEquals("lower(catalognumber) LIKE lower(\'v_l%ue\\_\\%\')", query);</span>
<span class="source-line-no">221</span><span id="line-221">  }</span>
<span class="source-line-no">222</span><span id="line-222"></span>
<span class="source-line-no">223</span><span id="line-223">  @Test</span>
<span class="source-line-no">224</span><span id="line-224">  public void testLikeVerbatimPredicate() throws QueryBuildingException {</span>
<span class="source-line-no">225</span><span id="line-225">    Predicate p = new LikePredicate&lt;&gt;(PARAM, "v?l*ue_%", true);</span>
<span class="source-line-no">226</span><span id="line-226">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">227</span><span id="line-227">    assertEquals("catalognumber LIKE \'v_l%ue\\_\\%\'", query);</span>
<span class="source-line-no">228</span><span id="line-228">  }</span>
<span class="source-line-no">229</span><span id="line-229"></span>
<span class="source-line-no">230</span><span id="line-230">  @Test</span>
<span class="source-line-no">231</span><span id="line-231">  public void testEqualsVerbatimPredicate() throws QueryBuildingException {</span>
<span class="source-line-no">232</span><span id="line-232">    Predicate p = new EqualsPredicate&lt;&gt;(PARAM, "value", true);</span>
<span class="source-line-no">233</span><span id="line-233">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">234</span><span id="line-234">    assertEquals("catalognumber = \'value\'", query);</span>
<span class="source-line-no">235</span><span id="line-235">  }</span>
<span class="source-line-no">236</span><span id="line-236"></span>
<span class="source-line-no">237</span><span id="line-237">  @Test</span>
<span class="source-line-no">238</span><span id="line-238">  public void testEqualsArrayPredicate() throws QueryBuildingException {</span>
<span class="source-line-no">239</span><span id="line-239">    Predicate p = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.RECORDED_BY, "value", false);</span>
<span class="source-line-no">240</span><span id="line-240">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">241</span><span id="line-241">    assertEquals("stringArrayContains(recordedby,'value',false)", query);</span>
<span class="source-line-no">242</span><span id="line-242"></span>
<span class="source-line-no">243</span><span id="line-243">    p = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.RECORDED_BY, "value", true);</span>
<span class="source-line-no">244</span><span id="line-244">    query = visitor.buildQuery(p);</span>
<span class="source-line-no">245</span><span id="line-245">    assertEquals("stringArrayContains(recordedby,'value',true)", query);</span>
<span class="source-line-no">246</span><span id="line-246">  }</span>
<span class="source-line-no">247</span><span id="line-247"></span>
<span class="source-line-no">248</span><span id="line-248">  @Test</span>
<span class="source-line-no">249</span><span id="line-249">  public void testLikeArrayPredicate() throws QueryBuildingException {</span>
<span class="source-line-no">250</span><span id="line-250">    // NB: ? and * are the wildcards here.</span>
<span class="source-line-no">251</span><span id="line-251">    Predicate p = new LikePredicate&lt;&gt;(OccurrenceSearchParameter.RECORDED_BY, "v?l*ue_%", false);</span>
<span class="source-line-no">252</span><span id="line-252">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">253</span><span id="line-253">    assertEquals("stringArrayLike(recordedby,'v?l*ue_%',false)", query);</span>
<span class="source-line-no">254</span><span id="line-254"></span>
<span class="source-line-no">255</span><span id="line-255">    p = new LikePredicate&lt;&gt;(OccurrenceSearchParameter.RECORDED_BY, "v?l*ue_%", true);</span>
<span class="source-line-no">256</span><span id="line-256">    query = visitor.buildQuery(p);</span>
<span class="source-line-no">257</span><span id="line-257">    assertEquals("stringArrayLike(recordedby,'v?l*ue_%',true)", query);</span>
<span class="source-line-no">258</span><span id="line-258">  }</span>
<span class="source-line-no">259</span><span id="line-259"></span>
<span class="source-line-no">260</span><span id="line-260">  @Test</span>
<span class="source-line-no">261</span><span id="line-261">  public void testGreaterThanOrEqualPredicate() throws QueryBuildingException {</span>
<span class="source-line-no">262</span><span id="line-262">    Predicate p = new GreaterThanOrEqualsPredicate&lt;&gt;(OccurrenceSearchParameter.ELEVATION, "222");</span>
<span class="source-line-no">263</span><span id="line-263">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">264</span><span id="line-264">    assertEquals("elevation &gt;= 222", query);</span>
<span class="source-line-no">265</span><span id="line-265">  }</span>
<span class="source-line-no">266</span><span id="line-266"></span>
<span class="source-line-no">267</span><span id="line-267">  @Test</span>
<span class="source-line-no">268</span><span id="line-268">  public void testGreaterThanPredicate() throws QueryBuildingException {</span>
<span class="source-line-no">269</span><span id="line-269">    Predicate p = new GreaterThanPredicate&lt;&gt;(OccurrenceSearchParameter.ELEVATION, "1000");</span>
<span class="source-line-no">270</span><span id="line-270">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">271</span><span id="line-271">    assertEquals("elevation &gt; 1000", query);</span>
<span class="source-line-no">272</span><span id="line-272">  }</span>
<span class="source-line-no">273</span><span id="line-273"></span>
<span class="source-line-no">274</span><span id="line-274">  @Test</span>
<span class="source-line-no">275</span><span id="line-275">  public void testInPredicate() throws QueryBuildingException {</span>
<span class="source-line-no">276</span><span id="line-276">    Predicate p =</span>
<span class="source-line-no">277</span><span id="line-277">        new InPredicate&lt;&gt;(PARAM, Lists.newArrayList("value_1", "value_2", "value_3"), false);</span>
<span class="source-line-no">278</span><span id="line-278">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">279</span><span id="line-279">    assertEquals(</span>
<span class="source-line-no">280</span><span id="line-280">        "(lower(catalognumber) IN(lower(\'value_1\'), lower(\'value_2\'), lower(\'value_3\')))",</span>
<span class="source-line-no">281</span><span id="line-281">        query);</span>
<span class="source-line-no">282</span><span id="line-282">  }</span>
<span class="source-line-no">283</span><span id="line-283"></span>
<span class="source-line-no">284</span><span id="line-284">  @Test</span>
<span class="source-line-no">285</span><span id="line-285">  public void testInVerbatimPredicate() throws QueryBuildingException {</span>
<span class="source-line-no">286</span><span id="line-286">    Predicate p =</span>
<span class="source-line-no">287</span><span id="line-287">        new InPredicate&lt;&gt;(PARAM, Lists.newArrayList("value_1", "value_2", "value_3"), true);</span>
<span class="source-line-no">288</span><span id="line-288">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">289</span><span id="line-289">    assertEquals("(catalognumber IN(\'value_1\', \'value_2\', \'value_3\'))", query);</span>
<span class="source-line-no">290</span><span id="line-290">  }</span>
<span class="source-line-no">291</span><span id="line-291"></span>
<span class="source-line-no">292</span><span id="line-292">  @Test</span>
<span class="source-line-no">293</span><span id="line-293">  public void testInPredicateTaxonKey() throws QueryBuildingException {</span>
<span class="source-line-no">294</span><span id="line-294">    Predicate p =</span>
<span class="source-line-no">295</span><span id="line-295">        new InPredicate&lt;&gt;(OccurrenceSearchParameter.TAXON_KEY, Lists.newArrayList("1", "2"), false);</span>
<span class="source-line-no">296</span><span id="line-296">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">297</span><span id="line-297">    assertEquals(</span>
<span class="source-line-no">298</span><span id="line-298">        "(taxonkey IN(1, 2) OR acceptedtaxonkey IN(1, 2) OR kingdomkey IN(1, 2) OR phylumkey IN(1, 2) OR classkey IN(1, 2) OR orderkey IN(1, 2) OR familykey IN(1, 2) OR genuskey IN(1, 2) OR specieskey IN(1, 2))",</span>
<span class="source-line-no">299</span><span id="line-299">        query);</span>
<span class="source-line-no">300</span><span id="line-300">  }</span>
<span class="source-line-no">301</span><span id="line-301"></span>
<span class="source-line-no">302</span><span id="line-302">  @Test</span>
<span class="source-line-no">303</span><span id="line-303">  public void testInPredicateGadmGid() throws QueryBuildingException {</span>
<span class="source-line-no">304</span><span id="line-304">    Predicate p =</span>
<span class="source-line-no">305</span><span id="line-305">        new InPredicate&lt;&gt;(</span>
<span class="source-line-no">306</span><span id="line-306">            OccurrenceSearchParameter.GADM_GID, Lists.newArrayList("IRL_1", "GBR.2_1"), false);</span>
<span class="source-line-no">307</span><span id="line-307">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">308</span><span id="line-308">    assertEquals(</span>
<span class="source-line-no">309</span><span id="line-309">        "(level0gid IN('IRL_1', 'GBR.2_1') OR level1gid IN('IRL_1', 'GBR.2_1') OR level2gid IN('IRL_1', 'GBR.2_1') OR level3gid IN('IRL_1', 'GBR.2_1'))",</span>
<span class="source-line-no">310</span><span id="line-310">        query);</span>
<span class="source-line-no">311</span><span id="line-311">  }</span>
<span class="source-line-no">312</span><span id="line-312"></span>
<span class="source-line-no">313</span><span id="line-313">  @Test</span>
<span class="source-line-no">314</span><span id="line-314">  public void testInPredicateMediaType() throws QueryBuildingException {</span>
<span class="source-line-no">315</span><span id="line-315">    Predicate p =</span>
<span class="source-line-no">316</span><span id="line-316">        new InPredicate&lt;&gt;(</span>
<span class="source-line-no">317</span><span id="line-317">            OccurrenceSearchParameter.MEDIA_TYPE, Lists.newArrayList("StillImage", "Sound"), false);</span>
<span class="source-line-no">318</span><span id="line-318">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">319</span><span id="line-319">    assertEquals(</span>
<span class="source-line-no">320</span><span id="line-320">        "(stringArrayContains(mediatype,'StillImage',true) OR stringArrayContains(mediatype,'Sound',true))",</span>
<span class="source-line-no">321</span><span id="line-321">        query);</span>
<span class="source-line-no">322</span><span id="line-322">  }</span>
<span class="source-line-no">323</span><span id="line-323"></span>
<span class="source-line-no">324</span><span id="line-324">  @Test</span>
<span class="source-line-no">325</span><span id="line-325">  public void testLessThanOrEqualPredicate() throws QueryBuildingException {</span>
<span class="source-line-no">326</span><span id="line-326">    Predicate p = new LessThanOrEqualsPredicate&lt;&gt;(OccurrenceSearchParameter.ELEVATION, "1000");</span>
<span class="source-line-no">327</span><span id="line-327">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">328</span><span id="line-328">    assertEquals("elevation &lt;= 1000", query);</span>
<span class="source-line-no">329</span><span id="line-329">  }</span>
<span class="source-line-no">330</span><span id="line-330"></span>
<span class="source-line-no">331</span><span id="line-331">  @Test</span>
<span class="source-line-no">332</span><span id="line-332">  public void testLessThanPredicate() throws QueryBuildingException {</span>
<span class="source-line-no">333</span><span id="line-333">    Predicate p = new LessThanPredicate&lt;&gt;(OccurrenceSearchParameter.ELEVATION, "1000");</span>
<span class="source-line-no">334</span><span id="line-334">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">335</span><span id="line-335">    assertEquals("elevation &lt; 1000", query);</span>
<span class="source-line-no">336</span><span id="line-336">  }</span>
<span class="source-line-no">337</span><span id="line-337"></span>
<span class="source-line-no">338</span><span id="line-338">  @Test</span>
<span class="source-line-no">339</span><span id="line-339">  public void testNotPredicate() throws QueryBuildingException {</span>
<span class="source-line-no">340</span><span id="line-340">    Predicate p = new NotPredicate(new EqualsPredicate&lt;&gt;(PARAM, "value", false));</span>
<span class="source-line-no">341</span><span id="line-341">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">342</span><span id="line-342">    assertEquals("NOT lower(catalognumber) = lower(\'value\')", query);</span>
<span class="source-line-no">343</span><span id="line-343">  }</span>
<span class="source-line-no">344</span><span id="line-344"></span>
<span class="source-line-no">345</span><span id="line-345">  @Test</span>
<span class="source-line-no">346</span><span id="line-346">  public void testNotPredicateComplex() throws QueryBuildingException {</span>
<span class="source-line-no">347</span><span id="line-347">    Predicate p1 = new EqualsPredicate&lt;&gt;(PARAM, "value_1", false);</span>
<span class="source-line-no">348</span><span id="line-348">    Predicate p2 = new EqualsPredicate&lt;&gt;(PARAM2, "value_2", false);</span>
<span class="source-line-no">349</span><span id="line-349"></span>
<span class="source-line-no">350</span><span id="line-350">    ConjunctionPredicate cp = new ConjunctionPredicate(Lists.newArrayList(p1, p2));</span>
<span class="source-line-no">351</span><span id="line-351"></span>
<span class="source-line-no">352</span><span id="line-352">    Predicate p = new NotPredicate(cp);</span>
<span class="source-line-no">353</span><span id="line-353">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">354</span><span id="line-354">    assertEquals(</span>
<span class="source-line-no">355</span><span id="line-355">        "NOT ((lower(catalognumber) = lower(\'value_1\')) AND (lower(institutioncode) = lower(\'value_2\')))",</span>
<span class="source-line-no">356</span><span id="line-356">        query);</span>
<span class="source-line-no">357</span><span id="line-357">  }</span>
<span class="source-line-no">358</span><span id="line-358"></span>
<span class="source-line-no">359</span><span id="line-359">  @Test</span>
<span class="source-line-no">360</span><span id="line-360">  public void testQuotes() throws QueryBuildingException {</span>
<span class="source-line-no">361</span><span id="line-361">    Predicate p = new EqualsPredicate&lt;&gt;(PARAM, "my \'pleasure\'", false);</span>
<span class="source-line-no">362</span><span id="line-362">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">363</span><span id="line-363">    assertEquals("lower(catalognumber) = lower(\'my \\\'pleasure\\\'\')", query);</span>
<span class="source-line-no">364</span><span id="line-364"></span>
<span class="source-line-no">365</span><span id="line-365">    Predicate predicateRecordedBY =</span>
<span class="source-line-no">366</span><span id="line-366">        new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.RECORDED_BY, "Brian J O'Shea", false);</span>
<span class="source-line-no">367</span><span id="line-367">    String queryRecordedBy = visitor.buildQuery(predicateRecordedBY);</span>
<span class="source-line-no">368</span><span id="line-368">    assertEquals("stringArrayContains(recordedby,'Brian J O\\'Shea',false)", queryRecordedBy);</span>
<span class="source-line-no">369</span><span id="line-369"></span>
<span class="source-line-no">370</span><span id="line-370">    p = new LessThanOrEqualsPredicate&lt;&gt;(OccurrenceSearchParameter.ELEVATION, "101");</span>
<span class="source-line-no">371</span><span id="line-371">    query = visitor.buildQuery(p);</span>
<span class="source-line-no">372</span><span id="line-372">    assertEquals("elevation &lt;= 101", query);</span>
<span class="source-line-no">373</span><span id="line-373"></span>
<span class="source-line-no">374</span><span id="line-374">    p = new GreaterThanPredicate&lt;&gt;(OccurrenceSearchParameter.YEAR, "1998");</span>
<span class="source-line-no">375</span><span id="line-375">    query = visitor.buildQuery(p);</span>
<span class="source-line-no">376</span><span id="line-376">    assertEquals("year &gt; 1998", query);</span>
<span class="source-line-no">377</span><span id="line-377">  }</span>
<span class="source-line-no">378</span><span id="line-378"></span>
<span class="source-line-no">379</span><span id="line-379">  @Test</span>
<span class="source-line-no">380</span><span id="line-380">  public void testGeoDistancePredicate() throws QueryBuildingException {</span>
<span class="source-line-no">381</span><span id="line-381">    Predicate p = new GeoDistancePredicate("30", "10", "10km");</span>
<span class="source-line-no">382</span><span id="line-382">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">383</span><span id="line-383">    assertEquals(</span>
<span class="source-line-no">384</span><span id="line-384">        "(geoDistance(30.0, 10.0, '10.0km', decimallatitude, decimallongitude) = TRUE)", query);</span>
<span class="source-line-no">385</span><span id="line-385">  }</span>
<span class="source-line-no">386</span><span id="line-386"></span>
<span class="source-line-no">387</span><span id="line-387">  @Test</span>
<span class="source-line-no">388</span><span id="line-388">  public void testWithinPredicate() throws QueryBuildingException {</span>
<span class="source-line-no">389</span><span id="line-389">    final String wkt = "POLYGON ((30 10, 10 20, 20 40, 40 40, 30 10))";</span>
<span class="source-line-no">390</span><span id="line-390">    Predicate p = new WithinPredicate(wkt);</span>
<span class="source-line-no">391</span><span id="line-391">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">392</span><span id="line-392">    assertEquals("(contains('" + wkt + "', decimallatitude, decimallongitude) = TRUE)", query);</span>
<span class="source-line-no">393</span><span id="line-393">  }</span>
<span class="source-line-no">394</span><span id="line-394"></span>
<span class="source-line-no">395</span><span id="line-395">  @Test</span>
<span class="source-line-no">396</span><span id="line-396">  public void testLongerWithinPredicate() throws QueryBuildingException {</span>
<span class="source-line-no">397</span><span id="line-397">    final String wkt =</span>
<span class="source-line-no">398</span><span id="line-398">        "POLYGON ((-21.4671921 65.441761, -21.3157028 65.9990267, -22.46732 66.4657148, -23.196803 66.3490242, -22.362113 66.2703732, -22.9758561 66.228119, -22.3831844 66.0933255, -22.424131 65.8374539, -23.4703372 66.1972321, -23.2565264 65.6767322, -24.5319933 65.5027259, -21.684764 65.4547893, -24.0482947 64.8794291, -21.3551366 64.3842337, -22.7053151 63.8001572, -19.1269971 63.3980322, -13.4948065 65.076438, -15.1872897 66.1073781, -14.5302343 66.3783121, -16.0235596 66.5371808, -21.4671921 65.441761))";</span>
<span class="source-line-no">399</span><span id="line-399">    Predicate p = new WithinPredicate(wkt);</span>
<span class="source-line-no">400</span><span id="line-400">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">401</span><span id="line-401">    assertEquals(</span>
<span class="source-line-no">402</span><span id="line-402">        "((decimallatitude &gt;= 63.3980322 AND decimallatitude &lt;= 66.5371808 AND (decimallongitude &gt;= -24.5319933 AND decimallongitude &lt;= -13.4948065)) AND contains('"</span>
<span class="source-line-no">403</span><span id="line-403">            + wkt</span>
<span class="source-line-no">404</span><span id="line-404">            + "', decimallatitude, decimallongitude) = TRUE)",</span>
<span class="source-line-no">405</span><span id="line-405">        query);</span>
<span class="source-line-no">406</span><span id="line-406">  }</span>
<span class="source-line-no">407</span><span id="line-407"></span>
<span class="source-line-no">408</span><span id="line-408">  @Test</span>
<span class="source-line-no">409</span><span id="line-409">  public void testAntimeridianWithinPredicate() throws Exception {</span>
<span class="source-line-no">410</span><span id="line-410">    // A rectangle over the Bering sea, shouldn't have any bounding box added</span>
<span class="source-line-no">411</span><span id="line-411">    String wkt =</span>
<span class="source-line-no">412</span><span id="line-412">        "POLYGON((-206.71875 39.20502, -133.59375 39.20502, -133.59375 77.26611, -206.71875 77.26611, -206.71875 39.20502))";</span>
<span class="source-line-no">413</span><span id="line-413">    String query = visitor.buildQuery(new WithinPredicate(wkt));</span>
<span class="source-line-no">414</span><span id="line-414">    assertEquals("(contains('" + wkt + "', decimallatitude, decimallongitude) = TRUE)", query);</span>
<span class="source-line-no">415</span><span id="line-415">  }</span>
<span class="source-line-no">416</span><span id="line-416"></span>
<span class="source-line-no">417</span><span id="line-417">  @Test</span>
<span class="source-line-no">418</span><span id="line-418">  public void testAddedBoundingBoxes() throws Exception {</span>
<span class="source-line-no">419</span><span id="line-419">    String query;</span>
<span class="source-line-no">420</span><span id="line-420"></span>
<span class="source-line-no">421</span><span id="line-421">    // A multipolygon around Taveuni, split over the antimeridian</span>
<span class="source-line-no">422</span><span id="line-422">    String wktM =</span>
<span class="source-line-no">423</span><span id="line-423">        "MULTIPOLYGON (((180 -16.658979090909092, 180 -17.12485513597339, 179.87915 -17.12058, 179.78577 -16.82899, 179.85168 -16.72643, 180 -16.658979090909092)), ((-180 -17.12485513597339, -180 -16.658979090909092, -179.8764 -16.60277, -179.75006 -16.86054, -179.89838 -17.12845, -180 -17.12485513597339)))";</span>
<span class="source-line-no">424</span><span id="line-424">    String bbox =</span>
<span class="source-line-no">425</span><span id="line-425">        "(decimallatitude &gt;= -17.12845 AND decimallatitude &lt;= -16.60277 AND (decimallongitude &gt;= 179.78577 OR decimallongitude &lt;= -179.75006))";</span>
<span class="source-line-no">426</span><span id="line-426">    query = visitor.buildQuery(new WithinPredicate(wktM));</span>
<span class="source-line-no">427</span><span id="line-427">    assertEquals(</span>
<span class="source-line-no">428</span><span id="line-428">        "(" + bbox + " AND contains('" + wktM + "', decimallatitude, decimallongitude) = TRUE)",</span>
<span class="source-line-no">429</span><span id="line-429">        query);</span>
<span class="source-line-no">430</span><span id="line-430"></span>
<span class="source-line-no">431</span><span id="line-431">    // A polygon around Taveuni, Fiji, as portal16 produces it.</span>
<span class="source-line-no">432</span><span id="line-432">    // Note the result still contains the multipolygon.</span>
<span class="source-line-no">433</span><span id="line-433">    String wkt16 =</span>
<span class="source-line-no">434</span><span id="line-434">        "POLYGON((-180.14832 -16.72643, -180.21423 -16.82899, -180.12085 -17.12058, -179.89838 -17.12845, -179.75006 -16.86054, -179.8764 -16.60277, -180.14832 -16.72643))";</span>
<span class="source-line-no">435</span><span id="line-435">    query = visitor.buildQuery(new WithinPredicate(wkt16));</span>
<span class="source-line-no">436</span><span id="line-436">    assertEquals(</span>
<span class="source-line-no">437</span><span id="line-437">        "(" + bbox + " AND contains('" + wktM + "', decimallatitude, decimallongitude) = TRUE)",</span>
<span class="source-line-no">438</span><span id="line-438">        query);</span>
<span class="source-line-no">439</span><span id="line-439"></span>
<span class="source-line-no">440</span><span id="line-440">    // Same place, but as Wicket draws it:</span>
<span class="source-line-no">441</span><span id="line-441">    // Note the result still contains the same multipolygon.</span>
<span class="source-line-no">442</span><span id="line-442">    String wktWk =</span>
<span class="source-line-no">443</span><span id="line-443">        "POLYGON((179.85168 -16.72643, 179.78577 -16.82899, 179.87915 -17.12058, -179.89838 -17.12845, -179.75006 -16.86054, -179.8764 -16.60277, 179.85168 -16.72643))";</span>
<span class="source-line-no">444</span><span id="line-444">    query = visitor.buildQuery(new WithinPredicate(wktWk));</span>
<span class="source-line-no">445</span><span id="line-445">    assertEquals(</span>
<span class="source-line-no">446</span><span id="line-446">        "(" + bbox + " AND contains('" + wktM + "', decimallatitude, decimallongitude) = TRUE)",</span>
<span class="source-line-no">447</span><span id="line-447">        query);</span>
<span class="source-line-no">448</span><span id="line-448"></span>
<span class="source-line-no">449</span><span id="line-449">    // Tiny areas scattered around the world, all in a single multipolygon.</span>
<span class="source-line-no">450</span><span id="line-450">    // Requires bounding boxes to avoid very slow Hive performance.</span>
<span class="source-line-no">451</span><span id="line-451">    String wktMM =</span>
<span class="source-line-no">452</span><span id="line-452">        "MULTIPOLYGON (((-109.42861 -27.13333, -109.42861 -27.13666, -109.43138 -27.13666, -109.43138 -27.13333, -109.42861 -27.13333)), "</span>
<span class="source-line-no">453</span><span id="line-453">            + "((-109.42236 -27.10919, -109.42236 -27.11191, -109.42541 -27.11191, -109.42541 -27.10919, -109.42236 -27.10919)), "</span>
<span class="source-line-no">454</span><span id="line-454">            + "((-174.35146 -19.80528, -174.35146 -19.81829, -174.36338 -19.81829, -174.36338 -19.80528, -174.35146 -19.80528)), "</span>
<span class="source-line-no">455</span><span id="line-455">            + "((-173.94525 -18.71444, -173.96472 -18.71444, -173.96472 -18.68694, -173.94525 -18.68694, -173.94525 -18.71444)), "</span>
<span class="source-line-no">456</span><span id="line-456">            + "((-173.91655 -18.66372, -173.94041 -18.66372, -173.94041 -18.63616, -173.91655 -18.63616, -173.91655 -18.66372)))";</span>
<span class="source-line-no">457</span><span id="line-457">    String bboxMM =</span>
<span class="source-line-no">458</span><span id="line-458">        "(decimallatitude &gt;= -27.13666 AND decimallatitude &lt;= -18.63616 AND (decimallongitude &gt;= -174.36338 AND decimallongitude &lt;= -109.42236)) AND "</span>
<span class="source-line-no">459</span><span id="line-459">            + "(((decimallatitude &gt;= -27.13666 AND decimallatitude &lt;= -27.13333 AND (decimallongitude &gt;= -109.43138 AND decimallongitude &lt;= -109.42861)) OR "</span>
<span class="source-line-no">460</span><span id="line-460">            + "(decimallatitude &gt;= -27.11191 AND decimallatitude &lt;= -27.10919 AND (decimallongitude &gt;= -109.42541 AND decimallongitude &lt;= -109.42236)) OR "</span>
<span class="source-line-no">461</span><span id="line-461">            + "(decimallatitude &gt;= -19.81829 AND decimallatitude &lt;= -19.80528 AND (decimallongitude &gt;= -174.36338 AND decimallongitude &lt;= -174.35146)) OR "</span>
<span class="source-line-no">462</span><span id="line-462">            + "(decimallatitude &gt;= -18.71444 AND decimallatitude &lt;= -18.68694 AND (decimallongitude &gt;= -173.96472 AND decimallongitude &lt;= -173.94525)) OR "</span>
<span class="source-line-no">463</span><span id="line-463">            + "(decimallatitude &gt;= -18.66372 AND decimallatitude &lt;= -18.63616 AND (decimallongitude &gt;= -173.94041 AND decimallongitude &lt;= -173.91655))))";</span>
<span class="source-line-no">464</span><span id="line-464">    query = visitor.buildQuery(new WithinPredicate(wktMM));</span>
<span class="source-line-no">465</span><span id="line-465">    assertEquals(</span>
<span class="source-line-no">466</span><span id="line-466">        "(" + bboxMM + " AND contains('" + wktMM + "', decimallatitude, decimallongitude) = TRUE)",</span>
<span class="source-line-no">467</span><span id="line-467">        query);</span>
<span class="source-line-no">468</span><span id="line-468">  }</span>
<span class="source-line-no">469</span><span id="line-469"></span>
<span class="source-line-no">470</span><span id="line-470">  @Test</span>
<span class="source-line-no">471</span><span id="line-471">  public void testWidePolygons() throws Exception {</span>
<span class="source-line-no">472</span><span id="line-472">    String query;</span>
<span class="source-line-no">473</span><span id="line-473"></span>
<span class="source-line-no">474</span><span id="line-474">    // A polygon around Antarctica</span>
<span class="source-line-no">475</span><span id="line-475">    String wktP =</span>
<span class="source-line-no">476</span><span id="line-476">        "POLYGON ((180 -64.7, 180 -56.8, 180 -44.3, 173 -44.3, 173 -47.5, 170 -47.5, 157 -47.5, 157 -45.9, 150 -45.9, 150 -47.5, 143 -47.5, 143 -45.8, 140 -45.8, 140 -44.5, 137 -44.5, 137 -43, 135 -43, 135 -41.7, 131 -41.7, 131 -40.1, 115 -40.1, 92 -40.1, 92 -41.4, 78 -41.4, 78 -42.3, 69 -42.3, 69 -43.3, 47 -43.3, 47 -41.7, 30 -41.7, 12 -41.7, 12 -40.3, 10 -40.3, 10 -38.3, -5 -38.3, -5 -38.9, -9 -38.9, -9 -40.2, -13 -40.2, -13 -41.4, -21 -41.4, -21 -42.5, -39 -42.5, -39 -40.7, -49 -40.7, -49 -48.6, -54 -48.6, -54 -55.7, -62.79726 -55.7, -64 -55.7, -64 -57.8, -71 -57.8, -71 -58.9, -80 -58.9, -80 -40, -103.71094 -40.14844, -125 -40, -167 -40, -167 -42.6, -171 -42.6, -171 -44.3, -180 -44.3, -180 -56.8, -180 -64.7, -180 -80, -125 -80, -70 -80, 30 -80, 115 -80, 158 -80, 180 -80, 180 -64.7))";</span>
<span class="source-line-no">477</span><span id="line-477">    query = visitor.buildQuery(new WithinPredicate(wktP));</span>
<span class="source-line-no">478</span><span id="line-478">    assertEquals(</span>
<span class="source-line-no">479</span><span id="line-479">        "((decimallatitude &gt;= -80.0 AND decimallatitude &lt;= -38.3 AND (decimallongitude &gt;= -180.0 AND decimallongitude &lt;= 180.0)) AND contains('"</span>
<span class="source-line-no">480</span><span id="line-480">            + wktP</span>
<span class="source-line-no">481</span><span id="line-481">            + "', decimallatitude, decimallongitude) = TRUE)",</span>
<span class="source-line-no">482</span><span id="line-482">        query);</span>
<span class="source-line-no">483</span><span id="line-483"></span>
<span class="source-line-no">484</span><span id="line-484">    // A multipolygon around the Pacific and Indian oceans, split over the antimeridian</span>
<span class="source-line-no">485</span><span id="line-485">    String wktM =</span>
<span class="source-line-no">486</span><span id="line-486">        "MULTIPOLYGON (((180 51.83076923076923, 180 -63, 35 -63, 60 -9, 127 1, 157 49, 180 51.83076923076923)), ((-180 -63, -180 51.83076923076923, -138 57, -127 39, -112 18, -92 13, -84 1, -77 -63, -169 -63, -180 -63)))";</span>
<span class="source-line-no">487</span><span id="line-487">    String bbox =</span>
<span class="source-line-no">488</span><span id="line-488">        "(decimallatitude &gt;= -63.0 AND decimallatitude &lt;= 57.0 AND (decimallongitude &gt;= 35.0 OR decimallongitude &lt;= -77.0))";</span>
<span class="source-line-no">489</span><span id="line-489">    query = visitor.buildQuery(new WithinPredicate(wktM));</span>
<span class="source-line-no">490</span><span id="line-490">    assertEquals(</span>
<span class="source-line-no">491</span><span id="line-491">        "(" + bbox + " AND contains('" + wktM + "', decimallatitude, decimallongitude) = TRUE)",</span>
<span class="source-line-no">492</span><span id="line-492">        query);</span>
<span class="source-line-no">493</span><span id="line-493"></span>
<span class="source-line-no">494</span><span id="line-494">    // The same polygon, as portal16 produces it.</span>
<span class="source-line-no">495</span><span id="line-495">    // Note the result still contains the multipolygon.</span>
<span class="source-line-no">496</span><span id="line-496">    String wkt16 =</span>
<span class="source-line-no">497</span><span id="line-497">        "POLYGON((35.0 -63.0, 191.0 -63.0, 283.0 -63.0, 276.0 1.0, 268.0 13.0, 248.0 18.0, 233.0 39.0, 222.0 57.0, 157.0 49.0, 127.0 1.0, 60.0 -9.0, 35.0 -63.0))";</span>
<span class="source-line-no">498</span><span id="line-498">    query = visitor.buildQuery(new WithinPredicate(wkt16));</span>
<span class="source-line-no">499</span><span id="line-499">    assertEquals(</span>
<span class="source-line-no">500</span><span id="line-500">        "(" + bbox + " AND contains('" + wktM + "', decimallatitude, decimallongitude) = TRUE)",</span>
<span class="source-line-no">501</span><span id="line-501">        query);</span>
<span class="source-line-no">502</span><span id="line-502"></span>
<span class="source-line-no">503</span><span id="line-503">    // A polygon around the Pacific, as Wicket draws it:</span>
<span class="source-line-no">504</span><span id="line-504">    String wktWk =</span>
<span class="source-line-no">505</span><span id="line-505">        "POLYGON((157.0 49.0,127.0 1.0,60.0 -9.0,35.0 -63.0,-169.0 -63.0,-77.0 -63.0,-84.0 1.0,-92.0 13.0,-112.0 18.0,-127.0 39.0,-138.0 57.0,157.0 49.0))";</span>
<span class="source-line-no">506</span><span id="line-506">    assertEquals(</span>
<span class="source-line-no">507</span><span id="line-507">        "(" + bbox + " AND contains('" + wktM + "', decimallatitude, decimallongitude) = TRUE)",</span>
<span class="source-line-no">508</span><span id="line-508">        query);</span>
<span class="source-line-no">509</span><span id="line-509">  }</span>
<span class="source-line-no">510</span><span id="line-510"></span>
<span class="source-line-no">511</span><span id="line-511">  @Test</span>
<span class="source-line-no">512</span><span id="line-512">  public void testIsNotNullPredicate() throws QueryBuildingException {</span>
<span class="source-line-no">513</span><span id="line-513">    Predicate p = new IsNotNullPredicate&lt;&gt;(PARAM);</span>
<span class="source-line-no">514</span><span id="line-514">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">515</span><span id="line-515">    assertEquals("catalognumber IS NOT NULL", query);</span>
<span class="source-line-no">516</span><span id="line-516">  }</span>
<span class="source-line-no">517</span><span id="line-517"></span>
<span class="source-line-no">518</span><span id="line-518">  @Test</span>
<span class="source-line-no">519</span><span id="line-519">  public void testIsArrayNotNullPredicate() throws QueryBuildingException {</span>
<span class="source-line-no">520</span><span id="line-520">    Predicate p = new IsNotNullPredicate&lt;&gt;(OccurrenceSearchParameter.IDENTIFIED_BY_ID);</span>
<span class="source-line-no">521</span><span id="line-521">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">522</span><span id="line-522">    assertEquals("(identifiedbyid IS NOT NULL AND size(identifiedbyid) &gt; 0)", query);</span>
<span class="source-line-no">523</span><span id="line-523">  }</span>
<span class="source-line-no">524</span><span id="line-524"></span>
<span class="source-line-no">525</span><span id="line-525">  @Test</span>
<span class="source-line-no">526</span><span id="line-526">  public void testIsVocabularyNotNullPredicate() throws QueryBuildingException {</span>
<span class="source-line-no">527</span><span id="line-527">    Predicate p = new IsNotNullPredicate&lt;&gt;(OccurrenceSearchParameter.LIFE_STAGE);</span>
<span class="source-line-no">528</span><span id="line-528">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">529</span><span id="line-529">    assertEquals("(lifestage.lineage IS NOT NULL AND size(lifestage.lineage) &gt; 0)", query);</span>
<span class="source-line-no">530</span><span id="line-530">  }</span>
<span class="source-line-no">531</span><span id="line-531"></span>
<span class="source-line-no">532</span><span id="line-532">  @Test</span>
<span class="source-line-no">533</span><span id="line-533">  public void testIsNotNullPredicateGadmGid() throws QueryBuildingException {</span>
<span class="source-line-no">534</span><span id="line-534">    Predicate p = new IsNotNullPredicate&lt;&gt;(OccurrenceSearchParameter.GADM_GID);</span>
<span class="source-line-no">535</span><span id="line-535">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">536</span><span id="line-536">    assertEquals(</span>
<span class="source-line-no">537</span><span id="line-537">        "(level0gid IS NOT NULL AND level1gid IS NOT NULL AND level2gid IS NOT NULL AND level3gid IS NOT NULL)",</span>
<span class="source-line-no">538</span><span id="line-538">        query);</span>
<span class="source-line-no">539</span><span id="line-539">  }</span>
<span class="source-line-no">540</span><span id="line-540"></span>
<span class="source-line-no">541</span><span id="line-541">  @Test</span>
<span class="source-line-no">542</span><span id="line-542">  public void testIsNullPredicate() throws QueryBuildingException {</span>
<span class="source-line-no">543</span><span id="line-543">    Predicate p = new IsNullPredicate&lt;&gt;(PARAM);</span>
<span class="source-line-no">544</span><span id="line-544">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">545</span><span id="line-545">    assertEquals("catalognumber IS NULL", query);</span>
<span class="source-line-no">546</span><span id="line-546">  }</span>
<span class="source-line-no">547</span><span id="line-547"></span>
<span class="source-line-no">548</span><span id="line-548">  @Test</span>
<span class="source-line-no">549</span><span id="line-549">  public void testIsNullPredicateGadmGid() throws QueryBuildingException {</span>
<span class="source-line-no">550</span><span id="line-550">    Predicate p = new IsNullPredicate&lt;&gt;(OccurrenceSearchParameter.GADM_GID);</span>
<span class="source-line-no">551</span><span id="line-551">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">552</span><span id="line-552">    assertEquals(</span>
<span class="source-line-no">553</span><span id="line-553">        "(level0gid IS NULL AND level1gid IS NULL AND level2gid IS NULL AND level3gid IS NULL)",</span>
<span class="source-line-no">554</span><span id="line-554">        query);</span>
<span class="source-line-no">555</span><span id="line-555">  }</span>
<span class="source-line-no">556</span><span id="line-556"></span>
<span class="source-line-no">557</span><span id="line-557">  @Test</span>
<span class="source-line-no">558</span><span id="line-558">  public void testIsArrayNullPredicate() throws QueryBuildingException {</span>
<span class="source-line-no">559</span><span id="line-559">    Predicate p = new IsNullPredicate&lt;&gt;(OccurrenceSearchParameter.IDENTIFIED_BY_ID);</span>
<span class="source-line-no">560</span><span id="line-560">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">561</span><span id="line-561">    assertEquals("(identifiedbyid IS NULL OR size(identifiedbyid) = 0)", query);</span>
<span class="source-line-no">562</span><span id="line-562">  }</span>
<span class="source-line-no">563</span><span id="line-563"></span>
<span class="source-line-no">564</span><span id="line-564">  @Test</span>
<span class="source-line-no">565</span><span id="line-565">  public void testIsVocabularyNullPredicate() throws QueryBuildingException {</span>
<span class="source-line-no">566</span><span id="line-566">    Predicate p = new IsNullPredicate&lt;&gt;(OccurrenceSearchParameter.LIFE_STAGE);</span>
<span class="source-line-no">567</span><span id="line-567">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">568</span><span id="line-568">    assertEquals("lifestage.lineage IS NULL", query);</span>
<span class="source-line-no">569</span><span id="line-569">  }</span>
<span class="source-line-no">570</span><span id="line-570"></span>
<span class="source-line-no">571</span><span id="line-571">  @Test</span>
<span class="source-line-no">572</span><span id="line-572">  public void testIsNotNullTaxonKey() throws QueryBuildingException {</span>
<span class="source-line-no">573</span><span id="line-573">    Predicate p = new IsNotNullPredicate&lt;&gt;(OccurrenceSearchParameter.TAXON_KEY);</span>
<span class="source-line-no">574</span><span id="line-574">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">575</span><span id="line-575">    assertEquals(</span>
<span class="source-line-no">576</span><span id="line-576">        "(taxonkey IS NOT NULL AND acceptedtaxonkey IS NOT NULL AND kingdomkey IS NOT NULL AND phylumkey IS NOT NULL AND classkey IS NOT NULL AND orderkey IS NOT NULL AND familykey IS NOT NULL AND genuskey IS NOT NULL AND specieskey IS NOT NULL)",</span>
<span class="source-line-no">577</span><span id="line-577">        query);</span>
<span class="source-line-no">578</span><span id="line-578">  }</span>
<span class="source-line-no">579</span><span id="line-579"></span>
<span class="source-line-no">580</span><span id="line-580">  @Test</span>
<span class="source-line-no">581</span><span id="line-581">  public void testIsNullTaxonKey() throws QueryBuildingException {</span>
<span class="source-line-no">582</span><span id="line-582">    Predicate p = new IsNullPredicate&lt;&gt;(OccurrenceSearchParameter.TAXON_KEY);</span>
<span class="source-line-no">583</span><span id="line-583">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">584</span><span id="line-584">    assertEquals(</span>
<span class="source-line-no">585</span><span id="line-585">        "(taxonkey IS NULL AND acceptedtaxonkey IS NULL AND kingdomkey IS NULL AND phylumkey IS NULL AND classkey IS NULL AND orderkey IS NULL AND familykey IS NULL AND genuskey IS NULL AND specieskey IS NULL)",</span>
<span class="source-line-no">586</span><span id="line-586">        query);</span>
<span class="source-line-no">587</span><span id="line-587">  }</span>
<span class="source-line-no">588</span><span id="line-588"></span>
<span class="source-line-no">589</span><span id="line-589">  @Test</span>
<span class="source-line-no">590</span><span id="line-590">  public void testIsNotNullArrayPredicate() throws QueryBuildingException {</span>
<span class="source-line-no">591</span><span id="line-591">    Predicate p = new IsNotNullPredicate&lt;&gt;(OccurrenceSearchParameter.MEDIA_TYPE);</span>
<span class="source-line-no">592</span><span id="line-592">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">593</span><span id="line-593">    assertEquals("(mediatype IS NOT NULL AND size(mediatype) &gt; 0)", query);</span>
<span class="source-line-no">594</span><span id="line-594">  }</span>
<span class="source-line-no">595</span><span id="line-595"></span>
<span class="source-line-no">596</span><span id="line-596">  @Test</span>
<span class="source-line-no">597</span><span id="line-597">  public void testPartialDates() throws QueryBuildingException {</span>
<span class="source-line-no">598</span><span id="line-598">    testPartialDate("2021-10-25T00:00:00Z", "2021-10-26T00:00:00Z", "2021-10-25");</span>
<span class="source-line-no">599</span><span id="line-599">    testPartialDate("2014-10-01T00:00:00Z", "2014-11-01T00:00:00Z", "2014-10");</span>
<span class="source-line-no">600</span><span id="line-600">    testPartialDate("1936-01-01T00:00:00Z", "1937-01-01T00:00:00Z", "1936");</span>
<span class="source-line-no">601</span><span id="line-601">  }</span>
<span class="source-line-no">602</span><span id="line-602"></span>
<span class="source-line-no">603</span><span id="line-603">  @Test</span>
<span class="source-line-no">604</span><span id="line-604">  public void testDateRanges() throws QueryBuildingException {</span>
<span class="source-line-no">605</span><span id="line-605">    testPartialDate("2021-10-25T00:00:00Z", "2021-10-26T00:00:00Z", "2021-10-25,2021-10-25");</span>
<span class="source-line-no">606</span><span id="line-606">    testPartialDate("2021-10-25T00:00:00Z", "2021-10-27T00:00:00Z", "2021-10-25,2021-10-26");</span>
<span class="source-line-no">607</span><span id="line-607">    testPartialDate("2014-05-01T00:00:00Z", "2014-07-01T00:00:00Z", "2014-05,2014-06");</span>
<span class="source-line-no">608</span><span id="line-608">    testPartialDate("1936-01-01T00:00:00Z", "1941-01-01T00:00:00Z", "1936,1940");</span>
<span class="source-line-no">609</span><span id="line-609">    testPartialDate("1940-01-01T00:00:00Z", null, "1940,*");</span>
<span class="source-line-no">610</span><span id="line-610">    testPartialDate(null, "1941-01-01T00:00:00Z", "*,1940");</span>
<span class="source-line-no">611</span><span id="line-611">    testPartialDate(null, null, "*,*");</span>
<span class="source-line-no">612</span><span id="line-612">  }</span>
<span class="source-line-no">613</span><span id="line-613"></span>
<span class="source-line-no">614</span><span id="line-614">  @Test</span>
<span class="source-line-no">615</span><span id="line-615">  public void testDateComparisons() throws QueryBuildingException {</span>
<span class="source-line-no">616</span><span id="line-616">    Predicate p = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.LAST_INTERPRETED, "2000", false);</span>
<span class="source-line-no">617</span><span id="line-617">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">618</span><span id="line-618">    assertEquals(</span>
<span class="source-line-no">619</span><span id="line-619">        String.format(</span>
<span class="source-line-no">620</span><span id="line-620">            "(lastinterpreted &gt;= %s AND lastinterpreted &lt; %s)",</span>
<span class="source-line-no">621</span><span id="line-621">            Instant.parse("2000-01-01T00:00:00Z").toEpochMilli(),</span>
<span class="source-line-no">622</span><span id="line-622">            Instant.parse("2001-01-01T00:00:00Z").toEpochMilli()),</span>
<span class="source-line-no">623</span><span id="line-623">        query);</span>
<span class="source-line-no">624</span><span id="line-624"></span>
<span class="source-line-no">625</span><span id="line-625">    // Include the range</span>
<span class="source-line-no">626</span><span id="line-626">    p = new LessThanOrEqualsPredicate&lt;&gt;(OccurrenceSearchParameter.LAST_INTERPRETED, "2000");</span>
<span class="source-line-no">627</span><span id="line-627">    query = visitor.buildQuery(p);</span>
<span class="source-line-no">628</span><span id="line-628">    assertEquals(</span>
<span class="source-line-no">629</span><span id="line-629">        String.format("lastinterpreted &lt; %s", Instant.parse("2001-01-01T00:00:00Z").toEpochMilli()),</span>
<span class="source-line-no">630</span><span id="line-630">        query);</span>
<span class="source-line-no">631</span><span id="line-631"></span>
<span class="source-line-no">632</span><span id="line-632">    p = new GreaterThanOrEqualsPredicate&lt;&gt;(OccurrenceSearchParameter.LAST_INTERPRETED, "2000");</span>
<span class="source-line-no">633</span><span id="line-633">    query = visitor.buildQuery(p);</span>
<span class="source-line-no">634</span><span id="line-634">    assertEquals(</span>
<span class="source-line-no">635</span><span id="line-635">        String.format(</span>
<span class="source-line-no">636</span><span id="line-636">            "lastinterpreted &gt;= %s", Instant.parse("2000-01-01T00:00:00Z").toEpochMilli()),</span>
<span class="source-line-no">637</span><span id="line-637">        query);</span>
<span class="source-line-no">638</span><span id="line-638"></span>
<span class="source-line-no">639</span><span id="line-639">    // Exclude the range</span>
<span class="source-line-no">640</span><span id="line-640">    p = new LessThanPredicate&lt;&gt;(OccurrenceSearchParameter.LAST_INTERPRETED, "2000");</span>
<span class="source-line-no">641</span><span id="line-641">    query = visitor.buildQuery(p);</span>
<span class="source-line-no">642</span><span id="line-642">    assertEquals(</span>
<span class="source-line-no">643</span><span id="line-643">        String.format("lastinterpreted &lt; %s", Instant.parse("2000-01-01T00:00:00Z").toEpochMilli()),</span>
<span class="source-line-no">644</span><span id="line-644">        query);</span>
<span class="source-line-no">645</span><span id="line-645"></span>
<span class="source-line-no">646</span><span id="line-646">    p = new GreaterThanPredicate&lt;&gt;(OccurrenceSearchParameter.LAST_INTERPRETED, "2000");</span>
<span class="source-line-no">647</span><span id="line-647">    query = visitor.buildQuery(p);</span>
<span class="source-line-no">648</span><span id="line-648">    assertEquals(</span>
<span class="source-line-no">649</span><span id="line-649">        String.format(</span>
<span class="source-line-no">650</span><span id="line-650">            "lastinterpreted &gt;= %s", Instant.parse("2001-01-01T00:00:00Z").toEpochMilli()),</span>
<span class="source-line-no">651</span><span id="line-651">        query);</span>
<span class="source-line-no">652</span><span id="line-652">  }</span>
<span class="source-line-no">653</span><span id="line-653"></span>
<span class="source-line-no">654</span><span id="line-654">  @Test</span>
<span class="source-line-no">655</span><span id="line-655">  public void testDateRangeComparisons() throws QueryBuildingException {</span>
<span class="source-line-no">656</span><span id="line-656">    Predicate p = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.EVENT_DATE, "2000-01-02", false);</span>
<span class="source-line-no">657</span><span id="line-657">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">658</span><span id="line-658">    assertEquals(</span>
<span class="source-line-no">659</span><span id="line-659">        String.format(</span>
<span class="source-line-no">660</span><span id="line-660">            "(eventdategte &gt;= %s AND eventdatelte &lt; %s)",</span>
<span class="source-line-no">661</span><span id="line-661">            Instant.parse("2000-01-02T00:00:00Z").getEpochSecond(),</span>
<span class="source-line-no">662</span><span id="line-662">            Instant.parse("2000-01-03T00:00:00Z").getEpochSecond()),</span>
<span class="source-line-no">663</span><span id="line-663">        query);</span>
<span class="source-line-no">664</span><span id="line-664"></span>
<span class="source-line-no">665</span><span id="line-665">    p = new InPredicate&lt;&gt;(OccurrenceSearchParameter.EVENT_DATE, Arrays.asList("2000-01-02"), false);</span>
<span class="source-line-no">666</span><span id="line-666">    query = visitor.buildQuery(p);</span>
<span class="source-line-no">667</span><span id="line-667">    assertEquals(</span>
<span class="source-line-no">668</span><span id="line-668">        String.format(</span>
<span class="source-line-no">669</span><span id="line-669">            "((eventdategte &gt;= %s AND eventdatelte &lt; %s))",</span>
<span class="source-line-no">670</span><span id="line-670">            Instant.parse("2000-01-02T00:00:00Z").getEpochSecond(),</span>
<span class="source-line-no">671</span><span id="line-671">            Instant.parse("2000-01-03T00:00:00Z").getEpochSecond()),</span>
<span class="source-line-no">672</span><span id="line-672">        query);</span>
<span class="source-line-no">673</span><span id="line-673"></span>
<span class="source-line-no">674</span><span id="line-674">    p =</span>
<span class="source-line-no">675</span><span id="line-675">        new InPredicate&lt;&gt;(</span>
<span class="source-line-no">676</span><span id="line-676">            OccurrenceSearchParameter.EVENT_DATE, Arrays.asList("2000-01-02", "2024-01-17"), false);</span>
<span class="source-line-no">677</span><span id="line-677">    query = visitor.buildQuery(p);</span>
<span class="source-line-no">678</span><span id="line-678">    assertEquals(</span>
<span class="source-line-no">679</span><span id="line-679">        String.format(</span>
<span class="source-line-no">680</span><span id="line-680">            "((eventdategte &gt;= %s AND eventdatelte &lt; %s) OR (eventdategte &gt;= %s AND eventdatelte &lt; %s))",</span>
<span class="source-line-no">681</span><span id="line-681">            Instant.parse("2000-01-02T00:00:00Z").getEpochSecond(),</span>
<span class="source-line-no">682</span><span id="line-682">            Instant.parse("2000-01-03T00:00:00Z").getEpochSecond(),</span>
<span class="source-line-no">683</span><span id="line-683">            Instant.parse("2024-01-17T00:00:00Z").getEpochSecond(),</span>
<span class="source-line-no">684</span><span id="line-684">            Instant.parse("2024-01-18T00:00:00Z").getEpochSecond()),</span>
<span class="source-line-no">685</span><span id="line-685">        query);</span>
<span class="source-line-no">686</span><span id="line-686"></span>
<span class="source-line-no">687</span><span id="line-687">    p = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.EVENT_DATE, "2000-01-02,2000-01-04", false);</span>
<span class="source-line-no">688</span><span id="line-688">    query = visitor.buildQuery(p);</span>
<span class="source-line-no">689</span><span id="line-689">    assertEquals(</span>
<span class="source-line-no">690</span><span id="line-690">        String.format(</span>
<span class="source-line-no">691</span><span id="line-691">            "(eventdategte &gt;= %s AND eventdatelte &lt; %s)",</span>
<span class="source-line-no">692</span><span id="line-692">            Instant.parse("2000-01-02T00:00:00Z").getEpochSecond(),</span>
<span class="source-line-no">693</span><span id="line-693">            Instant.parse("2000-01-05T00:00:00Z").getEpochSecond()),</span>
<span class="source-line-no">694</span><span id="line-694">        query);</span>
<span class="source-line-no">695</span><span id="line-695"></span>
<span class="source-line-no">696</span><span id="line-696">    p = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.EVENT_DATE, "2000-01", false);</span>
<span class="source-line-no">697</span><span id="line-697">    query = visitor.buildQuery(p);</span>
<span class="source-line-no">698</span><span id="line-698">    assertEquals(</span>
<span class="source-line-no">699</span><span id="line-699">        String.format(</span>
<span class="source-line-no">700</span><span id="line-700">            "(eventdategte &gt;= %s AND eventdatelte &lt; %s)",</span>
<span class="source-line-no">701</span><span id="line-701">            Instant.parse("2000-01-01T00:00:00Z").getEpochSecond(),</span>
<span class="source-line-no">702</span><span id="line-702">            Instant.parse("2000-02-01T00:00:00Z").getEpochSecond()),</span>
<span class="source-line-no">703</span><span id="line-703">        query);</span>
<span class="source-line-no">704</span><span id="line-704"></span>
<span class="source-line-no">705</span><span id="line-705">    p = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.EVENT_DATE, "2000-01,2000-03", false);</span>
<span class="source-line-no">706</span><span id="line-706">    query = visitor.buildQuery(p);</span>
<span class="source-line-no">707</span><span id="line-707">    assertEquals(</span>
<span class="source-line-no">708</span><span id="line-708">        String.format(</span>
<span class="source-line-no">709</span><span id="line-709">            "(eventdategte &gt;= %s AND eventdatelte &lt; %s)",</span>
<span class="source-line-no">710</span><span id="line-710">            Instant.parse("2000-01-01T00:00:00Z").getEpochSecond(),</span>
<span class="source-line-no">711</span><span id="line-711">            Instant.parse("2000-04-01T00:00:00Z").getEpochSecond()),</span>
<span class="source-line-no">712</span><span id="line-712">        query);</span>
<span class="source-line-no">713</span><span id="line-713"></span>
<span class="source-line-no">714</span><span id="line-714">    p = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.EVENT_DATE, "2000", false);</span>
<span class="source-line-no">715</span><span id="line-715">    query = visitor.buildQuery(p);</span>
<span class="source-line-no">716</span><span id="line-716">    assertEquals(</span>
<span class="source-line-no">717</span><span id="line-717">        String.format(</span>
<span class="source-line-no">718</span><span id="line-718">            "(eventdategte &gt;= %s AND eventdatelte &lt; %s)",</span>
<span class="source-line-no">719</span><span id="line-719">            Instant.parse("2000-01-01T00:00:00Z").getEpochSecond(),</span>
<span class="source-line-no">720</span><span id="line-720">            Instant.parse("2001-01-01T00:00:00Z").getEpochSecond()),</span>
<span class="source-line-no">721</span><span id="line-721">        query);</span>
<span class="source-line-no">722</span><span id="line-722"></span>
<span class="source-line-no">723</span><span id="line-723">    p = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.EVENT_DATE, "2000,2001", false);</span>
<span class="source-line-no">724</span><span id="line-724">    query = visitor.buildQuery(p);</span>
<span class="source-line-no">725</span><span id="line-725">    assertEquals(</span>
<span class="source-line-no">726</span><span id="line-726">        String.format(</span>
<span class="source-line-no">727</span><span id="line-727">            "(eventdategte &gt;= %s AND eventdatelte &lt; %s)",</span>
<span class="source-line-no">728</span><span id="line-728">            Instant.parse("2000-01-01T00:00:00Z").getEpochSecond(),</span>
<span class="source-line-no">729</span><span id="line-729">            Instant.parse("2002-01-01T00:00:00Z").getEpochSecond()),</span>
<span class="source-line-no">730</span><span id="line-730">        query);</span>
<span class="source-line-no">731</span><span id="line-731"></span>
<span class="source-line-no">732</span><span id="line-732">    // Include the range (for the or-equal-to)</span>
<span class="source-line-no">733</span><span id="line-733">    p = new LessThanOrEqualsPredicate&lt;&gt;(OccurrenceSearchParameter.EVENT_DATE, "2000");</span>
<span class="source-line-no">734</span><span id="line-734">    query = visitor.buildQuery(p);</span>
<span class="source-line-no">735</span><span id="line-735">    assertEquals(</span>
<span class="source-line-no">736</span><span id="line-736">        String.format("eventdategte &lt; %s", Instant.parse("2001-01-01T00:00:00Z").getEpochSecond()),</span>
<span class="source-line-no">737</span><span id="line-737">        query);</span>
<span class="source-line-no">738</span><span id="line-738"></span>
<span class="source-line-no">739</span><span id="line-739">    p = new GreaterThanOrEqualsPredicate&lt;&gt;(OccurrenceSearchParameter.EVENT_DATE, "2000");</span>
<span class="source-line-no">740</span><span id="line-740">    query = visitor.buildQuery(p);</span>
<span class="source-line-no">741</span><span id="line-741">    assertEquals(</span>
<span class="source-line-no">742</span><span id="line-742">        String.format("eventdatelte &gt;= %s", Instant.parse("2000-01-01T00:00:00Z").getEpochSecond()),</span>
<span class="source-line-no">743</span><span id="line-743">        query);</span>
<span class="source-line-no">744</span><span id="line-744"></span>
<span class="source-line-no">745</span><span id="line-745">    // Exclude the range</span>
<span class="source-line-no">746</span><span id="line-746">    p = new LessThanPredicate&lt;&gt;(OccurrenceSearchParameter.EVENT_DATE, "2000");</span>
<span class="source-line-no">747</span><span id="line-747">    query = visitor.buildQuery(p);</span>
<span class="source-line-no">748</span><span id="line-748">    assertEquals(</span>
<span class="source-line-no">749</span><span id="line-749">        String.format("eventdategte &lt; %s", Instant.parse("2000-01-01T00:00:00Z").getEpochSecond()),</span>
<span class="source-line-no">750</span><span id="line-750">        query);</span>
<span class="source-line-no">751</span><span id="line-751"></span>
<span class="source-line-no">752</span><span id="line-752">    p = new GreaterThanPredicate&lt;&gt;(OccurrenceSearchParameter.EVENT_DATE, "2000");</span>
<span class="source-line-no">753</span><span id="line-753">    query = visitor.buildQuery(p);</span>
<span class="source-line-no">754</span><span id="line-754">    assertEquals(</span>
<span class="source-line-no">755</span><span id="line-755">        String.format("eventdatelte &gt;= %s", Instant.parse("2001-01-01T00:00:00Z").getEpochSecond()),</span>
<span class="source-line-no">756</span><span id="line-756">        query);</span>
<span class="source-line-no">757</span><span id="line-757">  }</span>
<span class="source-line-no">758</span><span id="line-758"></span>
<span class="source-line-no">759</span><span id="line-759">  /** Reusable method to test partial dates, i.e., dates with the format: yyyy, yyyy-MM. */</span>
<span class="source-line-no">760</span><span id="line-760">  private void testPartialDate(String expectedFrom, String expectedTo, String value)</span>
<span class="source-line-no">761</span><span id="line-761">      throws QueryBuildingException {</span>
<span class="source-line-no">762</span><span id="line-762">    Range&lt;Instant&gt; range =</span>
<span class="source-line-no">763</span><span id="line-763">        Range.closed(</span>
<span class="source-line-no">764</span><span id="line-764">            expectedFrom == null ? null : Instant.parse(expectedFrom),</span>
<span class="source-line-no">765</span><span id="line-765">            expectedTo == null ? null : Instant.parse(expectedTo));</span>
<span class="source-line-no">766</span><span id="line-766"></span>
<span class="source-line-no">767</span><span id="line-767">    Predicate p = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.LAST_INTERPRETED, value, false);</span>
<span class="source-line-no">768</span><span id="line-768">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">769</span><span id="line-769"></span>
<span class="source-line-no">770</span><span id="line-770">    if (!range.hasUpperBound() &amp;&amp; !range.hasLowerBound()) {</span>
<span class="source-line-no">771</span><span id="line-771">      assertEquals("", query);</span>
<span class="source-line-no">772</span><span id="line-772">    } else if (!range.hasUpperBound()) {</span>
<span class="source-line-no">773</span><span id="line-773">      assertEquals(</span>
<span class="source-line-no">774</span><span id="line-774">          String.format("(lastinterpreted &gt;= %s)", range.lowerEndpoint().toEpochMilli()), query);</span>
<span class="source-line-no">775</span><span id="line-775">    } else if (!range.hasLowerBound()) {</span>
<span class="source-line-no">776</span><span id="line-776">      assertEquals(</span>
<span class="source-line-no">777</span><span id="line-777">          String.format("(lastinterpreted &lt; %s)", range.upperEndpoint().toEpochMilli()), query);</span>
<span class="source-line-no">778</span><span id="line-778">    } else {</span>
<span class="source-line-no">779</span><span id="line-779">      assertEquals(</span>
<span class="source-line-no">780</span><span id="line-780">          String.format(</span>
<span class="source-line-no">781</span><span id="line-781">              "(lastinterpreted &gt;= %s AND lastinterpreted &lt; %s)",</span>
<span class="source-line-no">782</span><span id="line-782">              range.lowerEndpoint().toEpochMilli(), range.upperEndpoint().toEpochMilli()),</span>
<span class="source-line-no">783</span><span id="line-783">          query);</span>
<span class="source-line-no">784</span><span id="line-784">    }</span>
<span class="source-line-no">785</span><span id="line-785">  }</span>
<span class="source-line-no">786</span><span id="line-786"></span>
<span class="source-line-no">787</span><span id="line-787">  /** Some dates in HDFS are a number of seconds, others a number of milliseconds. */</span>
<span class="source-line-no">788</span><span id="line-788">  @Test</span>
<span class="source-line-no">789</span><span id="line-789">  public void testDateMagnitude() throws QueryBuildingException {</span>
<span class="source-line-no">790</span><span id="line-790">    Predicate p = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.EVENT_DATE, "2000-01-02", false);</span>
<span class="source-line-no">791</span><span id="line-791">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">792</span><span id="line-792">    assertEquals(</span>
<span class="source-line-no">793</span><span id="line-793">        String.format(</span>
<span class="source-line-no">794</span><span id="line-794">            "(eventdategte &gt;= %s AND eventdatelte &lt; %s)",</span>
<span class="source-line-no">795</span><span id="line-795">            Instant.parse("2000-01-02T00:00:00Z").getEpochSecond(),</span>
<span class="source-line-no">796</span><span id="line-796">            Instant.parse("2000-01-03T00:00:00Z").getEpochSecond()),</span>
<span class="source-line-no">797</span><span id="line-797">        query);</span>
<span class="source-line-no">798</span><span id="line-798"></span>
<span class="source-line-no">799</span><span id="line-799">    p = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.LAST_INTERPRETED, "2000-01-02", false);</span>
<span class="source-line-no">800</span><span id="line-800">    query = visitor.buildQuery(p);</span>
<span class="source-line-no">801</span><span id="line-801">    assertEquals(</span>
<span class="source-line-no">802</span><span id="line-802">        String.format(</span>
<span class="source-line-no">803</span><span id="line-803">            "(lastinterpreted &gt;= %s AND lastinterpreted &lt; %s)",</span>
<span class="source-line-no">804</span><span id="line-804">            Instant.parse("2000-01-02T00:00:00Z").toEpochMilli(),</span>
<span class="source-line-no">805</span><span id="line-805">            Instant.parse("2000-01-03T00:00:00Z").toEpochMilli()),</span>
<span class="source-line-no">806</span><span id="line-806">        query);</span>
<span class="source-line-no">807</span><span id="line-807"></span>
<span class="source-line-no">808</span><span id="line-808">    p = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.MODIFIED, "2000-01-02", false);</span>
<span class="source-line-no">809</span><span id="line-809">    query = visitor.buildQuery(p);</span>
<span class="source-line-no">810</span><span id="line-810">    assertEquals(</span>
<span class="source-line-no">811</span><span id="line-811">        String.format(</span>
<span class="source-line-no">812</span><span id="line-812">            "(modified &gt;= %s AND modified &lt; %s)",</span>
<span class="source-line-no">813</span><span id="line-813">            Instant.parse("2000-01-02T00:00:00Z").getEpochSecond(),</span>
<span class="source-line-no">814</span><span id="line-814">            Instant.parse("2000-01-03T00:00:00Z").getEpochSecond()),</span>
<span class="source-line-no">815</span><span id="line-815">        query);</span>
<span class="source-line-no">816</span><span id="line-816">  }</span>
<span class="source-line-no">817</span><span id="line-817"></span>
<span class="source-line-no">818</span><span id="line-818">  @Test</span>
<span class="source-line-no">819</span><span id="line-819">  public void testIntRanges() throws QueryBuildingException {</span>
<span class="source-line-no">820</span><span id="line-820"></span>
<span class="source-line-no">821</span><span id="line-821">    String value = "1990,2011";</span>
<span class="source-line-no">822</span><span id="line-822">    Range&lt;Integer&gt; range = SearchTypeValidator.parseIntegerRange(value);</span>
<span class="source-line-no">823</span><span id="line-823"></span>
<span class="source-line-no">824</span><span id="line-824">    Predicate p = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.YEAR, value, false);</span>
<span class="source-line-no">825</span><span id="line-825">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">826</span><span id="line-826"></span>
<span class="source-line-no">827</span><span id="line-827">    if (!range.hasUpperBound()) {</span>
<span class="source-line-no">828</span><span id="line-828">      assertEquals(String.format("year &gt;= %s", range.lowerEndpoint().intValue()), query);</span>
<span class="source-line-no">829</span><span id="line-829">    } else if (!range.hasLowerBound()) {</span>
<span class="source-line-no">830</span><span id="line-830">      assertEquals(String.format("year &lt;= %s", range.upperEndpoint().intValue()), query);</span>
<span class="source-line-no">831</span><span id="line-831">    } else {</span>
<span class="source-line-no">832</span><span id="line-832">      assertEquals(</span>
<span class="source-line-no">833</span><span id="line-833">          String.format(</span>
<span class="source-line-no">834</span><span id="line-834">              "((year &gt;= %s) AND (year &lt;= %s))",</span>
<span class="source-line-no">835</span><span id="line-835">              range.lowerEndpoint().intValue(), range.upperEndpoint().intValue()),</span>
<span class="source-line-no">836</span><span id="line-836">          query);</span>
<span class="source-line-no">837</span><span id="line-837">    }</span>
<span class="source-line-no">838</span><span id="line-838">  }</span>
<span class="source-line-no">839</span><span id="line-839"></span>
<span class="source-line-no">840</span><span id="line-840">  @Test</span>
<span class="source-line-no">841</span><span id="line-841">  public void testIntInclusiveRangeWithRangePredicate() throws QueryBuildingException {</span>
<span class="source-line-no">842</span><span id="line-842"></span>
<span class="source-line-no">843</span><span id="line-843">    RangeValue rangeValue = new RangeValue("1990", null, "2011", null);</span>
<span class="source-line-no">844</span><span id="line-844">    Predicate p = new RangePredicate(OccurrenceSearchParameter.YEAR, rangeValue);</span>
<span class="source-line-no">845</span><span id="line-845">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">846</span><span id="line-846">    assertEquals(</span>
<span class="source-line-no">847</span><span id="line-847">        String.format(</span>
<span class="source-line-no">848</span><span id="line-848">            "((year &gt;= %1$s) AND (year &lt;= %2$s))",</span>
<span class="source-line-no">849</span><span id="line-849">            Integer.parseInt(rangeValue.getGte()), Integer.parseInt(rangeValue.getLte())),</span>
<span class="source-line-no">850</span><span id="line-850">        query);</span>
<span class="source-line-no">851</span><span id="line-851">  }</span>
<span class="source-line-no">852</span><span id="line-852"></span>
<span class="source-line-no">853</span><span id="line-853">  @Test</span>
<span class="source-line-no">854</span><span id="line-854">  public void testIntExclusiveRangeWithRangePredicate() throws QueryBuildingException {</span>
<span class="source-line-no">855</span><span id="line-855"></span>
<span class="source-line-no">856</span><span id="line-856">    RangeValue rangeValue = new RangeValue(null, "1990", null, "2011");</span>
<span class="source-line-no">857</span><span id="line-857">    Predicate p = new RangePredicate(OccurrenceSearchParameter.YEAR, rangeValue);</span>
<span class="source-line-no">858</span><span id="line-858">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">859</span><span id="line-859">    assertEquals(</span>
<span class="source-line-no">860</span><span id="line-860">        String.format(</span>
<span class="source-line-no">861</span><span id="line-861">            "((year &gt; %1$s) AND (year &lt; %2$s))",</span>
<span class="source-line-no">862</span><span id="line-862">            Integer.parseInt(rangeValue.getGt()), Integer.parseInt(rangeValue.getLt())),</span>
<span class="source-line-no">863</span><span id="line-863">        query);</span>
<span class="source-line-no">864</span><span id="line-864">  }</span>
<span class="source-line-no">865</span><span id="line-865"></span>
<span class="source-line-no">866</span><span id="line-866">  @Test</span>
<span class="source-line-no">867</span><span id="line-867">  public void testInclusiveExclusiveRangeWithRangePredicate() throws QueryBuildingException {</span>
<span class="source-line-no">868</span><span id="line-868"></span>
<span class="source-line-no">869</span><span id="line-869">    RangeValue rangeValue = new RangeValue("1990", null, null, "2011");</span>
<span class="source-line-no">870</span><span id="line-870">    Predicate p = new RangePredicate(OccurrenceSearchParameter.YEAR, rangeValue);</span>
<span class="source-line-no">871</span><span id="line-871">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">872</span><span id="line-872">    assertEquals(</span>
<span class="source-line-no">873</span><span id="line-873">        String.format(</span>
<span class="source-line-no">874</span><span id="line-874">            "((year &gt;= %1$s) AND (year &lt; %2$s))",</span>
<span class="source-line-no">875</span><span id="line-875">            Integer.parseInt(rangeValue.getGte()), Integer.parseInt(rangeValue.getLt())),</span>
<span class="source-line-no">876</span><span id="line-876">        query);</span>
<span class="source-line-no">877</span><span id="line-877">  }</span>
<span class="source-line-no">878</span><span id="line-878"></span>
<span class="source-line-no">879</span><span id="line-879">  @Test</span>
<span class="source-line-no">880</span><span id="line-880">  public void testExclusiveInclusiveRangeWithRangePredicate() throws QueryBuildingException {</span>
<span class="source-line-no">881</span><span id="line-881"></span>
<span class="source-line-no">882</span><span id="line-882">    RangeValue rangeValue = new RangeValue(null, "1990", "2011", null);</span>
<span class="source-line-no">883</span><span id="line-883">    Predicate p = new RangePredicate(OccurrenceSearchParameter.YEAR, rangeValue);</span>
<span class="source-line-no">884</span><span id="line-884">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">885</span><span id="line-885">    assertEquals(</span>
<span class="source-line-no">886</span><span id="line-886">        String.format(</span>
<span class="source-line-no">887</span><span id="line-887">            "((year &gt; %1$s) AND (year &lt;= %2$s))",</span>
<span class="source-line-no">888</span><span id="line-888">            Integer.parseInt(rangeValue.getGt()), Integer.parseInt(rangeValue.getLte())),</span>
<span class="source-line-no">889</span><span id="line-889">        query);</span>
<span class="source-line-no">890</span><span id="line-890">  }</span>
<span class="source-line-no">891</span><span id="line-891"></span>
<span class="source-line-no">892</span><span id="line-892">  @Test</span>
<span class="source-line-no">893</span><span id="line-893">  public void testDoubleRanges() throws QueryBuildingException {</span>
<span class="source-line-no">894</span><span id="line-894">    testDoubleRange("-200,600.2");</span>
<span class="source-line-no">895</span><span id="line-895">    testDoubleRange("*,300.3");</span>
<span class="source-line-no">896</span><span id="line-896">    testDoubleRange("-23.8,*");</span>
<span class="source-line-no">897</span><span id="line-897">  }</span>
<span class="source-line-no">898</span><span id="line-898"></span>
<span class="source-line-no">899</span><span id="line-899">  /** Reusable method to test number ranges. */</span>
<span class="source-line-no">900</span><span id="line-900">  private void testDoubleRange(String value) throws QueryBuildingException {</span>
<span class="source-line-no">901</span><span id="line-901">    Range&lt;Double&gt; range = SearchTypeValidator.parseDecimalRange(value);</span>
<span class="source-line-no">902</span><span id="line-902"></span>
<span class="source-line-no">903</span><span id="line-903">    Predicate p = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.ELEVATION, value, false);</span>
<span class="source-line-no">904</span><span id="line-904">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">905</span><span id="line-905"></span>
<span class="source-line-no">906</span><span id="line-906">    if (!range.hasUpperBound()) {</span>
<span class="source-line-no">907</span><span id="line-907">      assertEquals(String.format("elevation &gt;= %s", range.lowerEndpoint().doubleValue()), query);</span>
<span class="source-line-no">908</span><span id="line-908">    } else if (!range.hasLowerBound()) {</span>
<span class="source-line-no">909</span><span id="line-909">      assertEquals(String.format("elevation &lt;= %s", range.upperEndpoint().doubleValue()), query);</span>
<span class="source-line-no">910</span><span id="line-910">    } else {</span>
<span class="source-line-no">911</span><span id="line-911">      assertEquals(</span>
<span class="source-line-no">912</span><span id="line-912">          String.format(</span>
<span class="source-line-no">913</span><span id="line-913">              "((elevation &gt;= %s) AND (elevation &lt;= %s))",</span>
<span class="source-line-no">914</span><span id="line-914">              range.lowerEndpoint().doubleValue(), range.upperEndpoint().doubleValue()),</span>
<span class="source-line-no">915</span><span id="line-915">          query);</span>
<span class="source-line-no">916</span><span id="line-916">    }</span>
<span class="source-line-no">917</span><span id="line-917">  }</span>
<span class="source-line-no">918</span><span id="line-918"></span>
<span class="source-line-no">919</span><span id="line-919">  @Test</span>
<span class="source-line-no">920</span><span id="line-920">  public void testIntegerRanges() throws QueryBuildingException {</span>
<span class="source-line-no">921</span><span id="line-921">    testIntegerRange("1950,1960");</span>
<span class="source-line-no">922</span><span id="line-922">    testIntegerRange("*,2000");</span>
<span class="source-line-no">923</span><span id="line-923">    testIntegerRange("2000,*");</span>
<span class="source-line-no">924</span><span id="line-924">  }</span>
<span class="source-line-no">925</span><span id="line-925"></span>
<span class="source-line-no">926</span><span id="line-926">  /** Reusable method to test number ranges. */</span>
<span class="source-line-no">927</span><span id="line-927">  private void testIntegerRange(String value) throws QueryBuildingException {</span>
<span class="source-line-no">928</span><span id="line-928">    Range&lt;Integer&gt; range = SearchTypeValidator.parseIntegerRange(value);</span>
<span class="source-line-no">929</span><span id="line-929"></span>
<span class="source-line-no">930</span><span id="line-930">    Predicate p = new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.YEAR, value, false);</span>
<span class="source-line-no">931</span><span id="line-931">    String query = visitor.buildQuery(p);</span>
<span class="source-line-no">932</span><span id="line-932"></span>
<span class="source-line-no">933</span><span id="line-933">    if (!range.hasUpperBound()) {</span>
<span class="source-line-no">934</span><span id="line-934">      assertEquals(String.format("year &gt;= %s", range.lowerEndpoint().intValue()), query);</span>
<span class="source-line-no">935</span><span id="line-935">    } else if (!range.hasLowerBound()) {</span>
<span class="source-line-no">936</span><span id="line-936">      assertEquals(String.format("year &lt;= %s", range.upperEndpoint().intValue()), query);</span>
<span class="source-line-no">937</span><span id="line-937">    } else {</span>
<span class="source-line-no">938</span><span id="line-938">      assertEquals(</span>
<span class="source-line-no">939</span><span id="line-939">          String.format(</span>
<span class="source-line-no">940</span><span id="line-940">              "((year &gt;= %s) AND (year &lt;= %s))",</span>
<span class="source-line-no">941</span><span id="line-941">              range.lowerEndpoint().intValue(), range.upperEndpoint().intValue()),</span>
<span class="source-line-no">942</span><span id="line-942">          query);</span>
<span class="source-line-no">943</span><span id="line-943">    }</span>
<span class="source-line-no">944</span><span id="line-944">  }</span>
<span class="source-line-no">945</span><span id="line-945"></span>
<span class="source-line-no">946</span><span id="line-946">  @Test</span>
<span class="source-line-no">947</span><span id="line-947">  public void testIssues() throws QueryBuildingException {</span>
<span class="source-line-no">948</span><span id="line-948">    // EqualsPredicate</span>
<span class="source-line-no">949</span><span id="line-949">    String query =</span>
<span class="source-line-no">950</span><span id="line-950">        visitor.buildQuery(</span>
<span class="source-line-no">951</span><span id="line-951">            new EqualsPredicate&lt;&gt;(</span>
<span class="source-line-no">952</span><span id="line-952">                OccurrenceSearchParameter.ISSUE, "TAXON_MATCH_HIGHERRANK", false));</span>
<span class="source-line-no">953</span><span id="line-953">    assertEquals("stringArrayContains(issue,'TAXON_MATCH_HIGHERRANK',true)", query);</span>
<span class="source-line-no">954</span><span id="line-954"></span>
<span class="source-line-no">955</span><span id="line-955">    // InPredicate</span>
<span class="source-line-no">956</span><span id="line-956">    query =</span>
<span class="source-line-no">957</span><span id="line-957">        visitor.buildQuery(</span>
<span class="source-line-no">958</span><span id="line-958">            new InPredicate&lt;&gt;(</span>
<span class="source-line-no">959</span><span id="line-959">                OccurrenceSearchParameter.ISSUE,</span>
<span class="source-line-no">960</span><span id="line-960">                Lists.newArrayList("TAXON_MATCH_HIGHERRANK", "TAXON_MATCH_NONE"),</span>
<span class="source-line-no">961</span><span id="line-961">                false));</span>
<span class="source-line-no">962</span><span id="line-962">    assertEquals(</span>
<span class="source-line-no">963</span><span id="line-963">        "(stringArrayContains(issue,'TAXON_MATCH_HIGHERRANK',true) OR stringArrayContains(issue,'TAXON_MATCH_NONE',true))",</span>
<span class="source-line-no">964</span><span id="line-964">        query);</span>
<span class="source-line-no">965</span><span id="line-965"></span>
<span class="source-line-no">966</span><span id="line-966">    // LikePredicate</span>
<span class="source-line-no">967</span><span id="line-967">    try {</span>
<span class="source-line-no">968</span><span id="line-968">      new LikePredicate&lt;&gt;(OccurrenceSearchParameter.ISSUE, "TAXON_MATCH_HIGHERRANK", false);</span>
<span class="source-line-no">969</span><span id="line-969">      fail();</span>
<span class="source-line-no">970</span><span id="line-970">    } catch (IllegalArgumentException e) {</span>
<span class="source-line-no">971</span><span id="line-971">    }</span>
<span class="source-line-no">972</span><span id="line-972"></span>
<span class="source-line-no">973</span><span id="line-973">    // Not</span>
<span class="source-line-no">974</span><span id="line-974">    query =</span>
<span class="source-line-no">975</span><span id="line-975">        visitor.buildQuery(</span>
<span class="source-line-no">976</span><span id="line-976">            new NotPredicate(</span>
<span class="source-line-no">977</span><span id="line-977">                new EqualsPredicate&lt;&gt;(</span>
<span class="source-line-no">978</span><span id="line-978">                    OccurrenceSearchParameter.ISSUE, "TAXON_MATCH_HIGHERRANK", false)));</span>
<span class="source-line-no">979</span><span id="line-979">    assertEquals("NOT stringArrayContains(issue,'TAXON_MATCH_HIGHERRANK',true)", query);</span>
<span class="source-line-no">980</span><span id="line-980"></span>
<span class="source-line-no">981</span><span id="line-981">    // Not disjunction</span>
<span class="source-line-no">982</span><span id="line-982">    query =</span>
<span class="source-line-no">983</span><span id="line-983">        visitor.buildQuery(</span>
<span class="source-line-no">984</span><span id="line-984">            new NotPredicate(</span>
<span class="source-line-no">985</span><span id="line-985">                new DisjunctionPredicate(</span>
<span class="source-line-no">986</span><span id="line-986">                    Lists.newArrayList(</span>
<span class="source-line-no">987</span><span id="line-987">                        new EqualsPredicate&lt;&gt;(</span>
<span class="source-line-no">988</span><span id="line-988">                            OccurrenceSearchParameter.ISSUE, "COORDINATE_INVALID", false),</span>
<span class="source-line-no">989</span><span id="line-989">                        new EqualsPredicate&lt;&gt;(</span>
<span class="source-line-no">990</span><span id="line-990">                            OccurrenceSearchParameter.ISSUE, "COORDINATE_OUT_OF_RANGE", false),</span>
<span class="source-line-no">991</span><span id="line-991">                        new EqualsPredicate&lt;&gt;(</span>
<span class="source-line-no">992</span><span id="line-992">                            OccurrenceSearchParameter.ISSUE, "ZERO_COORDINATE", false),</span>
<span class="source-line-no">993</span><span id="line-993">                        new EqualsPredicate&lt;&gt;(</span>
<span class="source-line-no">994</span><span id="line-994">                            OccurrenceSearchParameter.ISSUE, "RECORDED_DATE_INVALID", false)))));</span>
<span class="source-line-no">995</span><span id="line-995">    assertEquals(</span>
<span class="source-line-no">996</span><span id="line-996">        "NOT (stringArrayContains(issue,'COORDINATE_INVALID',true) OR stringArrayContains(issue,'COORDINATE_OUT_OF_RANGE',true) OR stringArrayContains(issue,'ZERO_COORDINATE',true) OR stringArrayContains(issue,'RECORDED_DATE_INVALID',true))",</span>
<span class="source-line-no">997</span><span id="line-997">        query);</span>
<span class="source-line-no">998</span><span id="line-998"></span>
<span class="source-line-no">999</span><span id="line-999">    // IsNotNull</span>
<span class="source-line-no">1000</span><span id="line-1000">    query = visitor.buildQuery(new IsNotNullPredicate&lt;&gt;(OccurrenceSearchParameter.ISSUE));</span>
<span class="source-line-no">1001</span><span id="line-1001">    assertEquals("(issue IS NOT NULL AND size(issue) &gt; 0)", query);</span>
<span class="source-line-no">1002</span><span id="line-1002">  }</span>
<span class="source-line-no">1003</span><span id="line-1003"></span>
<span class="source-line-no">1004</span><span id="line-1004">  @Test</span>
<span class="source-line-no">1005</span><span id="line-1005">  public void testAllParamsExist() {</span>
<span class="source-line-no">1006</span><span id="line-1006">    List&lt;Predicate&gt; predicates = Lists.newArrayList();</span>
<span class="source-line-no">1007</span><span id="line-1007">    for (OccurrenceSearchParameter param : OccurrenceSearchParameter.values()) {</span>
<span class="source-line-no">1008</span><span id="line-1008">      String value = "7";</span>
<span class="source-line-no">1009</span><span id="line-1009"></span>
<span class="source-line-no">1010</span><span id="line-1010">      if (OccurrenceSearchParameter.GEOMETRY == param) {</span>
<span class="source-line-no">1011</span><span id="line-1011">        value = "POLYGON ((30 10, 10 20, 20 40, 40 40, 30 10))";</span>
<span class="source-line-no">1012</span><span id="line-1012">        predicates.add(new WithinPredicate(value));</span>
<span class="source-line-no">1013</span><span id="line-1013">      } else if (UUID.class.isAssignableFrom(param.type())) {</span>
<span class="source-line-no">1014</span><span id="line-1014">        value = UUID.randomUUID().toString();</span>
<span class="source-line-no">1015</span><span id="line-1015">      } else if (Boolean.class.isAssignableFrom(param.type())) {</span>
<span class="source-line-no">1016</span><span id="line-1016">        value = "true";</span>
<span class="source-line-no">1017</span><span id="line-1017">      } else if (Country.class.isAssignableFrom(param.type())) {</span>
<span class="source-line-no">1018</span><span id="line-1018">        value = Country.GERMANY.getIso2LetterCode();</span>
<span class="source-line-no">1019</span><span id="line-1019">      } else if (Language.class.isAssignableFrom(param.type())) {</span>
<span class="source-line-no">1020</span><span id="line-1020">        value = Language.GERMAN.getIso2LetterCode();</span>
<span class="source-line-no">1021</span><span id="line-1021">      } else if (Enum.class.isAssignableFrom(param.type())) {</span>
<span class="source-line-no">1022</span><span id="line-1022">        Enum&lt;?&gt;[] values = ((Class&lt;Enum&gt;) param.type()).getEnumConstants();</span>
<span class="source-line-no">1023</span><span id="line-1023">        value = values[0].name();</span>
<span class="source-line-no">1024</span><span id="line-1024">      } else if (Date.class.isAssignableFrom(param.type())) {</span>
<span class="source-line-no">1025</span><span id="line-1025">        value = "2014-01-23";</span>
<span class="source-line-no">1026</span><span id="line-1026">      } else if (IsoDateInterval.class.isAssignableFrom(param.type())) {</span>
<span class="source-line-no">1027</span><span id="line-1027">        value = "2014-01-23,2015-05";</span>
<span class="source-line-no">1028</span><span id="line-1028">      } else if (OccurrenceSearchParameter.GEO_DISTANCE == param) {</span>
<span class="source-line-no">1029</span><span id="line-1029">        predicates.add(new GeoDistancePredicate("10", "20", "10km"));</span>
<span class="source-line-no">1030</span><span id="line-1030">      }</span>
<span class="source-line-no">1031</span><span id="line-1031"></span>
<span class="source-line-no">1032</span><span id="line-1032">      if (OccurrenceSearchParameter.GEOMETRY != param</span>
<span class="source-line-no">1033</span><span id="line-1033">          &amp;&amp; OccurrenceSearchParameter.GEO_DISTANCE != param) {</span>
<span class="source-line-no">1034</span><span id="line-1034">        predicates.add(new EqualsPredicate&lt;&gt;(param, value, false));</span>
<span class="source-line-no">1035</span><span id="line-1035">      }</span>
<span class="source-line-no">1036</span><span id="line-1036">    }</span>
<span class="source-line-no">1037</span><span id="line-1037">    ConjunctionPredicate and = new ConjunctionPredicate(predicates);</span>
<span class="source-line-no">1038</span><span id="line-1038">    try {</span>
<span class="source-line-no">1039</span><span id="line-1039">      visitor.buildQuery(and);</span>
<span class="source-line-no">1040</span><span id="line-1040">    } catch (QueryBuildingException e) {</span>
<span class="source-line-no">1041</span><span id="line-1041">      fail(e);</span>
<span class="source-line-no">1042</span><span id="line-1042">    }</span>
<span class="source-line-no">1043</span><span id="line-1043">  }</span>
<span class="source-line-no">1044</span><span id="line-1044"></span>
<span class="source-line-no">1045</span><span id="line-1045">  @Test</span>
<span class="source-line-no">1046</span><span id="line-1046">  public void testVocabularies() {</span>
<span class="source-line-no">1047</span><span id="line-1047">    Arrays.stream(OccurrenceSearchParameter.values())</span>
<span class="source-line-no">1048</span><span id="line-1048">        .filter(</span>
<span class="source-line-no">1049</span><span id="line-1049">            p -&gt;</span>
<span class="source-line-no">1050</span><span id="line-1050">                Optional.ofNullable(visitor.term(p))</span>
<span class="source-line-no">1051</span><span id="line-1051">                    .map(SQLColumnsUtils::isVocabulary)</span>
<span class="source-line-no">1052</span><span id="line-1052">                    .orElse(false))</span>
<span class="source-line-no">1053</span><span id="line-1053">        .forEach(</span>
<span class="source-line-no">1054</span><span id="line-1054">            param -&gt; {</span>
<span class="source-line-no">1055</span><span id="line-1055">              try {</span>
<span class="source-line-no">1056</span><span id="line-1056">                String hiveQueryField = SQLColumnsUtils.getSQLQueryColumn(visitor.term(param));</span>
<span class="source-line-no">1057</span><span id="line-1057"></span>
<span class="source-line-no">1058</span><span id="line-1058">                // EqualsPredicate</span>
<span class="source-line-no">1059</span><span id="line-1059">                String query = visitor.buildQuery(new EqualsPredicate&lt;&gt;(param, "value_1", false));</span>
<span class="source-line-no">1060</span><span id="line-1060">                assertEquals("stringArrayContains(" + hiveQueryField + ",'value_1',false)", query);</span>
<span class="source-line-no">1061</span><span id="line-1061"></span>
<span class="source-line-no">1062</span><span id="line-1062">                // InPredicate</span>
<span class="source-line-no">1063</span><span id="line-1063">                query =</span>
<span class="source-line-no">1064</span><span id="line-1064">                    visitor.buildQuery(</span>
<span class="source-line-no">1065</span><span id="line-1065">                        new InPredicate&lt;&gt;(param, Lists.newArrayList("value_1", "value_2"), false));</span>
<span class="source-line-no">1066</span><span id="line-1066">                assertEquals(</span>
<span class="source-line-no">1067</span><span id="line-1067">                    "(stringArrayContains("</span>
<span class="source-line-no">1068</span><span id="line-1068">                        + hiveQueryField</span>
<span class="source-line-no">1069</span><span id="line-1069">                        + ",'value_1',false) OR stringArrayContains("</span>
<span class="source-line-no">1070</span><span id="line-1070">                        + hiveQueryField</span>
<span class="source-line-no">1071</span><span id="line-1071">                        + ",'value_2',false))",</span>
<span class="source-line-no">1072</span><span id="line-1072">                    query);</span>
<span class="source-line-no">1073</span><span id="line-1073"></span>
<span class="source-line-no">1074</span><span id="line-1074">                // LikePredicate</span>
<span class="source-line-no">1075</span><span id="line-1075">                query = visitor.buildQuery(new LikePredicate&lt;&gt;(param, "value_*", false));</span>
<span class="source-line-no">1076</span><span id="line-1076">                assertEquals("lower(" + hiveQueryField + ") LIKE lower('value\\_%')", query);</span>
<span class="source-line-no">1077</span><span id="line-1077"></span>
<span class="source-line-no">1078</span><span id="line-1078">                // Not</span>
<span class="source-line-no">1079</span><span id="line-1079">                query =</span>
<span class="source-line-no">1080</span><span id="line-1080">                    visitor.buildQuery(</span>
<span class="source-line-no">1081</span><span id="line-1081">                        new NotPredicate(new EqualsPredicate&lt;&gt;(param, "value_1", false)));</span>
<span class="source-line-no">1082</span><span id="line-1082">                assertEquals(</span>
<span class="source-line-no">1083</span><span id="line-1083">                    "NOT stringArrayContains(" + hiveQueryField + ",'value_1',false)", query);</span>
<span class="source-line-no">1084</span><span id="line-1084"></span>
<span class="source-line-no">1085</span><span id="line-1085">                // IsNotNull</span>
<span class="source-line-no">1086</span><span id="line-1086">                query = visitor.buildQuery(new IsNotNullPredicate&lt;&gt;(param));</span>
<span class="source-line-no">1087</span><span id="line-1087">                assertEquals(</span>
<span class="source-line-no">1088</span><span id="line-1088">                    "(" + hiveQueryField + " IS NOT NULL AND size(" + hiveQueryField + ") &gt; 0)",</span>
<span class="source-line-no">1089</span><span id="line-1089">                    query);</span>
<span class="source-line-no">1090</span><span id="line-1090"></span>
<span class="source-line-no">1091</span><span id="line-1091">                // IsNull</span>
<span class="source-line-no">1092</span><span id="line-1092">                query = visitor.buildQuery(new IsNullPredicate&lt;&gt;(param));</span>
<span class="source-line-no">1093</span><span id="line-1093">                if (visitor.isSQLArray(param)) {</span>
<span class="source-line-no">1094</span><span id="line-1094">                  assertEquals(</span>
<span class="source-line-no">1095</span><span id="line-1095">                      " (" + hiveQueryField + " IS NULL OR size(" + hiveQueryField + ") = 0) ",</span>
<span class="source-line-no">1096</span><span id="line-1096">                      query);</span>
<span class="source-line-no">1097</span><span id="line-1097">                } else {</span>
<span class="source-line-no">1098</span><span id="line-1098">                  assertEquals(hiveQueryField + " IS NULL", query);</span>
<span class="source-line-no">1099</span><span id="line-1099">                }</span>
<span class="source-line-no">1100</span><span id="line-1100"></span>
<span class="source-line-no">1101</span><span id="line-1101">              } catch (QueryBuildingException ex) {</span>
<span class="source-line-no">1102</span><span id="line-1102">                throw new RuntimeException(ex);</span>
<span class="source-line-no">1103</span><span id="line-1103">              }</span>
<span class="source-line-no">1104</span><span id="line-1104">            });</span>
<span class="source-line-no">1105</span><span id="line-1105">  }</span>
<span class="source-line-no">1106</span><span id="line-1106"></span>
<span class="source-line-no">1107</span><span id="line-1107">  @Test</span>
<span class="source-line-no">1108</span><span id="line-1108">  public void testGreaterThanEqualsIncludingNull() {</span>
<span class="source-line-no">1109</span><span id="line-1109">    GreaterThanOrEqualsPredicate&lt;OccurrenceSearchParameter&gt; distanceFromCentroidPredicate =</span>
<span class="source-line-no">1110</span><span id="line-1110">        new GreaterThanOrEqualsPredicate&lt;&gt;(</span>
<span class="source-line-no">1111</span><span id="line-1111">            OccurrenceSearchParameter.DISTANCE_FROM_CENTROID_IN_METERS, "10");</span>
<span class="source-line-no">1112</span><span id="line-1112">    try {</span>
<span class="source-line-no">1113</span><span id="line-1113">      String query = visitor.buildQuery(distanceFromCentroidPredicate);</span>
<span class="source-line-no">1114</span><span id="line-1114">      assertEquals(</span>
<span class="source-line-no">1115</span><span id="line-1115">          "(distancefromcentroidinmeters &gt;= 10 OR distancefromcentroidinmeters IS NULL)", query);</span>
<span class="source-line-no">1116</span><span id="line-1116">    } catch (QueryBuildingException ex) {</span>
<span class="source-line-no">1117</span><span id="line-1117">      fail();</span>
<span class="source-line-no">1118</span><span id="line-1118">    }</span>
<span class="source-line-no">1119</span><span id="line-1119">  }</span>
<span class="source-line-no">1120</span><span id="line-1120"></span>
<span class="source-line-no">1121</span><span id="line-1121">  @Test</span>
<span class="source-line-no">1122</span><span id="line-1122">  public void testGreaterThanIncludingNull() {</span>
<span class="source-line-no">1123</span><span id="line-1123">    GreaterThanPredicate&lt;OccurrenceSearchParameter&gt; distanceFromCentroidPredicate =</span>
<span class="source-line-no">1124</span><span id="line-1124">        new GreaterThanPredicate&lt;&gt;(</span>
<span class="source-line-no">1125</span><span id="line-1125">            OccurrenceSearchParameter.DISTANCE_FROM_CENTROID_IN_METERS, "10");</span>
<span class="source-line-no">1126</span><span id="line-1126">    try {</span>
<span class="source-line-no">1127</span><span id="line-1127">      String query = visitor.buildQuery(distanceFromCentroidPredicate);</span>
<span class="source-line-no">1128</span><span id="line-1128">      assertEquals(</span>
<span class="source-line-no">1129</span><span id="line-1129">          "(distancefromcentroidinmeters &gt; 10 OR distancefromcentroidinmeters IS NULL)", query);</span>
<span class="source-line-no">1130</span><span id="line-1130">    } catch (QueryBuildingException ex) {</span>
<span class="source-line-no">1131</span><span id="line-1131">      fail();</span>
<span class="source-line-no">1132</span><span id="line-1132">    }</span>
<span class="source-line-no">1133</span><span id="line-1133">  }</span>
<span class="source-line-no">1134</span><span id="line-1134"></span>
<span class="source-line-no">1135</span><span id="line-1135">  @Test</span>
<span class="source-line-no">1136</span><span id="line-1136">  public void testDisjunctionGreaterThanEqualsIncludingNull() {</span>
<span class="source-line-no">1137</span><span id="line-1137">    GreaterThanOrEqualsPredicate&lt;OccurrenceSearchParameter&gt; distanceFromCentroidPredicate =</span>
<span class="source-line-no">1138</span><span id="line-1138">        new GreaterThanOrEqualsPredicate&lt;&gt;(</span>
<span class="source-line-no">1139</span><span id="line-1139">            OccurrenceSearchParameter.DISTANCE_FROM_CENTROID_IN_METERS, "10");</span>
<span class="source-line-no">1140</span><span id="line-1140">    EqualsPredicate&lt;OccurrenceSearchParameter&gt; equalsPredicate =</span>
<span class="source-line-no">1141</span><span id="line-1141">        new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.TAXON_KEY, "6", false);</span>
<span class="source-line-no">1142</span><span id="line-1142">    DisjunctionPredicate disjunctionPredicate =</span>
<span class="source-line-no">1143</span><span id="line-1143">        new DisjunctionPredicate(Arrays.asList(equalsPredicate, distanceFromCentroidPredicate));</span>
<span class="source-line-no">1144</span><span id="line-1144">    try {</span>
<span class="source-line-no">1145</span><span id="line-1145">      String query = visitor.buildQuery(disjunctionPredicate);</span>
<span class="source-line-no">1146</span><span id="line-1146">      assertEquals(</span>
<span class="source-line-no">1147</span><span id="line-1147">          "(((taxonkey = 6 OR acceptedtaxonkey = 6 OR kingdomkey = 6 OR phylumkey = 6 OR classkey = 6 OR orderkey = 6 OR familykey = 6 OR genuskey = 6 OR specieskey = 6)) OR ((distancefromcentroidinmeters &gt;= 10 OR distancefromcentroidinmeters IS NULL)))",</span>
<span class="source-line-no">1148</span><span id="line-1148">          query);</span>
<span class="source-line-no">1149</span><span id="line-1149">    } catch (QueryBuildingException ex) {</span>
<span class="source-line-no">1150</span><span id="line-1150">      fail();</span>
<span class="source-line-no">1151</span><span id="line-1151">    }</span>
<span class="source-line-no">1152</span><span id="line-1152">  }</span>
<span class="source-line-no">1153</span><span id="line-1153"></span>
<span class="source-line-no">1154</span><span id="line-1154">  @Test</span>
<span class="source-line-no">1155</span><span id="line-1155">  public void testGeoTimePredicate() throws QueryBuildingException {</span>
<span class="source-line-no">1156</span><span id="line-1156">    Predicate predicate =</span>
<span class="source-line-no">1157</span><span id="line-1157">        new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.GEOLOGICAL_TIME, "12", false);</span>
<span class="source-line-no">1158</span><span id="line-1158">    String query = visitor.buildQuery(predicate);</span>
<span class="source-line-no">1159</span><span id="line-1159">    assertEquals("12 &gt; geologicaltime.gt AND 12 &lt;= geologicaltime.lte", query);</span>
<span class="source-line-no">1160</span><span id="line-1160"></span>
<span class="source-line-no">1161</span><span id="line-1161">    Predicate rangePredicate =</span>
<span class="source-line-no">1162</span><span id="line-1162">        new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.GEOLOGICAL_TIME, "12,15", false);</span>
<span class="source-line-no">1163</span><span id="line-1163">    query = visitor.buildQuery(rangePredicate);</span>
<span class="source-line-no">1164</span><span id="line-1164">    assertEquals("geologicaltime.gt &gt;= 12.0 AND geologicaltime.lte &lt;= 15.0", query);</span>
<span class="source-line-no">1165</span><span id="line-1165"></span>
<span class="source-line-no">1166</span><span id="line-1166">    rangePredicate =</span>
<span class="source-line-no">1167</span><span id="line-1167">        new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.GEOLOGICAL_TIME, "12,*", false);</span>
<span class="source-line-no">1168</span><span id="line-1168">    query = visitor.buildQuery(rangePredicate);</span>
<span class="source-line-no">1169</span><span id="line-1169">    assertEquals("geologicaltime.gt &gt;= 12.0", query);</span>
<span class="source-line-no">1170</span><span id="line-1170"></span>
<span class="source-line-no">1171</span><span id="line-1171">    rangePredicate =</span>
<span class="source-line-no">1172</span><span id="line-1172">        new EqualsPredicate&lt;&gt;(OccurrenceSearchParameter.GEOLOGICAL_TIME, "*,15", false);</span>
<span class="source-line-no">1173</span><span id="line-1173">    query = visitor.buildQuery(rangePredicate);</span>
<span class="source-line-no">1174</span><span id="line-1174">    assertEquals("geologicaltime.lte &lt;= 15.0", query);</span>
<span class="source-line-no">1175</span><span id="line-1175">  }</span>
<span class="source-line-no">1176</span><span id="line-1176">}</span>




























































</pre>
</div>
</main>
</body>
</html>